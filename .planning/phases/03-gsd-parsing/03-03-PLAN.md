---
phase: 03-gsd-parsing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/parsers/directory-parser.js
  - src/main/main.js
  - src/main/preload.js
autonomous: true

must_haves:
  truths:
    - "Directory tree of .planning/ folder is parsed into structured data"
    - "Each file and folder becomes a node with path and type"
    - "IPC channel exposes directory tree to renderer"
  artifacts:
    - path: "src/main/parsers/directory-parser.js"
      provides: "parseDirectory function"
      exports: ["parseDirectory"]
    - path: "src/main/main.js"
      provides: "IPC handler for parse-directory"
      contains: "ipcMain.handle('parse-directory'"
    - path: "src/main/preload.js"
      provides: "parseDirectory API exposed to renderer"
      contains: "parseDirectory"
  key_links:
    - from: "src/main/main.js"
      to: "src/main/parsers/directory-parser.js"
      via: "require and call parseDirectory"
      pattern: "require.*directory-parser"
---

<objective>
Parse the .planning/ directory tree into navigable file/folder nodes.

Purpose: The GSD Viewer should show the actual file structure of .planning/ as navigable nodes. This enables users to see all planning artifacts (ROADMAP.md, STATE.md, phase folders, PLAN.md files, SUMMARY.md files) and their organization.

Output: A parser module that recursively walks .planning/ and returns a tree structure with files and folders. IPC channel to expose this to the renderer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/main/main.js
@src/main/preload.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory parser module</name>
  <files>src/main/parsers/directory-parser.js</files>
  <action>
Create `src/main/parsers/directory-parser.js`.

The parser should:
1. Accept a path to a .planning/ folder
2. Recursively walk the directory using Node.js fs
3. For each item, determine:
   - Type: 'folder' or 'file'
   - File subtype based on name patterns:
     - '*-PLAN.md' -> 'plan-file'
     - '*-SUMMARY.md' -> 'summary-file'
     - 'ROADMAP.md' -> 'roadmap-file'
     - 'REQUIREMENTS.md' -> 'requirements-file'
     - 'STATE.md' -> 'state-file'
     - 'PROJECT.md' -> 'project-file'
     - Other .md -> 'doc-file'
     - Other -> 'file'
4. Return flat list (easier for graph rendering) with parent references:
```javascript
{
  items: [
    {
      id: 'file-.planning',
      name: '.planning',
      path: '.planning',
      type: 'folder',
      subtype: 'root-folder',
      parentId: null
    },
    {
      id: 'file-.planning/ROADMAP.md',
      name: 'ROADMAP.md',
      path: '.planning/ROADMAP.md',
      type: 'file',
      subtype: 'roadmap-file',
      parentId: 'file-.planning'
    },
    {
      id: 'file-.planning/phases',
      name: 'phases',
      path: '.planning/phases',
      type: 'folder',
      subtype: 'phases-folder',
      parentId: 'file-.planning'
    },
    {
      id: 'file-.planning/phases/01-foundation',
      name: '01-foundation',
      path: '.planning/phases/01-foundation',
      type: 'folder',
      subtype: 'phase-folder',
      parentId: 'file-.planning/phases'
    },
    ...
  ]
}
```

Use `fs.readdirSync` with `{ withFileTypes: true }` for efficiency.
Skip hidden files (starting with `.`) except the root .planning folder.

Export: `module.exports = { parseDirectory };`
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
node -e "const {parseDirectory} = require('./src/main/parsers/directory-parser'); const result = parseDirectory('.planning'); console.log('Items:', result.items.length); console.log(result.items.slice(0,5).map(i => i.path));"
```
Should output item count and first few paths showing hierarchy.
  </verify>
  <done>
parseDirectory('.planning') returns object with items array containing all files and folders, each with id, name, path, type, subtype, and parentId linking to parent folder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handler and preload API</name>
  <files>src/main/main.js, src/main/preload.js</files>
  <action>
In `src/main/main.js`:
1. Add require: `const { parseDirectory } = require('./parsers/directory-parser');`
2. Add IPC handler inside `app.whenReady()`:
```javascript
ipcMain.handle('parse-directory', async (event, planningPath) => {
  try {
    return parseDirectory(planningPath);
  } catch (error) {
    console.error('Error parsing directory:', error);
    return { error: error.message, items: [] };
  }
});
```

In `src/main/preload.js`:
Update the exposed API (add to existing object):
```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  selectFolder: () => ipcRenderer.invoke('select-folder'),
  parseRoadmap: (planningPath) => ipcRenderer.invoke('parse-roadmap', planningPath),
  parseRequirements: (planningPath) => ipcRenderer.invoke('parse-requirements', planningPath),
  parseDirectory: (planningPath) => ipcRenderer.invoke('parse-directory', planningPath)
});
```

Note: Include all three parser APIs. If running in parallel with 03-01/03-02, coordinate the final preload.js state.
  </action>
  <verify>
```bash
npm start
# In DevTools console:
# const result = await window.electronAPI.parseDirectory('/home/rafreid/AFLUXSYS/products/GSDv/.planning');
# console.log(result.items.length);
# console.log(result.items.filter(i => i.subtype === 'plan-file').map(i => i.name));
```
Should list all PLAN.md files found.
  </verify>
  <done>
IPC channel 'parse-directory' registered, preload exposes `electronAPI.parseDirectory()`, calling it returns directory tree with files and folders.
  </done>
</task>

</tasks>

<verification>
1. Parser module exists at src/main/parsers/directory-parser.js
2. Running parser outputs valid JSON with items array
3. Files have appropriate subtypes (plan-file, roadmap-file, etc.)
4. Folders link via parentId
5. IPC handler registered in main.js
6. API exposed in preload.js
7. Can call from renderer DevTools and get real data
</verification>

<success_criteria>
- parseDirectory function recursively walks .planning/ folder
- Each item has: id, name, path, type, subtype, parentId
- Subtypes correctly identify GSD artifact types
- Parent-child relationships preserved via parentId
- IPC channel works end-to-end
- Error handling returns empty items array on failure
</success_criteria>

<output>
After completion, create `.planning/phases/03-gsd-parsing/03-03-SUMMARY.md`
</output>

---
phase: 14-diff-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/index.html
  - src/renderer/renderer.js
autonomous: true

must_haves:
  truths:
    - "Diff section shows file content with basic syntax highlighting (keywords, strings, comments colored)"
    - "User can toggle between Git diff (vs HEAD) and Session diff (vs last viewed)"
    - "Line numbers appear in left gutter of diff content"
    - "Clicking a line number scrolls diff view to that line"
    - "Added lines display with green background, removed lines with red background"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Diff mode toggle logic, session content storage, enhanced renderDiffView with line numbers"
      contains: "sessionFileSnapshots"
    - path: "src/renderer/index.html"
      provides: "Diff mode toggle UI, line number CSS, syntax highlighting CSS"
      contains: "diff-mode-toggle"
  key_links:
    - from: "src/renderer/renderer.js"
      to: "#section-diff .section-content"
      via: "populateInspectorDiff function"
      pattern: "populateInspectorDiff"
    - from: "diff mode toggle button"
      to: "renderDiffView"
      via: "click handler toggles diffMode and re-renders"
      pattern: "toggleDiffMode|diffMode"
---

<objective>
Populate the modal's Diff section with syntax-highlighted file content, git/session diff toggle, and line numbers with click-to-jump navigation.

Purpose: Enable users to deeply inspect file changes within the modal, comparing against git HEAD or their last viewed state.
Output: Functional diff editor section in file inspector modal with all DFE requirements met (DFE-01 through DFE-05).
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-modal-foundation/13-01-SUMMARY.md
@src/renderer/index.html
@src/renderer/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diff mode toggle and session snapshot storage</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add diff mode toggle UI to #section-diff .section-header (after section-title):
   - Add toggle buttons or segmented control: "Git Diff" | "Session Diff"
   - Use classes: .diff-mode-toggle with .mode-btn.active for selected mode
   - Default to Git Diff mode active
   - Style toggle: compact inline buttons matching app theme (teal accent)

2. In renderer.js, add session snapshot storage:
   - Create `const sessionFileSnapshots = new Map()` at module level
   - Map stores: filePath -> { content: string, timestamp: number }
   - When modal opens (in openFileInspector), check if file not in snapshots:
     - If not present, read file content via electronAPI.readFileContent and store as initial snapshot
   - This gives us "last viewed" baseline for session diff

3. Add diff mode state:
   - Create `let inspectorDiffMode = 'git'` at module level (values: 'git' or 'session')
   - Add click handler for mode toggle buttons that:
     - Updates inspectorDiffMode
     - Updates button active states
     - Calls populateInspectorDiff() to re-render with new mode

4. Create populateInspectorDiff() function skeleton:
   - Gets current inspectorNode
   - Reads #section-diff .section-content element
   - Will render diff based on inspectorDiffMode (full implementation in Task 2)
   - For now, just show "Loading..." placeholder

CSS additions to index.html:
```css
.diff-mode-toggle {
  display: flex;
  gap: 4px;
  margin-left: auto;
}
.mode-btn {
  padding: 4px 10px;
  border: 1px solid #555;
  background: transparent;
  color: #888;
  font-size: 11px;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.2s;
}
.mode-btn:hover {
  border-color: #4ECDC4;
  color: #ccc;
}
.mode-btn.active {
  background: #4ECDC4;
  border-color: #4ECDC4;
  color: #1a1a2e;
}
```
  </action>
  <verify>
- App starts without errors: `npm start`
- Double-click file node opens modal
- Diff section header shows "Git Diff" and "Session Diff" toggle buttons
- Git Diff button is active (highlighted) by default
- Clicking Session Diff button switches active state
- Console shows no errors
  </verify>
  <done>
- Diff mode toggle UI visible in modal diff section header
- Toggle buttons switch active state on click
- sessionFileSnapshots Map created and populated on modal open
- inspectorDiffMode state variable tracks current mode
- populateInspectorDiff function exists (even if basic)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement enhanced diff rendering with line numbers and syntax highlighting</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add line number and syntax highlighting CSS:

```css
/* Line numbers in diff view */
.diff-line-container {
  display: flex;
}
.diff-line-number {
  min-width: 40px;
  padding: 2px 8px;
  text-align: right;
  color: #555;
  background: rgba(0,0,0,0.2);
  border-right: 1px solid #333;
  user-select: none;
  cursor: pointer;
  font-size: 11px;
}
.diff-line-number:hover {
  color: #4ECDC4;
  background: rgba(78, 205, 196, 0.1);
}
.diff-line-content {
  flex: 1;
  padding: 2px 8px;
  white-space: pre-wrap;
  word-break: break-all;
}

/* Basic syntax highlighting */
.syntax-keyword { color: #C678DD; }
.syntax-string { color: #98C379; }
.syntax-comment { color: #5C6370; font-style: italic; }
.syntax-number { color: #D19A66; }
.syntax-function { color: #61AFEF; }
```

2. In renderer.js, enhance renderDiffView() to include line numbers:
   - Modify existing renderDiffView to wrap each line in .diff-line-container
   - Add .diff-line-number span with line number
   - Add .diff-line-content span with actual content
   - Line numbers should be sequential (1, 2, 3...) for context lines
   - For diff hunks, show original line numbers from @@ headers if available, else sequential

3. Add click-to-jump functionality:
   - Add event delegation listener on .diff-content for .diff-line-number clicks
   - On click, scroll that line to top of diff container view
   - Use scrollIntoView({ behavior: 'smooth', block: 'start' })

4. Add basic syntax highlighting function applySyntaxHighlighting(line, filename):
   - Detect file type from filename extension
   - For .js/.ts files: highlight keywords (const, let, function, return, if, else, etc.), strings, comments
   - For .md files: highlight headers (#), bold (**), links
   - For .json files: highlight keys and string values
   - For other files: minimal/no highlighting (just escape HTML)
   - Apply via regex replacement after escapeHtml
   - Return HTML string with span classes

5. Implement full populateInspectorDiff():
   - If mode is 'git': use existing getGitDiff IPC call
   - If mode is 'session':
     - Read current file content via electronAPI.readFileContent
     - Get stored snapshot from sessionFileSnapshots
     - If no snapshot or same content: show "No changes since last viewed"
     - Otherwise: compute simple line-by-line diff (added/removed lines)
     - Use simple diff algorithm: split by lines, mark removed lines from old, added lines from new
   - Call enhanced renderDiffView with result
   - Apply syntax highlighting to diff lines

6. Wire up openFileInspector to call populateInspectorDiff() after modal opens:
   - At end of openFileInspector(), call populateInspectorDiff()
   - Update snapshot AFTER rendering (so user sees diff from last view, then updates snapshot)

7. Update session snapshot after viewing:
   - After populateInspectorDiff completes, update sessionFileSnapshots with current content
   - This makes "last viewed" track each modal open

Simple session diff algorithm (no external library):
```javascript
function computeSessionDiff(oldContent, newContent) {
  const oldLines = oldContent.split('\n');
  const newLines = newContent.split('\n');
  const result = [];

  // Simple line-by-line comparison (not optimal but sufficient)
  let i = 0, j = 0;
  while (i < oldLines.length || j < newLines.length) {
    if (i >= oldLines.length) {
      result.push({ type: 'added', line: newLines[j] });
      j++;
    } else if (j >= newLines.length) {
      result.push({ type: 'removed', line: oldLines[i] });
      i++;
    } else if (oldLines[i] === newLines[j]) {
      result.push({ type: 'context', line: oldLines[i] });
      i++; j++;
    } else {
      // Changed line - show as removed then added
      result.push({ type: 'removed', line: oldLines[i] });
      result.push({ type: 'added', line: newLines[j] });
      i++; j++;
    }
  }
  return result;
}
```
  </action>
  <verify>
- App starts without errors: `npm start`
- Double-click file opens modal with populated diff section
- Diff shows line numbers in left gutter
- Clicking a line number scrolls to that line
- Added lines have green background (from existing CSS)
- Removed lines have red background (from existing CSS)
- Toggle to "Session Diff" shows "No changes since last viewed" initially
- Make a file change externally, re-open modal, Session Diff shows the change
- JavaScript files show colored keywords (purple), strings (green), comments (gray)
- Markdown files show colored headers
  </verify>
  <done>
- Line numbers visible in diff view gutter
- Line number click scrolls diff view to that line
- Git Diff mode shows git diff vs HEAD (existing behavior enhanced)
- Session Diff mode shows diff vs last viewed content
- Basic syntax highlighting for JS/TS/MD/JSON files
- Session snapshots update after each modal view
  </done>
</task>

</tasks>

<verification>
1. Start app: `npm start`
2. Open a project folder
3. Double-click a .js or .ts file in the graph
4. Verify diff section shows:
   - Mode toggle (Git Diff / Session Diff) in section header
   - Line numbers in left gutter
   - Syntax-highlighted content (keywords in purple, strings in green)
   - Green/red backgrounds for added/removed lines
5. Click "Session Diff" button - should show "No changes since last viewed"
6. Close modal, edit file externally, re-open modal
7. Click "Session Diff" - should show the changes made
8. Click a line number - diff view should scroll to that line
9. Test with .md file - headers should be highlighted
10. Test with .json file - keys should be highlighted
</verification>

<success_criteria>
- DFE-01: Diff section shows file content with syntax highlighting (keywords, strings, comments colored)
- DFE-02: Diff section is collapsible (inherited from Phase 13)
- DFE-03: User can toggle between Git Diff and Session Diff modes
- DFE-04: Line numbers displayed with click-to-jump functionality
- DFE-05: Added lines green, removed lines red (enhanced from existing)
- All 5 DFE requirements verified and working
</success_criteria>

<output>
After completion, create `.planning/phases/14-diff-editor/14-01-SUMMARY.md`
</output>

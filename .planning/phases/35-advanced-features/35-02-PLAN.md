---
phase: 35-advanced-features
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - src/renderer/diagram-renderer.js
  - src/renderer/gsd-pipeline-parser.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User sees parallel agent lanes in Discuss and Execute stages showing concurrent work"
    - "Agent lanes show icons or labels indicating agent type (researcher, executor)"
    - "User sees atomic commit markers (checkmarks) on completed tasks in Execute stage"
    - "Commit markers link to task completion status from SUMMARY files"
  artifacts:
    - path: "src/renderer/gsd-pipeline-parser.js"
      provides: "Parallel agent detection and commit marker extraction"
      contains: "detectParallelAgents"
    - path: "src/renderer/diagram-renderer.js"
      provides: "Agent lane and commit marker rendering"
      contains: "renderAgentLanes"
    - path: "src/renderer/index.html"
      provides: "Agent lane and commit marker CSS styles"
      contains: "agent-lane"
  key_links:
    - from: "gsd-pipeline-parser.js"
      to: "diagram-renderer.js"
      via: "stage.parallelAgents and artifact.commits properties"
      pattern: "parallelAgents|commits"
    - from: "diagram-renderer.js"
      to: "SVG rendering"
      via: "D3.js elements for lanes and markers"
      pattern: "agent-lane|commit-marker"
---

<objective>
Add parallel agent lane visualization and atomic commit markers to the diagram view, showing concurrent work during multi-agent stages and completed task indicators.

Purpose: Demonstrate another key GSD principle - parallel execution and atomic commits. Users can see when multiple agents worked concurrently and which tasks completed.

Output: Agent lanes for parallel work stages + commit markers on executed artifacts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-advanced-features/35-01-PLAN.md
@src/renderer/diagram-renderer.js
@src/renderer/gsd-pipeline-parser.js
@src/renderer/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parse parallel agent activity and commit markers</name>
  <files>src/renderer/gsd-pipeline-parser.js</files>
  <action>
Extend the pipeline parser to detect parallel agent work and extract commit information:

1. Create `detectParallelAgents(phaseDir, stageId)` function:
   - For 'discuss' stage: Check if both CONTEXT.md and RESEARCH.md exist in same phase
     - If both exist, return: `[{ type: 'researcher', artifact: 'RESEARCH.md' }, { type: 'discusser', artifact: 'CONTEXT.md' }]`
   - For 'execute' stage: Check PLAN.md frontmatter for `wave` assignments
     - Plans with same wave number indicate parallel execution
     - Return array of agent objects: `[{ type: 'executor', wave: N, plans: ['01-PLAN.md', '02-PLAN.md'] }]`
   - For other stages: Return empty array (sequential work)

2. Create `extractCommitMarkers(summaryPath)` function:
   - Read SUMMARY.md file
   - Look for "## Files Changed" or "### Created" / "### Modified" sections
   - Extract list of committed file changes
   - Also look for git commit references in the content (patterns like `feat(...): `, `fix(...): `)
   - Return array: `[{ type: 'commit', message: 'feat: added X', files: ['path/to/file.js'] }]`

3. Update `collectArtifacts()` to call `extractCommitMarkers()` for SUMMARY files:
   ```javascript
   if (file.includes('SUMMARY')) {
     artifacts.push({
       name: file,
       path: artifactPath,
       status,
       commits: extractCommitMarkers(artifactPath)  // NEW
     });
   }
   ```

4. Update `buildStagesSummary()` to include parallel agent info:
   - Call `detectParallelAgents()` for each stage
   - Add `parallelAgents` property to stage object

Keep parsing lightweight using regex (no external YAML library).
  </action>
  <verify>
Open DevTools console, check that `parsePipelineState()` returns:
- Stages with `parallelAgents` array (especially discuss and execute stages)
- SUMMARY artifacts with `commits` array containing commit info
  </verify>
  <done>
Parser returns parallelAgents for discuss/execute stages and commits array for SUMMARY artifacts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Render parallel agent lanes in diagram</name>
  <files>src/renderer/diagram-renderer.js, src/renderer/index.html</files>
  <action>
Add visual lanes for parallel agent work:

1. In diagram-renderer.js, create `renderAgentLanes(stageGroup, parallelAgents)` function:
   - Only render if parallelAgents.length > 1 (no lanes for sequential work)
   - Position lanes at bottom of stage container (above artifacts, below context bar)
   - For each agent, render:
     - Small icon or badge indicating agent type (use emoji or simple SVG icon)
       - Researcher: magnifying glass icon or "R" badge
       - Executor: gear icon or "E" badge
       - Discusser: speech bubble icon or "D" badge
     - Label with agent type name
     - Subtle connecting line showing parallel execution
   - Lane height: 24px per agent, max 2 lanes (48px total)

2. Color scheme for agent types:
   - Researcher: Purple (#9B59B6)
   - Executor: Orange (#F39C12)
   - Discusser: Blue (#3498DB)

3. In `renderStages()`, after context bar, call agent lanes:
   ```javascript
   if (d.stage.parallelAgents && d.stage.parallelAgents.length > 1) {
     renderAgentLanes(d3.select(this), d.stage.parallelAgents);
   }
   ```

4. Adjust artifact Y offset to account for agent lanes:
   - Add `AGENT_LANE_HEIGHT = 24` constant
   - In renderArtifacts(), check if stage has parallel agents and adjust contentY

5. Add CSS styles in index.html:
   ```css
   .agent-lane {
     opacity: 0.9;
   }
   .agent-lane-badge {
     font-size: 10px;
     font-weight: bold;
   }
   .agent-lane-label {
     fill: #aaa;
     font-size: 9px;
   }
   .parallel-indicator {
     stroke: #4ECDC4;
     stroke-width: 1;
     stroke-dasharray: 3,3;
   }
   ```
  </action>
  <verify>
Run `npm start`, open diagram view on a project with multiple plans in same wave or both CONTEXT+RESEARCH in same phase. Verify agent lanes appear with badges/icons.
  </verify>
  <done>
Agent lanes visible in discuss/execute stages when parallel work detected. Badges show agent types with appropriate colors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Render atomic commit markers on SUMMARY artifacts</name>
  <files>src/renderer/diagram-renderer.js, src/renderer/index.html</files>
  <action>
Add commit markers to SUMMARY artifacts showing completed tasks:

1. In diagram-renderer.js, update `renderArtifacts()` to add commit markers:
   - For artifacts with `commits` array, add small checkmark indicators
   - Position markers to the right of artifact name, before status symbol
   - Each commit gets a small checkmark icon (use "check" unicode character or SVG path)
   - Limit to showing 3 markers max (with "+N" indicator for more)

2. Create `renderCommitMarkers(artifactGroup, commits)` helper:
   - Create SVG group for commit indicators
   - Add checkmark icons: small circle with check symbol inside
   - Color: Green (#2ECC71) for completed commits
   - Size: 12x12px per marker

3. Add hover tooltip showing commit details:
   - On hover, show tooltip with commit message
   - Format: "Committed: {message}\nFiles: {file count}"

4. Add CSS styles in index.html:
   ```css
   .commit-marker {
     fill: #2ECC71;
     cursor: pointer;
   }
   .commit-marker:hover {
     fill: #27AE60;
     transform: scale(1.2);
   }
   .commit-marker-group {
     transition: opacity 0.2s ease;
   }
   .commit-overflow {
     fill: #888;
     font-size: 9px;
   }
   ```

5. Ensure commit markers don't interfere with artifact click handlers:
   - Stop propagation on commit marker clicks
   - Show commit-specific tooltip instead of opening inspector
  </action>
  <verify>
Run `npm start`, open diagram view. Navigate to Execute stage with completed SUMMARY files. Verify green checkmark markers appear. Hover shows commit message tooltip.
  </verify>
  <done>
Commit markers (green checkmarks) visible on SUMMARY artifacts. Hover shows commit details. Max 3 markers displayed with overflow indicator.
  </done>
</task>

</tasks>

<verification>
1. Open Electron app with a GSD project that has completed phases
2. Switch to Diagram view
3. Navigate to Discuss stage - verify agent lanes show if both CONTEXT and RESEARCH exist
4. Navigate to Execute stage - verify agent lanes show for parallel-wave plans
5. Find SUMMARY artifacts - verify green checkmark commit markers
6. Hover over commit markers - verify tooltip shows commit message
7. Agent lane badges show correct icons/letters (R/E/D)

Requirements coverage:
- DIAG-06: Parallel agent lanes visualize concurrent work [Tasks 1-2]
- ARTF-05: Execute stage shows atomic commit markers [Tasks 1,3]
</verification>

<success_criteria>
1. Parallel agent lanes appear in discuss/execute stages when multiple agents worked concurrently
2. Agent badges/icons clearly indicate agent type (researcher, executor, discusser)
3. Commit markers (green checkmarks) appear on SUMMARY artifacts with commits
4. Hover tooltips show commit details without interfering with artifact interaction
5. Visual elements don't cause layout overflow or performance issues
</success_criteria>

<output>
After completion, create `.planning/phases/35-advanced-features/35-02-SUMMARY.md`
</output>

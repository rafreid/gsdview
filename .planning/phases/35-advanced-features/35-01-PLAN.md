---
phase: 35-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/diagram-renderer.js
  - src/renderer/gsd-pipeline-parser.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User sees context usage bar in each stage header showing utilization percentage"
    - "Context bars fill proportionally (e.g., 50% context = half-filled bar)"
    - "Context bar colors indicate health (green=good, yellow=warning, red=danger)"
    - "Responsive layout adjusts diagram when panels open/close"
  artifacts:
    - path: "src/renderer/gsd-pipeline-parser.js"
      provides: "Context usage calculation from SUMMARY.md files"
      contains: "calculateContextUsage"
    - path: "src/renderer/diagram-renderer.js"
      provides: "Context bar SVG rendering"
      contains: "renderContextBar"
    - path: "src/renderer/index.html"
      provides: "Context bar CSS styles"
      contains: "context-bar"
  key_links:
    - from: "gsd-pipeline-parser.js"
      to: "diagram-renderer.js"
      via: "stage.contextUsage property in parsePipelineState return"
      pattern: "contextUsage"
    - from: "diagram-renderer.js"
      to: "SVG rendering"
      via: "D3.js rect elements for context bars"
      pattern: "context-bar"
---

<objective>
Add "Why it works" context usage bars to each stage in the diagram view, showing Claude's context window utilization during that workflow stage.

Purpose: Demonstrate a key GSD principle - context management prevents quality degradation. Users can see how much context was consumed at each stage.

Output: Context bars in stage headers + responsive layout polish
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-real-time-updates/34-01-SUMMARY.md
@src/renderer/diagram-renderer.js
@src/renderer/gsd-pipeline-parser.js
@src/renderer/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parse context usage from SUMMARY.md files</name>
  <files>src/renderer/gsd-pipeline-parser.js</files>
  <action>
Add context usage extraction to the pipeline parser:

1. Create `calculateContextUsage(phaseDir)` function:
   - Scan for *-SUMMARY.md files in the phase directory
   - Parse YAML frontmatter from each SUMMARY file looking for `metrics.context_used` or similar
   - If no explicit metric, estimate based on file count and typical patterns:
     - 1-2 files modified = ~15-25% context
     - 3-5 files modified = ~30-50% context
     - 6+ files modified = ~50-70% context
   - Return average context usage for the phase (0-100 integer)

2. Update `parsePhases()` to call `calculateContextUsage()` and add result to phase object:
   ```javascript
   phases.push({
     number: phaseNumber,
     name: phaseName,
     stage,
     artifacts,
     directory: phaseDir,
     contextUsage: calculateContextUsage(phaseDir)  // NEW
   });
   ```

3. Update `buildStagesSummary()` to aggregate context usage per stage:
   - Calculate average contextUsage across all phases in that stage
   - Add to stage object as `stage.contextUsage`

Parse SUMMARY frontmatter using simple regex to extract metrics (don't add yaml parsing library - keep it lightweight).
  </action>
  <verify>
Open DevTools console in Electron app, check that `parsePipelineState()` returns stages with `contextUsage` property (0-100 integer).
  </verify>
  <done>
Each stage object in parsePipelineState() return includes contextUsage: number (0-100).
  </done>
</task>

<task type="auto">
  <name>Task 2: Render context usage bars in stage headers</name>
  <files>src/renderer/diagram-renderer.js, src/renderer/index.html</files>
  <action>
Add context bar visualization to diagram stages:

1. In diagram-renderer.js, create `renderContextBar(stageGroup, contextUsage)` function:
   - Add SVG group for context bar below stage header (y position: STAGE_HEADER_HEIGHT + 5)
   - Create background rect (full width, 8px height, dark gray fill #333)
   - Create foreground rect (width = contextUsage% of bar width, colored based on value)
   - Add percentage text label right-aligned
   - Color scheme:
     - 0-30%: Green (#2ECC71) - healthy
     - 31-50%: Yellow (#F1C40F) - normal
     - 51-70%: Orange (#F39C12) - warning
     - 71-100%: Red (#E74C3C) - danger zone

2. In `renderStages()`, call `renderContextBar()` for each stage after the header elements:
   ```javascript
   stageGroups.each(function(d) {
     renderContextBar(d3.select(this), d.stage.contextUsage || 0);
   });
   ```

3. Adjust artifact positioning to account for context bar:
   - In `renderArtifacts()`, increase `contentY` by ~20px to make room for context bar
   - Update `STAGE_HEADER_HEIGHT` constant or add `CONTEXT_BAR_HEIGHT = 20`

4. Add CSS styles in index.html:
   ```css
   .context-bar-bg {
     fill: #333;
     rx: 2;
   }
   .context-bar-fill {
     rx: 2;
     transition: width 0.5s ease;
   }
   .context-bar-label {
     fill: #888;
     font-size: 10px;
   }
   ```

5. Add tooltip on hover showing "Context Usage: X%" for accessibility.
  </action>
  <verify>
Run `npm start`, open diagram view. Each stage should display a colored context bar below the header showing percentage (e.g., "35%"). Hover should show tooltip.
  </verify>
  <done>
Context bars visible in all 6 stages, colors reflect usage level (green/yellow/orange/red), percentage label displays.
  </done>
</task>

<task type="auto">
  <name>Task 3: Polish responsive layout for diagram</name>
  <files>src/renderer/index.html, src/renderer/diagram-renderer.js</files>
  <action>
Improve diagram responsiveness when panels toggle:

1. In index.html, refine diagram-container responsive classes:
   - Ensure smooth transitions when tree panel opens/closes
   - Add `transition: left 0.2s ease, width 0.2s ease` to #diagram-container
   - Verify all panel combinations work (tree+activity, tree+statistics, etc.)

2. In diagram-renderer.js, handle window resize:
   - Add resize listener in mount() that re-centers the diagram:
     ```javascript
     window.addEventListener('resize', handleDiagramResize);
     ```
   - Create `handleDiagramResize()` that recalculates center offset
   - Remove listener in unmount()

3. Polish stage hover effects:
   - Ensure transform: scale(1.02) doesn't cause layout jumpiness
   - Add `transform-origin: center` for stable scaling

4. Test all panel combinations:
   - Tree panel open
   - Activity panel open
   - Statistics panel open
   - Multiple panels open simultaneously
  </action>
  <verify>
Toggle tree/activity/statistics panels while in diagram view. Diagram should smoothly adjust position without jarring jumps. Resize browser window - diagram should re-center.
  </verify>
  <done>
Diagram responds smoothly to panel toggles and window resize. No layout jumps or overflow issues.
  </done>
</task>

</tasks>

<verification>
1. Open Electron app with any GSD project
2. Switch to Diagram view
3. Verify context bars appear in all stage headers with percentage labels
4. Hover over context bars - tooltip shows "Context Usage: X%"
5. Toggle tree panel - diagram adjusts smoothly
6. Toggle activity panel - diagram adjusts smoothly
7. Resize browser window - diagram re-centers

Requirements coverage:
- DIAG-05: Context usage bars show utilization per stage [Tasks 1-2]
- Success Criterion 4 (partial): Responsive layout adjustments [Task 3]
</verification>

<success_criteria>
1. Context usage bars visible in all 6 stages with accurate percentage display
2. Bar colors reflect context health (green/yellow/orange/red gradient)
3. Diagram layout responds smoothly to panel toggles and window resize
4. No visual glitches or performance degradation during interactions
</success_criteria>

<output>
After completion, create `.planning/phases/35-advanced-features/35-01-SUMMARY.md`
</output>

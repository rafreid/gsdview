---
phase: 25-advanced-camera
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User can create a camera path from saved bookmarks"
    - "Camera smoothly flies through each waypoint in sequence"
    - "User can start path playback via UI button"
    - "User can stop path playback via UI button or by clicking graph"
    - "Path animation has smooth transitions between nodes"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Path animation state, sequence playback, waypoint navigation"
      contains: "pathPlaybackEnabled"
    - path: "src/renderer/index.html"
      provides: "Path play button with progress indicator"
      contains: "path-play"
  key_links:
    - from: "path-play button"
      to: "startPathPlayback function"
      via: "click event listener"
      pattern: "path-play.*addEventListener"
    - from: "startPathPlayback"
      to: "bookmarks array"
      via: "reads occupied slots"
      pattern: "bookmarks\\.filter"
---

<objective>
Add camera path animation that flies through multiple bookmarked nodes in sequence, creating guided tours through the graph.

Purpose: Enable users to create presentation tours by setting bookmarks at points of interest, then playing back a smooth camera animation that visits each location in order.

Output: Path play button that animates camera through all saved bookmarks with smooth transitions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-bookmarks-history/22-02-SUMMARY.md (bookmark system)
@src/renderer/renderer.js (bookmark array, flyToNodeSmooth pattern)
@src/renderer/index.html (UI structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Path animation state and playback logic</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add path animation functionality to renderer.js:

1. **State variables** (add near orbit state variables):
```javascript
// Path playback state
let pathPlaybackEnabled = false;
let pathWaypoints = []; // Array of { nodeId, cameraPosition, name }
let currentWaypointIndex = 0;
let pathPlaybackTimeoutId = null;
const PATH_DWELL_TIME = 2000; // Time to pause at each waypoint (ms)
const PATH_TRANSITION_TIME = 1500; // Time to fly between waypoints (ms)
```

2. **Path playback functions** (add after orbit mode functions):
```javascript
// Start path playback through all saved bookmarks
function startPathPlayback() {
  // Get all non-empty bookmarks as waypoints
  pathWaypoints = bookmarks
    .map((bm, index) => ({ ...bm, slot: index + 1 }))
    .filter(bm => bm !== null && bm.nodeId !== null);

  if (pathWaypoints.length < 2) {
    showToast('Save at least 2 bookmarks to create a path (Ctrl+1-9)', 'warning');
    return;
  }

  pathPlaybackEnabled = true;
  currentWaypointIndex = 0;

  // Stop orbit mode if running
  if (orbitModeEnabled) {
    stopOrbitMode();
  }

  // Update UI
  const playBtn = document.getElementById('path-play');
  if (playBtn) {
    playBtn.classList.add('active');
    playBtn.innerHTML = '<span class="path-icon">&#9632;</span> Stop';
  }
  updatePathProgress();

  // Start the journey
  flyToWaypoint(0);
}

function stopPathPlayback() {
  pathPlaybackEnabled = false;
  if (pathPlaybackTimeoutId) {
    clearTimeout(pathPlaybackTimeoutId);
    pathPlaybackTimeoutId = null;
  }
  pathWaypoints = [];
  currentWaypointIndex = 0;

  // Update UI
  const playBtn = document.getElementById('path-play');
  if (playBtn) {
    playBtn.classList.remove('active');
    playBtn.innerHTML = '<span class="path-icon">&#9654;</span> Path';
  }
  updatePathProgress();
}

function flyToWaypoint(index) {
  if (!pathPlaybackEnabled || index >= pathWaypoints.length) {
    // Path complete - loop back to start or stop
    if (pathPlaybackEnabled && pathWaypoints.length > 0) {
      // Loop the path
      currentWaypointIndex = 0;
      flyToWaypoint(0);
    } else {
      stopPathPlayback();
    }
    return;
  }

  currentWaypointIndex = index;
  updatePathProgress();

  const waypoint = pathWaypoints[index];

  // Find the node in graph data
  const node = currentGraphData?.nodes?.find(n => n.id === waypoint.nodeId);

  if (node && Graph) {
    // Fly to node position with smooth transition
    if (is3D) {
      const distance = 80;
      const distRatio = 1 + distance / Math.hypot(node.x || 0, node.y || 0, node.z || 0);
      Graph.cameraPosition(
        {
          x: (node.x || 0) * distRatio,
          y: (node.y || 0) * distRatio,
          z: (node.z || 0) * distRatio
        },
        node,
        PATH_TRANSITION_TIME
      );
    } else {
      Graph.cameraPosition(
        { x: node.x || 0, y: node.y || 0, z: 180 },
        node,
        PATH_TRANSITION_TIME
      );
    }

    // Select the node
    selectedNode = node;
    showDetailsPanel(node);
    updateBreadcrumb(node);

    // Show toast with waypoint info
    showToast(`${index + 1}/${pathWaypoints.length}: ${waypoint.name || 'Bookmark ' + waypoint.slot}`, 'info');
  }

  // Schedule next waypoint after transition + dwell time
  pathPlaybackTimeoutId = setTimeout(() => {
    if (pathPlaybackEnabled) {
      flyToWaypoint(index + 1);
    }
  }, PATH_TRANSITION_TIME + PATH_DWELL_TIME);
}

function togglePathPlayback() {
  if (pathPlaybackEnabled) {
    stopPathPlayback();
  } else {
    startPathPlayback();
  }
}

// Update path progress indicator
function updatePathProgress() {
  const indicator = document.getElementById('path-progress');
  if (!indicator) return;

  if (!pathPlaybackEnabled || pathWaypoints.length === 0) {
    indicator.textContent = '';
    indicator.style.display = 'none';
  } else {
    indicator.textContent = `${currentWaypointIndex + 1}/${pathWaypoints.length}`;
    indicator.style.display = 'inline-block';
  }
}
```

3. **Stop path on graph interaction** - Add to click handler (same place as orbit stop):
```javascript
// Stop path playback when user clicks on graph
if (pathPlaybackEnabled) {
  stopPathPlayback();
}
```

4. **Event listeners** (add in init section):
```javascript
// Path playback toggle
document.getElementById('path-play')?.addEventListener('click', togglePathPlayback);
```

5. **Keyboard shortcut** (add to existing keyboard handler):
```javascript
// P key to toggle path playback
if (event.key === 'p' || event.key === 'P') {
  if (!event.ctrlKey && !event.metaKey && !event.altKey) {
    // Don't trigger if typing in input
    if (document.activeElement.tagName !== 'INPUT') {
      togglePathPlayback();
    }
  }
}
```
  </action>
  <verify>
Code compiles without errors:
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv && npm run build
```
  </verify>
  <done>Path playback state exists, startPathPlayback reads bookmarks array, flyToWaypoint animates through each waypoint with dwell time, stopPathPlayback cleans up state, path stops on user interaction</done>
</task>

<task type="auto">
  <name>Task 2: Path play button and progress indicator UI</name>
  <files>src/renderer/index.html</files>
  <action>
Add path playback UI controls to index.html:

1. **CSS styles** (add after orbit-speed styles):
```css
/* Path Playback Button */
#path-play {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  margin-left: 8px;
  background: rgba(100, 149, 237, 0.15);
  border: 1px solid rgba(100, 149, 237, 0.4);
  border-radius: 4px;
  color: rgba(100, 149, 237, 0.7);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#path-play:hover {
  background: rgba(100, 149, 237, 0.25);
  border-color: rgba(100, 149, 237, 0.6);
  color: #6495ED;
}

#path-play.active {
  background: rgba(100, 149, 237, 0.3);
  border-color: #6495ED;
  color: #6495ED;
}

#path-play .path-icon {
  font-size: 12px;
}

/* Path Progress Indicator */
#path-progress {
  display: none;
  margin-left: 6px;
  padding: 2px 8px;
  background: rgba(100, 149, 237, 0.2);
  border-radius: 10px;
  font-size: 11px;
  color: #6495ED;
  font-weight: 500;
}
```

2. **HTML elements** (add after orbit-speed-container, before nav-controls):
```html
<button id="path-play" title="Play camera path through bookmarks (P key)">
  <span class="path-icon">&#9654;</span> Path
</button>
<span id="path-progress"></span>
```

The path button uses cornflower blue (#6495ED) to match other camera controls.
  </action>
  <verify>
App launches and path button is visible:
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv && npm run build && npm start
```
Verify: Path button appears after orbit controls, progress indicator is hidden initially.
  </verify>
  <done>Path play button with cornflower blue styling visible in toolbar, progress indicator shows current waypoint during playback, button text changes to "Stop" when active</done>
</task>

</tasks>

<verification>
1. Launch app: `npm start`
2. Open a project folder
3. Select different nodes and save 3+ bookmarks using Ctrl+1, Ctrl+2, Ctrl+3
4. Click "Path" button - camera should fly through bookmarks in order
5. Watch progress indicator show "1/3", "2/3", "3/3"
6. After reaching last bookmark, path should loop back to first
7. Click graph during playback - path should stop immediately
8. Press "P" key to start/stop path playback
9. Click "Path" with only 1 bookmark - should show warning toast
</verification>

<success_criteria>
- Path button visible in toolbar with cornflower blue theme
- Clicking Path with 2+ bookmarks starts sequential camera animation
- Camera flies smoothly to each bookmarked position
- Progress indicator shows "X/Y" during playback
- 2-second dwell time at each waypoint before moving on
- Path loops continuously until stopped
- Clicking graph or Path button stops playback
- P key toggles path playback
- Warning toast appears if fewer than 2 bookmarks exist
</success_criteria>

<output>
After completion, create `.planning/phases/25-advanced-camera/25-02-SUMMARY.md`
</output>

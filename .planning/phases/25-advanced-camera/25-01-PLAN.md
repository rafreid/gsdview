---
phase: 25-advanced-camera
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "Camera rotates smoothly around focused node when orbit mode is active"
    - "User can start orbit mode via UI toggle button"
    - "User can stop orbit mode via UI toggle button or by clicking the graph"
    - "Orbit speed is configurable via slider control"
    - "Orbit continues indefinitely until user stops it"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Orbit mode state, animation loop, toggle function"
      contains: "orbitModeEnabled"
    - path: "src/renderer/index.html"
      provides: "Orbit toggle button and speed slider"
      contains: "orbit-toggle"
  key_links:
    - from: "orbit-toggle button"
      to: "toggleOrbitMode function"
      via: "click event listener"
      pattern: "orbit-toggle.*addEventListener"
    - from: "orbitAnimationLoop"
      to: "Graph.cameraPosition"
      via: "requestAnimationFrame"
      pattern: "requestAnimationFrame.*orbitLoop"
---

<objective>
Add orbit mode that continuously rotates the camera around the currently focused node for presentation purposes.

Purpose: Enable users to showcase their project graph in presentations by having the camera automatically orbit around a node of interest, providing a dynamic 3D view without manual interaction.

Output: Orbit toggle button with smooth camera rotation animation and speed control slider.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js (orbit animation, camera control patterns)
@src/renderer/index.html (UI structure, button styles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Orbit mode state and animation loop</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add orbit mode functionality to renderer.js:

1. **State variables** (add near other camera state ~line 356):
```javascript
// Orbit mode state
let orbitModeEnabled = false;
let orbitSpeed = 0.5; // Radians per second (configurable)
let orbitAngle = 0; // Current orbit angle
let orbitAnimationId = null; // RAF reference
let orbitCenterNode = null; // Node being orbited
const ORBIT_RADIUS_MULTIPLIER = 1.5; // Distance from node (multiplied by node's current camera distance)
```

2. **Orbit animation loop** (add after flyToNodeSmooth function ~line 1740):
```javascript
// Start orbit mode around currently selected node
function startOrbitMode() {
  if (!selectedNode || !Graph) return;

  orbitModeEnabled = true;
  orbitCenterNode = selectedNode;

  // Calculate initial orbit radius based on current camera distance
  const cameraPos = Graph.cameraPosition();
  const nodePos = { x: orbitCenterNode.x || 0, y: orbitCenterNode.y || 0, z: orbitCenterNode.z || 0 };
  const currentDistance = Math.sqrt(
    Math.pow(cameraPos.x - nodePos.x, 2) +
    Math.pow(cameraPos.y - nodePos.y, 2) +
    Math.pow(cameraPos.z - nodePos.z, 2)
  );
  const orbitRadius = currentDistance * ORBIT_RADIUS_MULTIPLIER;

  // Calculate initial angle from current camera position
  orbitAngle = Math.atan2(cameraPos.x - nodePos.x, cameraPos.z - nodePos.z);

  let lastTime = performance.now();

  function orbitLoop(currentTime) {
    if (!orbitModeEnabled) {
      orbitAnimationId = null;
      return;
    }

    const deltaTime = (currentTime - lastTime) / 1000; // Convert to seconds
    lastTime = currentTime;

    // Increment angle based on speed
    orbitAngle += orbitSpeed * deltaTime;

    // Calculate new camera position (orbit in XZ plane for 3D, XY for 2D)
    const nodePos = {
      x: orbitCenterNode.x || 0,
      y: orbitCenterNode.y || 0,
      z: orbitCenterNode.z || 0
    };

    if (is3D) {
      // 3D orbit: camera moves in XZ plane, Y stays at node height + offset
      const camX = nodePos.x + orbitRadius * Math.sin(orbitAngle);
      const camY = nodePos.y + orbitRadius * 0.3; // Slight elevation
      const camZ = nodePos.z + orbitRadius * Math.cos(orbitAngle);

      Graph.cameraPosition(
        { x: camX, y: camY, z: camZ },
        nodePos,
        0 // Instant positioning for smooth orbit
      );
    } else {
      // 2D orbit: camera rotates around node's XY position at fixed Z
      const camX = nodePos.x + orbitRadius * Math.sin(orbitAngle);
      const camY = nodePos.y + orbitRadius * Math.cos(orbitAngle);
      const camZ = 200; // Fixed Z height for 2D

      Graph.cameraPosition(
        { x: camX, y: camY, z: camZ },
        { x: nodePos.x, y: nodePos.y, z: 0 },
        0
      );
    }

    orbitAnimationId = requestAnimationFrame(orbitLoop);
  }

  orbitAnimationId = requestAnimationFrame(orbitLoop);

  // Update UI
  const toggle = document.getElementById('orbit-toggle');
  if (toggle) toggle.classList.add('active');
}

function stopOrbitMode() {
  orbitModeEnabled = false;
  if (orbitAnimationId) {
    cancelAnimationFrame(orbitAnimationId);
    orbitAnimationId = null;
  }
  orbitCenterNode = null;

  // Update UI
  const toggle = document.getElementById('orbit-toggle');
  if (toggle) toggle.classList.remove('active');
}

function toggleOrbitMode() {
  if (orbitModeEnabled) {
    stopOrbitMode();
  } else {
    if (!selectedNode) {
      showToast('Select a node first to orbit around', 'warning');
      return;
    }
    startOrbitMode();
  }
}

// Update orbit speed from slider
function updateOrbitSpeed(value) {
  // Slider value 1-10 maps to 0.1 - 1.0 radians/sec
  orbitSpeed = value / 10;
  const label = document.getElementById('orbit-speed-value');
  if (label) label.textContent = value.toFixed(1);
}
```

3. **Stop orbit on graph interaction** - Add to the onNodeClick handler (find existing click handler):
```javascript
// Stop orbit mode when user clicks on graph
if (orbitModeEnabled) {
  stopOrbitMode();
}
```

4. **Event listeners** (add in DOMContentLoaded or init section):
```javascript
// Orbit mode toggle
document.getElementById('orbit-toggle')?.addEventListener('click', toggleOrbitMode);

// Orbit speed slider
document.getElementById('orbit-speed-slider')?.addEventListener('input', (e) => {
  updateOrbitSpeed(parseFloat(e.target.value));
});

// Persist orbit speed
document.getElementById('orbit-speed-slider')?.addEventListener('change', async (e) => {
  try {
    await window.electronAPI.store.set('orbitSpeed', parseFloat(e.target.value));
  } catch (err) {
    console.log('[Orbit] Could not save speed setting:', err);
  }
});

// Load orbit speed on startup
async function loadOrbitSpeedSetting() {
  try {
    const saved = await window.electronAPI.store.get('orbitSpeed');
    if (typeof saved === 'number') {
      const slider = document.getElementById('orbit-speed-slider');
      const label = document.getElementById('orbit-speed-value');
      if (slider) {
        slider.value = saved;
        orbitSpeed = saved / 10;
        if (label) label.textContent = saved.toFixed(1);
      }
    }
  } catch (err) {
    console.log('[Orbit] Could not load speed setting:', err);
  }
}
```

5. Call `loadOrbitSpeedSetting()` in the initialization section alongside other setting loaders.
  </action>
  <verify>
Code compiles without errors when bundled:
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv && npm run build
```
  </verify>
  <done>Orbit mode state variables exist, startOrbitMode/stopOrbitMode/toggleOrbitMode functions implemented, animation loop uses requestAnimationFrame with smooth camera rotation, orbit stops on graph click</done>
</task>

<task type="auto">
  <name>Task 2: Orbit toggle button and speed slider UI</name>
  <files>src/renderer/index.html</files>
  <action>
Add orbit mode UI controls to index.html:

1. **CSS styles** (add after the zoom-btn styles, before nav-controls):
```css
/* Orbit Mode Toggle */
#orbit-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  margin-left: 10px;
  background: rgba(100, 149, 237, 0.15);
  border: 1px solid rgba(100, 149, 237, 0.4);
  border-radius: 4px;
  color: rgba(100, 149, 237, 0.7);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#orbit-toggle:hover {
  background: rgba(100, 149, 237, 0.25);
  border-color: rgba(100, 149, 237, 0.6);
  color: #6495ED;
}

#orbit-toggle.active {
  background: rgba(100, 149, 237, 0.3);
  border-color: #6495ED;
  color: #6495ED;
  animation: orbit-pulse 2s ease-in-out infinite;
}

@keyframes orbit-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(100, 149, 237, 0.4); }
  50% { box-shadow: 0 0 0 4px rgba(100, 149, 237, 0.2); }
}

#orbit-toggle .orbit-icon {
  font-size: 14px;
}

/* Orbit Speed Slider */
#orbit-speed-container {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 8px;
  padding: 4px 8px;
  background: rgba(100, 149, 237, 0.1);
  border-radius: 4px;
}

#orbit-speed-label {
  font-size: 11px;
  color: rgba(100, 149, 237, 0.7);
}

#orbit-speed-slider {
  width: 60px;
  height: 4px;
  -webkit-appearance: none;
  background: rgba(100, 149, 237, 0.3);
  border-radius: 2px;
  outline: none;
}

#orbit-speed-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  background: #6495ED;
  border-radius: 50%;
  cursor: pointer;
}

#orbit-speed-slider::-webkit-slider-thumb:hover {
  background: #87CEEB;
}

#orbit-speed-value {
  font-size: 11px;
  color: rgba(100, 149, 237, 0.7);
  min-width: 20px;
}
```

2. **HTML elements** (add after zoom-presets div, before nav-controls div):
```html
<button id="orbit-toggle" title="Orbit camera around selected node (presentation mode)">
  <span class="orbit-icon">&#10227;</span> Orbit
</button>
<div id="orbit-speed-container" title="Orbit rotation speed">
  <span id="orbit-speed-label">Speed:</span>
  <input type="range" id="orbit-speed-slider" min="1" max="10" value="5" step="0.5">
  <span id="orbit-speed-value">5.0</span>
</div>
```

The orbit controls use cornflower blue (#6495ED) color theme to match zoom controls (camera-related features).
  </action>
  <verify>
App launches and orbit button is visible in toolbar:
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv && npm run build && npm start
```
Verify: Orbit button appears after zoom presets, before navigation controls.
  </verify>
  <done>Orbit toggle button with cornflower blue styling visible in toolbar, speed slider with 1-10 range appears next to toggle, active state shows pulsing animation</done>
</task>

</tasks>

<verification>
1. Launch app: `npm start`
2. Open a project folder
3. Select a node in the graph
4. Click "Orbit" button - camera should begin rotating around the node
5. Adjust speed slider - rotation should speed up or slow down
6. Click graph background - orbit should stop
7. Click "Orbit" again while no node selected - should show warning toast
8. Restart app - speed setting should persist
</verification>

<success_criteria>
- Orbit button visible in toolbar with cornflower blue theme
- Clicking Orbit with node selected starts smooth camera rotation
- Camera orbits around node center point at configurable speed
- Clicking graph or Orbit button again stops orbit
- Speed slider adjusts rotation speed (1-10 range)
- Speed setting persists across app restarts via electron-store
- Works in both 2D and 3D modes
</success_criteria>

<output>
After completion, create `.planning/phases/25-advanced-camera/25-01-SUMMARY.md`
</output>

---
phase: 04-state-visualization
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/renderer/renderer.js
  - src/main/graph-builder.js
autonomous: false

must_haves:
  truths:
    - "Blocked items have red connection indicators"
    - "Red indicators visible from any zoom level"
    - "Blockers parsed from STATE.md appear in graph"
    - "Red edge connects blocker node to blocked item"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Red link coloring for blocker connections"
      contains: "blocker"
    - path: "src/main/graph-builder.js"
      provides: "Blocker nodes and links from state data"
      contains: "blocker"
  key_links:
    - from: "src/main/graph-builder.js"
      to: "projectData.state.blockers"
      via: "creates blocker nodes from state"
      pattern: "state\\.blockers"
    - from: "src/renderer/renderer.js"
      to: "link.type === 'blocks'"
      via: "colors blocker links red"
      pattern: "blocks.*red"
---

<objective>
Add red connection indicators for blocked items parsed from STATE.md blockers.

Purpose: STA-03 requires blocked items to have visible red indicators so users can immediately see what's blocking progress. Blockers from STATE.md should appear as nodes with red edges to what they block.

Output: Blocker nodes appear in graph with red connections to blocked phases/items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/renderer/renderer.js
@src/main/graph-builder.js
@.planning/phases/04-state-visualization/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add blocker nodes and links in graph builder</name>
  <files>src/main/graph-builder.js</files>
  <action>
Update `src/main/graph-builder.js` to create blocker nodes from state data.

1. Add blocker color to nodeColors reference (we'll handle actual coloring in renderer):
```javascript
// Blocker type will be colored red in renderer
```

2. Update the buildGraph function to handle blockers from state. After processing directory structure and before the final return, add:

```javascript
// Process blockers from state
const { state } = projectData;
if (state && state.blockers && state.blockers.length > 0) {
  // Create a blockers group node
  const blockersGroupNode = addNode({
    id: 'blockers-group',
    name: 'Blockers',
    type: 'blocker-group'
  });

  // Link blockers group to project root
  addLink(projectNode.id, blockersGroupNode.id, 'contains');

  // Create individual blocker nodes
  state.blockers.forEach((blocker, index) => {
    const blockerId = `blocker-${index}`;
    const blockerNode = addNode({
      id: blockerId,
      name: blocker.text.length > 40 ? blocker.text.substring(0, 40) + '...' : blocker.text,
      type: 'blocker',
      fullText: blocker.text,
      status: 'blocked'
    });

    // Link blocker to blockers group
    addLink(blockersGroupNode.id, blockerId, 'contains');

    // Try to link blocker to the current phase (what it's blocking)
    if (state.currentPhase) {
      addLink(blockerId, `phase-${state.currentPhase}`, 'blocks');
    }
  });
}
```

This creates:
- A "Blockers" group node connected to project root
- Individual blocker nodes for each blocker text
- Red "blocks" links from blockers to the current phase
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
# First, add a test blocker to STATE.md
echo "Testing blocker parsing..."

# Check if graph builder handles blockers
node -e "
const { buildGraph } = require('./src/main/graph-builder');
const testData = {
  roadmap: { phases: [{ id: 'phase-1', number: 1, name: 'Test', status: 'pending', plans: [] }] },
  requirements: { requirements: [], phaseMapping: {} },
  directory: { nodes: [], links: [] },
  state: {
    currentPhase: 1,
    blockers: [{ text: 'Test blocker item' }]
  }
};
const result = buildGraph(testData);
console.log('Blocker nodes:', result.nodes.filter(n => n.type === 'blocker' || n.type === 'blocker-group'));
console.log('Block links:', result.links.filter(l => l.type === 'blocks'));
"
```
Should show blocker nodes and "blocks" type links.
  </verify>
  <done>
graph-builder creates blocker nodes from state.blockers and links them to current phase with "blocks" type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add red coloring for blocker links and nodes</name>
  <files>src/renderer/renderer.js</files>
  <action>
Update `src/renderer/renderer.js` to color blocker elements red.

1. Add blocker colors to nodeColors object:
```javascript
const nodeColors = {
  root: '#FF6B6B',
  phase: '#4ECDC4',
  plan: '#45B7D1',
  task: '#98D8C8',
  requirement: '#F7DC6F',
  file: '#DDA0DD',
  directory: '#BB8FCE',
  blocker: '#FF4444',         // Red for blockers
  'blocker-group': '#FF6666'  // Lighter red for group
};
```

2. Update getNodeColor to handle blockers (they should always be red, regardless of status):
```javascript
function getNodeColor(node) {
  // Blockers are always red
  if (node.type === 'blocker' || node.type === 'blocker-group') {
    return nodeColors[node.type] || '#FF4444';
  }

  // Nodes that can have status: phases, plans, requirements
  const statusAwareTypes = ['phase', 'plan', 'requirement'];

  // If node has status and is a status-aware type, use status color
  if (node.status && statusAwareTypes.includes(node.type)) {
    return statusColors[node.status] || nodeColors[node.type] || DEFAULT_NODE_COLOR;
  }

  // Fall back to type-based color
  return nodeColors[node.type] || DEFAULT_NODE_COLOR;
}
```

3. Update getLinkColor to make "blocks" links bright red:
```javascript
function getLinkColor(link, graphData) {
  // Blocker links are always bright red
  if (link.type === 'blocks') {
    return '#FF0000';  // Pure red, fully opaque
  }

  const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
  const sourceNode = graphData.nodes.find(n => n.id === sourceId);
  if (sourceNode) {
    const baseColor = nodeColors[sourceNode.type] || DEFAULT_NODE_COLOR;
    return baseColor + '66'; // 40% opacity
  }
  return 'rgba(255,255,255,0.2)';
}
```

4. Update getLinkWidth to make blocker links thicker for visibility:
```javascript
function getLinkWidth(link, graphData) {
  // Blocker links are thick for visibility
  if (link.type === 'blocks') {
    return 3;  // Thicker than normal links
  }

  const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
  const sourceNode = graphData.nodes.find(n => n.id === sourceId);
  if (sourceNode) {
    if (sourceNode.type === 'root') return 2.5;
    if (sourceNode.type === 'phase') return 2;
    if (sourceNode.type === 'plan') return 1.5;
    if (sourceNode.type === 'directory') return 1;
    return 1;
  }
  return 1;
}
```

5. Update the color legend to include blockers. In populateColorLegend(), add after status colors section:
```javascript
// Blocker indicator
const blockerTitle = document.createElement('div');
blockerTitle.className = 'legend-title';
blockerTitle.style.marginTop = '12px';
blockerTitle.textContent = 'Blockers';
legend.appendChild(blockerTitle);

const blockerItem = document.createElement('div');
blockerItem.className = 'legend-item';

const blockerCircle = document.createElement('div');
blockerCircle.className = 'legend-color';
blockerCircle.style.backgroundColor = nodeColors.blocker;

const blockerLabel = document.createElement('span');
blockerLabel.className = 'legend-label';
blockerLabel.textContent = 'Blocked Item';

blockerItem.appendChild(blockerCircle);
blockerItem.appendChild(blockerLabel);
legend.appendChild(blockerItem);
```

6. Update nodeLabel to show blocker full text:
In the nodeLabel configuration, add handling for blocker fullText:
```javascript
.nodeLabel(node => {
  let label = node.name;

  // Show full text for truncated blockers
  if (node.fullText && node.fullText !== node.name) {
    label = node.fullText;
  }

  // Add status badge...
  // (rest of existing label logic)
})
```
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
npm start
# Select project folder
# If STATE.md has blockers, they should appear as red nodes
# Red edges should connect to current phase
# Legend should show blocker color
```
  </verify>
  <done>
Blocker nodes appear red, blocker links are bright red and thick, legend includes blocker indicator.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Blocker visualization with red connection indicators</what-built>
  <how-to-verify>
1. First, add a test blocker to `.planning/STATE.md`:
   - Edit the "### Blockers/Concerns" section
   - Change "None yet." to "- Test blocker for Phase 4"
   - Save the file

2. Run `npm start` in the GSDv project directory

3. Click "Select Project" and choose the GSDv folder

4. Look for:
   - A red "Blockers" group node connected to project root
   - A red "Test blocker for Phase 4" node
   - A bright red, thick edge from blocker to Phase 4 node
   - Legend shows "Blocked Item" with red color

5. Zoom out to verify red indicators are visible from distance

6. Hover over blocker node to see full text in tooltip

7. After testing, you can remove the test blocker from STATE.md
  </how-to-verify>
  <resume-signal>Type "approved" if blockers show with red indicators, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. graph-builder creates blocker nodes from state.blockers
2. Blocker nodes have type 'blocker' and 'blocker-group'
3. Links with type 'blocks' connect blockers to current phase
4. Blocker nodes render as red
5. Blocker links render as thick red lines
6. Red indicators visible from any zoom level
7. Legend includes blocker color entry
</verification>

<success_criteria>
- Blockers from STATE.md appear as red nodes in graph
- Red edges connect blockers to the phase they block
- Red indicators visible from any zoom level
- Links are thicker than normal for visibility
- Legend shows blocker color
- Hovering blocker shows full text
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-visualization/04-04-SUMMARY.md`
</output>

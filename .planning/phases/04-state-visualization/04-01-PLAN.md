---
phase: 04-state-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/parsers/state-parser.js
  - src/main/main.js
  - src/main/preload.js
autonomous: true

must_haves:
  truths:
    - "STATE.md is parsed to extract current phase number"
    - "STATE.md is parsed to extract blockers list"
    - "Parser output available via IPC from renderer"
  artifacts:
    - path: "src/main/parsers/state-parser.js"
      provides: "parseState function"
      exports: ["parseState"]
    - path: "src/main/main.js"
      provides: "parse-state IPC handler"
      contains: "ipcMain.handle('parse-state'"
    - path: "src/main/preload.js"
      provides: "parseState exposed to renderer"
      contains: "parseState"
  key_links:
    - from: "src/main/main.js"
      to: "src/main/parsers/state-parser.js"
      via: "require and call parseState"
      pattern: "require.*state-parser"
---

<objective>
Create a parser for STATE.md that extracts current phase, plan, and any blockers.

Purpose: STATE.md contains the current project position (which phase/plan is active) and blockers. This data is needed for current phase highlighting (STA-01) and blocker visualization (STA-03).

Output: A state-parser.js module that extracts current position and blockers, exposed via IPC to the renderer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/main/main.js
@src/main/preload.js
@src/main/parsers/roadmap-parser.js (reference for parser pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STATE.md parser</name>
  <files>src/main/parsers/state-parser.js</files>
  <action>
Create `src/main/parsers/state-parser.js` following the same pattern as roadmap-parser.js.

The parser should extract:
1. **Current phase number** from "Phase: X of Y" line
2. **Current plan number** from "Plan: X of Y" line
3. **Status** (e.g., "Ready to plan", "In progress")
4. **Blockers** from the "### Blockers/Concerns" section (if any exist)

STATE.md format example:
```
## Current Position

Phase: 4 of 6 (State Visualization)
Plan: 0 of 4 in current phase
Status: Ready to plan

## Accumulated Context

### Blockers/Concerns

- Database migration blocked by schema review
- API endpoint blocked by auth implementation
```

Implementation:
```javascript
const fs = require('fs');
const path = require('path');

/**
 * Parse STATE.md to extract current position and blockers
 * @param {string} planningPath - Path to .planning/ directory
 * @returns {Object} { currentPhase, currentPlan, status, blockers }
 */
function parseState(planningPath) {
  const statePath = path.join(planningPath, 'STATE.md');

  if (!fs.existsSync(statePath)) {
    return {
      currentPhase: null,
      currentPlan: null,
      status: null,
      blockers: [],
      error: 'STATE.md not found'
    };
  }

  const content = fs.readFileSync(statePath, 'utf-8');

  // Extract current phase: "Phase: 4 of 6 (State Visualization)"
  const phaseMatch = content.match(/Phase:\s*(\d+)\s+of\s+\d+/);
  const currentPhase = phaseMatch ? parseInt(phaseMatch[1], 10) : null;

  // Extract current plan: "Plan: 0 of 4 in current phase"
  const planMatch = content.match(/Plan:\s*(\d+)\s+of\s+\d+/);
  const currentPlan = planMatch ? parseInt(planMatch[1], 10) : null;

  // Extract status: "Status: Ready to plan"
  const statusMatch = content.match(/Status:\s*([^\n]+)/);
  const status = statusMatch ? statusMatch[1].trim() : null;

  // Extract blockers from "### Blockers/Concerns" section
  const blockers = [];
  const blockersMatch = content.match(/###\s*Blockers\/Concerns\s*\n([\s\S]*?)(?=\n##|\n###|$)/);

  if (blockersMatch) {
    const blockersSection = blockersMatch[1];
    // Parse bullet points: "- blocker text" or "None yet."
    const bulletRegex = /^-\s+(.+)$/gm;
    let match;
    while ((match = bulletRegex.exec(blockersSection)) !== null) {
      const text = match[1].trim();
      // Skip "None yet" or similar
      if (text.toLowerCase() !== 'none yet.' && text.toLowerCase() !== 'none') {
        blockers.push({ text });
      }
    }
  }

  return {
    currentPhase,
    currentPlan,
    status,
    blockers
  };
}

module.exports = { parseState };
```
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
node -e "
const { parseState } = require('./src/main/parsers/state-parser');
const result = parseState('.planning');
console.log('Current phase:', result.currentPhase);
console.log('Current plan:', result.currentPlan);
console.log('Status:', result.status);
console.log('Blockers:', result.blockers.length);
"
```
Should output current phase number, plan number, status, and blocker count.
  </verify>
  <done>
parseState(planningPath) returns { currentPhase: number, currentPlan: number, status: string, blockers: array }.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire state parser to IPC and update parse-project</name>
  <files>src/main/main.js, src/main/preload.js</files>
  <action>
Update main.js and preload.js to expose state parser.

In `src/main/main.js`:
1. Add require at top with other parser imports:
```javascript
const { parseState } = require('./parsers/state-parser');
```

2. Add IPC handler for standalone state parsing (after other parse handlers):
```javascript
// IPC handler for parsing state
ipcMain.handle('parse-state', async (event, planningPath) => {
  try {
    return parseState(planningPath);
  } catch (error) {
    console.error('Error parsing state:', error);
    return { error: error.message, currentPhase: null, currentPlan: null, blockers: [] };
  }
});
```

3. Update the 'parse-project' handler to include state data:
```javascript
// IPC handler for parsing all GSD data at once
ipcMain.handle('parse-project', async (event, projectPath) => {
  try {
    const planningPath = path.join(projectPath, '.planning');

    const roadmap = parseRoadmap(planningPath);
    const requirements = parseRequirements(planningPath);
    const directory = parseDirectory(planningPath);
    const dirFlattened = flattenTree(directory.tree);
    const state = parseState(planningPath);  // ADD THIS

    return {
      roadmap,
      requirements,
      directory: { ...directory, ...dirFlattened },
      state,  // ADD THIS
      projectPath
    };
  } catch (error) {
    console.error('Error parsing project:', error);
    return { error: error.message };
  }
});
```

In `src/main/preload.js`:
Add parseState to the exposed API:
```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  selectFolder: () => ipcRenderer.invoke('select-folder'),
  parseRoadmap: (planningPath) => ipcRenderer.invoke('parse-roadmap', planningPath),
  parseRequirements: (planningPath) => ipcRenderer.invoke('parse-requirements', planningPath),
  parseDirectory: (planningPath) => ipcRenderer.invoke('parse-directory', planningPath),
  parseState: (planningPath) => ipcRenderer.invoke('parse-state', planningPath),  // ADD THIS
  parseProject: (projectPath) => ipcRenderer.invoke('parse-project', projectPath)
});
```
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
npm start
# In DevTools console:
# const result = await window.electronAPI.parseProject('/home/rafreid/AFLUXSYS/products/GSDv');
# console.log('State:', result.state);
```
Should show state object with currentPhase, currentPlan, status, blockers.
  </verify>
  <done>
parse-state IPC handler registered, parseProject includes state data, preload exposes parseState.
  </done>
</task>

</tasks>

<verification>
1. state-parser.js exists at src/main/parsers/
2. parseState returns currentPhase, currentPlan, status, blockers
3. IPC handler 'parse-state' registered
4. parse-project response includes state object
5. preload.js exposes parseState
</verification>

<success_criteria>
- STATE.md parser extracts current phase number (integer)
- Parser extracts current plan number (integer)
- Parser extracts blockers as array (empty if none)
- State data included in parse-project response
- Data accessible from renderer via IPC
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-visualization/04-01-SUMMARY.md`
</output>

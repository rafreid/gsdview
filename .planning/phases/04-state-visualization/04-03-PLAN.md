---
phase: 04-state-visualization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/renderer/renderer.js
autonomous: false

must_haves:
  truths:
    - "Current/active phase node has visible glow effect"
    - "Glow effect is visible from any zoom level"
    - "Only one phase (the current one) has the glow"
    - "Glow animates (pulse or steady glow)"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Current phase highlighting with glow effect"
      contains: "currentPhase"
  key_links:
    - from: "src/renderer/renderer.js"
      to: "projectData.state.currentPhase"
      via: "stores and uses current phase from state parser"
      pattern: "state\\.currentPhase"
---

<objective>
Add glow/pulse effect to the current/active phase node to make it visually prominent.

Purpose: STA-01 requires the current phase be highlighted so users instantly see where focus should be. The glow effect makes the active phase stand out from all other nodes.

Output: Updated renderer.js that applies a glow effect to the phase node matching the current phase from STATE.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/renderer/renderer.js
@.planning/phases/04-state-visualization/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Store current phase and add glow effect to active phase</name>
  <files>src/renderer/renderer.js</files>
  <action>
Update `src/renderer/renderer.js` to highlight the current phase with a glow effect.

1. Add a variable to track the current phase (near the top, after currentGraphData):
```javascript
// Current phase number from STATE.md (for highlighting)
let currentPhaseNumber = null;
```

2. Create a custom node rendering function that adds glow to current phase. 3d-force-graph supports custom node rendering via nodeThreeObject. Add this function:
```javascript
import * as THREE from 'three';  // Already imported by 3d-force-graph

/**
 * Create custom node object with optional glow for current phase
 * @param {Object} node - Node data
 * @returns {THREE.Object3D} Three.js object to render
 */
function createNodeObject(node, connectionCounts) {
  const group = new THREE.Group();

  // Calculate node size
  const size = getNodeSize(node, connectionCounts);

  // Create main sphere
  const geometry = new THREE.SphereGeometry(size, 16, 16);
  const color = getNodeColor(node);
  const material = new THREE.MeshLambertMaterial({
    color: color,
    transparent: true,
    opacity: 0.9
  });
  const sphere = new THREE.Mesh(geometry, material);
  group.add(sphere);

  // Add glow effect for current phase
  const isCurrentPhase = node.type === 'phase' &&
    currentPhaseNumber !== null &&
    node.id === `phase-${currentPhaseNumber}`;

  if (isCurrentPhase) {
    // Outer glow ring
    const glowGeometry = new THREE.SphereGeometry(size * 1.5, 16, 16);
    const glowMaterial = new THREE.MeshBasicMaterial({
      color: '#FFD700',  // Gold glow
      transparent: true,
      opacity: 0.3,
      side: THREE.BackSide
    });
    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
    glow.name = 'glow';
    group.add(glow);

    // Inner pulsing ring
    const pulseGeometry = new THREE.SphereGeometry(size * 1.2, 16, 16);
    const pulseMaterial = new THREE.MeshBasicMaterial({
      color: '#FFFFFF',
      transparent: true,
      opacity: 0.4,
      side: THREE.BackSide
    });
    const pulse = new THREE.Mesh(pulseGeometry, pulseMaterial);
    pulse.name = 'pulse';
    group.add(pulse);
  }

  return group;
}
```

3. Note: THREE is auto-imported by 3d-force-graph, but we need to access it. Modify the import at the top:
```javascript
import ForceGraph3D from '3d-force-graph';
import * as THREE from 'three';
```

4. Update the Graph initialization to use custom node objects. Replace the current Graph initialization with this updated version that uses nodeThreeObject:
```javascript
// Initialize 3D force graph
const container = document.getElementById('graph-container');
let connectionCounts = calculateConnectionCounts(currentGraphData);

const Graph = ForceGraph3D()(container)
  .graphData(currentGraphData)
  .nodeLabel(node => {
    let label = node.name;
    if (node.status) {
      const statusBadge = {
        complete: '[COMPLETE]',
        'in-progress': '[IN PROGRESS]',
        pending: '[PENDING]'
      };
      label += ` ${statusBadge[node.status] || ''}`;
    }
    if (node.description) label += `\n${node.description}`;
    if (node.goal) label += `\nGoal: ${node.goal}`;
    return label;
  })
  .nodeThreeObject(node => createNodeObject(node, connectionCounts))
  .nodeThreeObjectExtend(false)  // Replace default node, don't extend
  .linkColor(link => getLinkColor(link, currentGraphData))
  .linkWidth(link => getLinkWidth(link, currentGraphData))
  .linkOpacity(0.6)
  .linkDirectionalArrowLength(3.5)
  .linkDirectionalArrowRelPos(1)
  .backgroundColor('#1a1a2e')
  .showNavInfo(false);
```

5. Update the loadProject function to store currentPhaseNumber from state data:
```javascript
// In loadProject function, after parsing projectData:
if (projectData.state && projectData.state.currentPhase) {
  currentPhaseNumber = projectData.state.currentPhase;
  console.log('Current phase:', currentPhaseNumber);
}
```

6. Update the updateGraph function to refresh node objects when data changes:
```javascript
function updateGraph(graphData) {
  currentGraphData = graphData;
  connectionCounts = calculateConnectionCounts(graphData);

  Graph
    .graphData(graphData)
    .nodeThreeObject(node => createNodeObject(node, connectionCounts))
    .linkColor(link => getLinkColor(link, graphData))
    .linkWidth(link => getLinkWidth(link, graphData));

  // Zoom to fit after data update
  setTimeout(() => {
    Graph.zoomToFit(400);
  }, 500);
}
```

7. Add animation loop for pulsing effect. After Graph initialization:
```javascript
// Animate glow pulse effect
let pulsePhase = 0;
function animatePulse() {
  pulsePhase += 0.05;
  const pulseOpacity = 0.2 + 0.2 * Math.sin(pulsePhase);

  // Find and update pulse objects
  Graph.graphData().nodes.forEach(node => {
    const obj = Graph.nodeThreeObject(node);
    if (obj) {
      const pulse = obj.getObjectByName('pulse');
      if (pulse) {
        pulse.material.opacity = pulseOpacity;
      }
    }
  });

  requestAnimationFrame(animatePulse);
}
animatePulse();
```
  </action>
  <verify>
```bash
cd /home/rafreid/AFLUXSYS/products/GSDv
npm start
# Select the GSDv project folder
# Look for Phase 4 node (current phase per STATE.md)
# Should have visible gold glow around it
# Glow should pulse (opacity changes)
# Other phase nodes should NOT have glow
```
  </verify>
  <done>
Current phase node has pulsing gold glow visible from any zoom level. Only the current phase (from STATE.md) is highlighted.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Current phase highlighting with glow/pulse effect</what-built>
  <how-to-verify>
1. Run `npm start` in the GSDv project directory
2. Click "Select Project" and choose the GSDv folder
3. Locate the Phase 4 node (should be labeled "Phase 4: State Visualization")
4. Verify it has a gold glow effect around it
5. Observe the glow pulses (opacity changes smoothly)
6. Orbit/zoom to verify glow is visible from different angles and distances
7. Confirm NO other phase nodes have the glow effect
8. Check console for "Current phase: 4" log message
  </how-to-verify>
  <resume-signal>Type "approved" if current phase has visible glow/pulse, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. currentPhaseNumber variable stores current phase from STATE.md
2. createNodeObject adds glow effect only to current phase
3. Gold glow visible around current phase node
4. Pulse animation runs continuously
5. Glow visible at various zoom levels
6. Only one phase has the glow effect
</verification>

<success_criteria>
- Current phase (from STATE.md) has visible glow effect
- Glow is gold-colored for high visibility
- Glow pulses/animates to draw attention
- Effect visible from any zoom level
- No other phases have the glow
- Works correctly after loading different projects
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-visualization/04-03-SUMMARY.md`
</output>

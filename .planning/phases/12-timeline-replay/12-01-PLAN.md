---
phase: 12-timeline-replay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/index.html
  - src/renderer/renderer.js
autonomous: true

must_haves:
  truths:
    - "Timeline scrubber allows navigating backward/forward through activity history"
    - "Graph state updates to reflect file state at selected point in time"
    - "Timeline has play/pause controls for automatic activity replay"
  artifacts:
    - path: "src/renderer/index.html"
      provides: "Timeline scrubber UI, play/pause buttons, position indicator"
      contains: "timeline-scrubber"
    - path: "src/renderer/renderer.js"
      provides: "Timeline state management, playback logic, graph filtering"
      contains: "timelinePosition"
  key_links:
    - from: "timeline scrubber"
      to: "activityEntries filtering"
      via: "input event handler"
      pattern: "timeline.*position|timelinePosition"
    - from: "play button"
      to: "playback interval"
      via: "click handler starts/stops interval"
      pattern: "playbackInterval|setInterval"
    - from: "timeline position"
      to: "graph update"
      via: "node visibility based on timestamp"
      pattern: "updateGraphForTimeline|filterForTimeline"
---

<objective>
Implement timeline replay feature allowing users to scrub through activity history and replay file changes over time.

Purpose: Complete the v1.1 milestone by adding the final feature - temporal navigation through the activity log, enabling users to understand how their project evolved over a work session.

Output: Timeline UI with scrubber/play/pause controls integrated into activity panel, state management for timeline position, and graph filtering to show file state at any point in history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-activity-feed-change-indicators/08-02-SUMMARY.md
@src/renderer/renderer.js
@src/renderer/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Timeline UI Controls and State Variables</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
Add timeline controls to the activity panel header area (between the title and clear button):

In index.html:
1. Add timeline control container after activity-header h3:
   - Range input (slider) for timeline scrubber with id="timeline-scrubber"
   - Play/pause button with id="timeline-play" showing play icon (triangle) initially
   - Position indicator showing current time with id="timeline-position"
   - "Live" indicator that shows when timeline is at present (most recent)

2. Add CSS styles for timeline controls:
   - Timeline container: flex layout, gap 8px, align-items center
   - Scrubber: width 120px, similar styling to heat-decay-slider (4px height, cyan thumb)
   - Play button: 24x24px, circular, similar style to other toolbar buttons
   - Position text: 11px, color #888, min-width 50px
   - Live indicator: small green dot or "LIVE" text when at most recent position

In renderer.js:
1. Add state variables near other activity state (line ~91):
   - let timelinePosition = null; // null = live mode (tracking latest), number = historical timestamp
   - let isTimelinePlaying = false;
   - let playbackInterval = null;
   - const PLAYBACK_SPEED = 500; // ms between steps during playback

2. Add helper function getTimelineRange() that returns {min, max} timestamps from activityEntries (or {min: Date.now(), max: Date.now()} if empty)

3. Add updateTimelineUI() function to sync slider value and position display with current timelinePosition
  </action>
  <verify>
Run `npm run dev` and verify:
- Timeline controls appear in activity panel header
- Slider is visible and draggable
- Play button is visible
- Position indicator shows time text
- Live indicator visible when at latest position
  </verify>
  <done>Timeline UI controls are visible in activity panel header with proper styling matching existing UI patterns</done>
</task>

<task type="auto">
  <name>Task 2: Implement Timeline Scrubber and Playback Logic</name>
  <files>src/renderer/renderer.js</files>
  <action>
Wire up timeline controls with event handlers and playback logic:

1. Add timeline scrubber input handler:
   - On input: Update timelinePosition to timestamp corresponding to slider value
   - Map slider value (0-100) to timestamp range from getTimelineRange()
   - Update timeline position display
   - Call updateGraphForTimeline() (implemented in Task 3)
   - When slider at max (100), set timelinePosition = null (live mode)

2. Add play/pause button click handler:
   - Toggle isTimelinePlaying state
   - Update button icon (pause icon when playing, play icon when paused)
   - If starting playback:
     - If at live position, jump to oldest entry first
     - Start interval that increments timelinePosition to next activity timestamp every PLAYBACK_SPEED ms
     - Call updateGraphForTimeline() on each step
   - If stopping: Clear the playback interval

3. Add playbackStep() function:
   - Find next activity entry after current timelinePosition
   - If found, update timelinePosition to that entry's timestamp
   - If no more entries, stop playback and set to live mode
   - Update slider position to match current timeline position
   - Call updateGraphForTimeline()

4. Add setTimelineToLive() helper:
   - Set timelinePosition = null
   - Update slider to max
   - Update position display to show "Live"
   - Stop any playback

5. When new activity arrives (in onFilesChanged handler):
   - If in live mode (timelinePosition === null), timeline stays at live
   - If in historical mode, don't auto-advance (let user control)
   - Update slider range to include new entry
  </action>
  <verify>
Run `npm run dev` and test:
- Moving slider changes position indicator time
- Slider at max shows "Live" in position indicator
- Clicking play starts automatic progression through history
- Clicking pause stops progression
- Playback stops automatically when reaching present
- New file changes update timeline range
  </verify>
  <done>Timeline scrubber navigates through history, play/pause controls work, playback auto-advances through activity entries</done>
</task>

<task type="auto">
  <name>Task 3: Implement Graph State Filtering for Timeline Position</name>
  <files>src/renderer/renderer.js</files>
  <action>
Implement graph updates based on timeline position:

1. Add updateGraphForTimeline() function:
   - If timelinePosition === null (live mode): Show all current nodes normally
   - If timelinePosition is a timestamp:
     a. Filter activityEntries to only entries <= timelinePosition
     b. Build a "file state" map: for each file path, track if it exists (was created/modified but not deleted at that point)
     c. For each node in the graph:
        - If it's a file node and path exists in activity history:
          - If file "exists" at timelinePosition: Show normally (full opacity)
          - If file was deleted before timelinePosition: Show faded (30% opacity) or hide
          - If file wasn't created yet at timelinePosition: Hide or show very faded
        - Non-file nodes (phases, plans, etc.): Always show normally

2. Implement getFileStateAtTime(timestamp) function:
   - Iterate through activityEntries (sorted by timestamp)
   - Build map of file path -> state (exists: true/false)
   - For entries with timestamp <= provided timestamp:
     - 'add' event -> file exists
     - 'change' event -> file exists
     - 'unlink' event -> file does not exist
   - Return the map

3. Update node opacity based on timeline:
   - Find the Three.js node meshes and adjust their material.opacity
   - Or use a CSS class approach if using HTML labels
   - Files not yet created: opacity 0.1
   - Files deleted: opacity 0.3
   - Files existing: opacity 1.0

4. Add visual feedback when in timeline mode:
   - Show a subtle overlay or border indicating "viewing history"
   - Dim the current activity panel entries that are "in the future"
   - Optionally highlight the specific entry being viewed

5. Ensure going back to live mode restores full graph state:
   - Call updateGraphForTimeline() when setTimelineToLive() is called
   - Restore all node opacities to normal
  </action>
  <verify>
Run `npm run dev` and test:
- Create some test files, modify them, delete one
- Use timeline scrubber to go back in time
- Verify deleted file reappears when scrubbing to before deletion
- Verify new files disappear when scrubbing to before creation
- Verify going to Live mode restores current state
- Verify playback shows files appearing/disappearing correctly
  </verify>
  <done>Graph visually reflects file state at selected timeline position, deleted files reappear in history, future files are hidden/faded</done>
</task>

</tasks>

<verification>
Phase 12 verification checklist:

1. Timeline UI:
   - [ ] Scrubber slider visible in activity panel
   - [ ] Play/pause button functional
   - [ ] Position indicator shows current time or "Live"
   - [ ] Styling consistent with existing UI

2. Timeline Navigation:
   - [ ] Scrubber allows navigating to any point in activity history
   - [ ] Play button starts automatic replay
   - [ ] Pause button stops replay
   - [ ] Reaching present automatically stops playback

3. Graph State:
   - [ ] Files not yet created are hidden/faded at earlier times
   - [ ] Deleted files reappear when viewing time before deletion
   - [ ] Live mode shows current state correctly
   - [ ] Transitions are smooth

4. Integration:
   - [ ] New activity updates timeline range
   - [ ] Timeline works with empty activity (degrades gracefully)
   - [ ] No console errors during operation
</verification>

<success_criteria>
1. TML-01 satisfied: Timeline scrubber allows navigating backward/forward through activity history
2. TML-02 satisfied: Graph state updates to reflect file state at selected point in time (files appear/disappear based on timeline position)
3. TML-03 satisfied: Timeline has play/pause controls for automatic activity replay
4. App remains responsive during timeline operations
5. Timeline feature integrates cleanly with existing activity panel
</success_criteria>

<output>
After completion, create `.planning/phases/12-timeline-replay/12-01-SUMMARY.md`
</output>

---
phase: 18-smooth-activity-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
autonomous: true

must_haves:
  truths:
    - "New files appear in graph without rebuilding entire structure"
    - "Modified files update in place without moving other nodes"
    - "Camera stays exactly where user positioned it during file changes"
    - "Selected node remains selected after graph updates"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Incremental graph update logic with camera preservation"
      contains: "applyIncrementalUpdate"
  key_links:
    - from: "onFilesChanged handler"
      to: "applyIncrementalUpdate"
      via: "direct call instead of loadProject"
      pattern: "applyIncrementalUpdate"
    - from: "applyIncrementalUpdate"
      to: "Graph.cameraPosition"
      via: "save before update, restore after"
      pattern: "cameraPosition\\(\\)"
---

<objective>
Implement incremental graph updates that add/remove/update nodes without rebuilding the entire graph, while preserving camera position.

Purpose: Currently, every file change triggers a full graph rebuild via loadProject() which resets the camera to zoomToFit position and disrupts the user's view. This phase changes the file change handler to perform surgical updates to the graph data.

Output: Modified renderer.js with applyIncrementalUpdate() function that handles file create/modify/delete events without full rebuild.
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incremental graph update function</name>
  <files>src/renderer/renderer.js</files>
  <action>
Create a new function `applyIncrementalUpdate(changeEvent)` that handles file changes incrementally:

1. **For file create events:**
   - Parse the new file path to determine sourceType (planning or src)
   - Build the node object with same structure as buildGraphFromProject uses
   - Build the node ID using same pattern: `{sourceType}-file-{path}` or `{sourceType}-dir-{path}`
   - Add the new node to currentGraphData.nodes array
   - Add link to parent directory node
   - Call Graph.graphData(currentGraphData) to update

2. **For file modify events:**
   - Find the existing node by ID in currentGraphData.nodes
   - Update any properties that may have changed (nothing structural for modify)
   - No graphData call needed for modify - the node object is already in the array
   - (Keep existing flashNodeWithType call for visual feedback)

3. **For file delete events:**
   - Find the node by ID in currentGraphData.nodes
   - Remove the node from the array
   - Remove any links where this node is source or target
   - Call Graph.graphData(currentGraphData) to update
   - (Fade animation handled separately in Plan 03)

4. **Camera preservation:**
   - Before any graphData() call, save camera position: `const camPos = Graph.cameraPosition();`
   - After graphData() call, restore camera position: `Graph.cameraPosition(camPos.x, camPos.y, camPos.z, 0);` (0ms = instant)

5. **Helper function `buildFileNode(filePath, sourceType)`:**
   - Returns node object matching buildGraphFromProject structure
   - Extracts name from path, determines if directory or file, sets extension
   - Uses consistent ID generation: `${sourceType}-file-${path}` or `${sourceType}-dir-${path}`

Important: Do NOT call loadProject() for file change events anymore. Only call loadProject() for:
- Initial project load
- Manual refresh button
- Recent project selection
- Folder selection

Keep the existing activity feed, heat tracking, and flash animation logic intact - they should continue to work alongside the incremental updates.
  </action>
  <verify>
Run `npm run build` to verify no syntax errors. Manually test by:
1. Opening a project in the app
2. Navigating camera to a specific position
3. Creating a new file in src/ directory
4. Verifying: new node appears AND camera position unchanged
  </verify>
  <done>
File changes trigger incremental updates via applyIncrementalUpdate() instead of full loadProject() rebuild. Camera position preserved during updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update onFilesChanged handler to use incremental updates</name>
  <files>src/renderer/renderer.js</files>
  <action>
Modify the existing `onFilesChanged` handler (around line 3507-3540) to call the new incremental update function:

**Current flow (replace):**
```javascript
window.electronAPI.onFilesChanged(async (data) => {
  // ... activity feed stuff ...
  showRefreshIndicator();
  await loadProject(selectedProjectPath);  // <-- Full rebuild (REMOVE)
  await fetchGitStatus(selectedProjectPath);
});
```

**New flow:**
```javascript
window.electronAPI.onFilesChanged(async (data) => {
  console.log('Files changed:', data.event, data.path, 'sourceType:', data.sourceType);
  if (selectedProjectPath) {
    // Add to activity feed and get entry with mapped event type
    const entry = addActivityEntry(data.event, data.path, data.sourceType);

    // Flash the node with type-appropriate animation
    if (entry.nodeId) {
      flashNodeWithType(entry.nodeId, entry.event);
      flashTreeItem(entry.nodeId, entry.event);
    }

    // Check if the changed file is currently shown in details panel
    if (selectedNode && selectedNode.type === 'file' && entry.nodeId === selectedNode.id) {
      refreshDiffSection();
    }

    // Update timeline UI
    if (timelinePosition === null) {
      updateTimelineUI();
    }

    // Apply incremental graph update (instead of full rebuild)
    applyIncrementalUpdate({
      event: data.event,      // 'add', 'change', 'unlink', 'addDir', 'unlinkDir'
      path: data.path,
      sourceType: data.sourceType
    });

    // Update tree panel for new/deleted files
    if (data.event === 'add' || data.event === 'addDir' || data.event === 'unlink' || data.event === 'unlinkDir') {
      // Rebuild tree data from storedDirectoryData (updated by applyIncrementalUpdate)
      treeData = buildTreeStructure(storedDirectoryData);
      updateTreePanel();
    }

    // Refresh git status (lightweight, doesn't rebuild graph)
    await fetchGitStatus(selectedProjectPath);
  }
});
```

Also update `storedDirectoryData` in applyIncrementalUpdate when files are added/removed so the tree stays in sync.
  </action>
  <verify>
Run `npm run build`. Test by:
1. Open project, position camera at custom angle
2. Create a file with `touch test-file.js` in src/
3. Verify: node appears, camera unmoved, tree panel updates
4. Delete the file with `rm test-file.js`
5. Verify: node removed, camera unmoved, tree panel updates
  </verify>
  <done>
onFilesChanged handler uses applyIncrementalUpdate instead of loadProject. Tree panel updates for add/delete events.
  </done>
</task>

<task type="auto">
  <name>Task 3: Preserve selected node reference across updates</name>
  <files>src/renderer/renderer.js</files>
  <action>
Ensure the selectedNode reference remains valid after incremental updates:

1. **In applyIncrementalUpdate, after modifying currentGraphData:**
   - If selectedNode exists, find the updated node object by ID
   - Update selectedNode reference to point to the new object: `selectedNode = currentGraphData.nodes.find(n => n.id === selectedNode.id);`
   - This ensures the details panel and other UI stays connected to the correct node

2. **Handle deleted node case:**
   - If selectedNode was the deleted node, close the details panel gracefully
   - Call `hideDetailsPanel()` if `selectedNode.id === deletedNodeId`

3. **For modify events:**
   - The node object is the same reference, so no action needed
   - But if we ever replace the object, update the reference

Add a helper function `updateSelectedNodeReference()` that:
- Checks if selectedNode exists
- Finds the node by ID in currentGraphData.nodes
- Updates the reference or clears if not found
  </action>
  <verify>
Test by:
1. Open project, click a file node to open details panel
2. Modify that file externally (add a line)
3. Verify: details panel stays open, diff section updates
4. Delete that file externally
5. Verify: details panel closes gracefully, no errors in console
  </verify>
  <done>
Selected node reference persists through incremental updates. Deleting selected file closes details panel gracefully.
  </done>
</task>

</tasks>

<verification>
1. Create a new file while viewing the graph - node appears without camera movement
2. Modify a file while it's selected - details panel stays open and updates
3. Delete a file - node disappears, camera stays put
4. No errors in developer console during any operation
5. Activity feed continues to show all file change events
6. Flash animations continue to work for all change types
</verification>

<success_criteria>
- File create: New node appears in graph instantly without rebuilding other nodes
- File modify: Node updates in place, no visual disruption to graph
- File delete: Node removed from graph (fade animation in Plan 03)
- Camera position: Exactly preserved across all update types
- Selected node: Remains selected and functional after updates
- No regression: Activity feed, flash animations, heat tracking all still work
</success_criteria>

<output>
After completion, create `.planning/phases/18-smooth-activity-updates/18-01-SUMMARY.md`
</output>

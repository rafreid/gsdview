---
phase: 22-bookmarks-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "Back button navigates to previously visited node (like browser back button)"
    - "Forward button navigates forward through navigation history"
    - "Recent nodes dropdown shows last 10 visited nodes for quick return"
    - "Navigation history persists across app restarts"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Navigation history tracking and controls"
      contains: "navigationHistory"
    - path: "src/renderer/index.html"
      provides: "Navigation history UI elements"
      contains: "nav-back"
  key_links:
    - from: "showDetailsPanel"
      to: "navigationHistory"
      via: "pushes node to history on selection"
      pattern: "pushNavigationHistory|navigationHistory.*push"
    - from: "nav-back button"
      to: "navigateBack function"
      via: "click event"
      pattern: "nav-back.*addEventListener"
    - from: "nav-forward button"
      to: "navigateForward function"
      via: "click event"
      pattern: "nav-forward.*addEventListener"
    - from: "window.electronAPI.store"
      to: "navigationHistory"
      via: "persistence on change"
      pattern: "store\\.(get|set).*navigationHistory"
    - from: "keydown listener"
      to: "navigateBack/navigateForward"
      via: "Alt+Left/Right keyboard shortcuts"
      pattern: "altKey.*Arrow(Left|Right).*navigate(Back|Forward)"
---

<objective>
Implement browser-style navigation history with back/forward buttons and recent nodes dropdown.

Purpose: Users often explore multiple nodes and need to retrace their steps. Navigation history provides familiar browser-like back/forward navigation and quick access to recently visited nodes.

Output: Navigation controls in toolbar with back/forward buttons and dropdown showing last 10 visited nodes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js (selectedNode at line 85, showDetailsPanel at line 3133, flyToNodeSmooth at line 1543, zoom button patterns at lines 5809-5815)
@src/renderer/index.html (toolbar at lines 2324-2373, zoom-presets styling pattern at lines 1041-1087)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Navigation history state and logic</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add navigation history tracking logic:

1. Add state variables near other navigation state (around line 90, after selectedNode):
```javascript
// Navigation history (browser-style back/forward)
let navigationHistory = [];      // Stack of visited node IDs
let navigationIndex = -1;        // Current position in history (-1 = none)
const MAX_HISTORY_SIZE = 50;     // Limit to prevent memory bloat
let isNavigating = false;        // Flag to prevent history push during back/forward
```

2. Add helper function to push to navigation history (after the state variables):
```javascript
// Push node to navigation history (called when user selects a node)
function pushNavigationHistory(nodeId) {
  // Don't push if we're navigating via back/forward
  if (isNavigating) return;

  // Don't push duplicate of current position
  if (navigationHistory[navigationIndex] === nodeId) return;

  // If we navigated back and then select new node, truncate forward history
  if (navigationIndex < navigationHistory.length - 1) {
    navigationHistory = navigationHistory.slice(0, navigationIndex + 1);
  }

  // Add new entry
  navigationHistory.push(nodeId);
  navigationIndex = navigationHistory.length - 1;

  // Trim if exceeds max size (remove oldest)
  if (navigationHistory.length > MAX_HISTORY_SIZE) {
    navigationHistory.shift();
    navigationIndex--;
  }

  // Update UI state
  updateNavigationButtonStates();
  updateRecentNodesDropdown();

  // Persist to store (async, non-blocking)
  saveNavigationHistory();
}
```

3. Add back/forward navigation functions:
```javascript
// Navigate back in history
function navigateBack() {
  if (navigationIndex <= 0) return;

  isNavigating = true;
  navigationIndex--;
  const nodeId = navigationHistory[navigationIndex];

  // Find and navigate to node
  const node = currentGraphData?.nodes?.find(n => n.id === nodeId);
  if (node) {
    flyToNodeSmooth(nodeId, 80);
    showDetailsPanel(node);
  }

  updateNavigationButtonStates();
  updateRecentNodesDropdown();
  isNavigating = false;

  console.log('[Nav] Back to:', nodeId, 'index:', navigationIndex);
}

// Navigate forward in history
function navigateForward() {
  if (navigationIndex >= navigationHistory.length - 1) return;

  isNavigating = true;
  navigationIndex++;
  const nodeId = navigationHistory[navigationIndex];

  // Find and navigate to node
  const node = currentGraphData?.nodes?.find(n => n.id === nodeId);
  if (node) {
    flyToNodeSmooth(nodeId, 80);
    showDetailsPanel(node);
  }

  updateNavigationButtonStates();
  updateRecentNodesDropdown();
  isNavigating = false;

  console.log('[Nav] Forward to:', nodeId, 'index:', navigationIndex);
}
```

4. Add button state update function:
```javascript
// Update navigation button enabled/disabled states
function updateNavigationButtonStates() {
  const backBtn = document.getElementById('nav-back');
  const forwardBtn = document.getElementById('nav-forward');

  if (backBtn) {
    if (navigationIndex > 0) {
      backBtn.classList.remove('disabled');
    } else {
      backBtn.classList.add('disabled');
    }
  }

  if (forwardBtn) {
    if (navigationIndex < navigationHistory.length - 1) {
      forwardBtn.classList.remove('disabled');
    } else {
      forwardBtn.classList.add('disabled');
    }
  }
}
```

5. Add recent nodes dropdown update function:
```javascript
// Update recent nodes dropdown with last 10 visited
function updateRecentNodesDropdown() {
  const dropdown = document.getElementById('recent-nodes');
  if (!dropdown) return;

  // Get last 10 unique node IDs (most recent first)
  const recentIds = [];
  for (let i = navigationHistory.length - 1; i >= 0 && recentIds.length < 10; i--) {
    const nodeId = navigationHistory[i];
    if (!recentIds.includes(nodeId)) {
      recentIds.push(nodeId);
    }
  }

  // Build dropdown options
  let html = '<option value="">Recent nodes...</option>';
  recentIds.forEach(nodeId => {
    const node = currentGraphData?.nodes?.find(n => n.id === nodeId);
    if (node) {
      // Extract display name (last part of path or node name)
      const displayName = node.name || nodeId.split('/').pop() || nodeId;
      const truncated = displayName.length > 25 ? displayName.substring(0, 22) + '...' : displayName;
      html += `<option value="${nodeId}">${truncated}</option>`;
    }
  });

  dropdown.innerHTML = html;
}
```

6. Add persistence functions:
```javascript
// Save navigation history to electron-store
async function saveNavigationHistory() {
  try {
    await window.electronAPI.store.set('navigationHistory', {
      history: navigationHistory,
      index: navigationIndex
    });
  } catch (err) {
    console.log('[Nav] Could not save history:', err);
  }
}

// Load navigation history from electron-store
async function loadNavigationHistory() {
  try {
    const saved = await window.electronAPI.store.get('navigationHistory');
    if (saved && Array.isArray(saved.history)) {
      navigationHistory = saved.history;
      navigationIndex = typeof saved.index === 'number' ? saved.index : saved.history.length - 1;
      updateNavigationButtonStates();
      updateRecentNodesDropdown();
      console.log('[Nav] Loaded history:', navigationHistory.length, 'entries, index:', navigationIndex);
    }
  } catch (err) {
    console.log('[Nav] Could not load history:', err);
  }
}
```

7. Modify showDetailsPanel function (around line 3133) to push to history:
Find this line in showDetailsPanel:
```javascript
selectedNode = node;
```
Add after it:
```javascript
// Add to navigation history
pushNavigationHistory(node.id);
```

8. Call loadNavigationHistory() in the DOMContentLoaded section (where other load functions are called).
  </action>
  <verify>
Check renderer.js contains:
- navigationHistory and navigationIndex variables
- pushNavigationHistory function
- navigateBack and navigateForward functions
- updateNavigationButtonStates function
- updateRecentNodesDropdown function
- saveNavigationHistory and loadNavigationHistory functions
- showDetailsPanel calls pushNavigationHistory
  </verify>
  <done>Navigation history logic tracks visited nodes with back/forward capability and persistence</done>
</task>

<task type="auto">
  <name>Task 2: Navigation history UI controls</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add navigation controls after zoom-presets (around line 2341):
```html
<div id="nav-controls" title="Navigation history">
  <button id="nav-back" class="nav-btn disabled" title="Go back (Alt+Left)">
    <span>&#9664;</span>
  </button>
  <button id="nav-forward" class="nav-btn disabled" title="Go forward (Alt+Right)">
    <span>&#9654;</span>
  </button>
  <select id="recent-nodes" title="Recent nodes">
    <option value="">Recent nodes...</option>
  </select>
</div>
```

2. Add CSS styles for navigation controls (after zoom preset styles, around line 1088):
```css
/* Navigation History Controls */
#nav-controls {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 12px;
  padding-left: 12px;
  border-left: 1px solid rgba(255, 255, 255, 0.15);
}

.nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 24px;
  background: rgba(78, 205, 196, 0.15);
  border: 1px solid rgba(78, 205, 196, 0.3);
  border-radius: 3px;
  color: rgba(78, 205, 196, 0.8);
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.nav-btn:hover:not(.disabled) {
  background: rgba(78, 205, 196, 0.3);
  border-color: rgba(78, 205, 196, 0.6);
  color: #4ECDC4;
}

.nav-btn:active:not(.disabled) {
  background: rgba(78, 205, 196, 0.4);
  transform: scale(0.95);
}

.nav-btn.disabled {
  opacity: 0.35;
  cursor: not-allowed;
}

.nav-btn span {
  font-size: 12px;
}

#recent-nodes {
  height: 24px;
  padding: 0 8px;
  background: rgba(42, 42, 78, 0.8);
  border: 1px solid rgba(78, 205, 196, 0.3);
  border-radius: 3px;
  color: #ccc;
  font-size: 11px;
  cursor: pointer;
  min-width: 120px;
  max-width: 160px;
}

#recent-nodes:hover {
  border-color: rgba(78, 205, 196, 0.5);
}

#recent-nodes:focus {
  outline: none;
  border-color: #4ECDC4;
}

#recent-nodes option {
  background: #2a2a4e;
  color: #eee;
  padding: 4px;
}
```

3. In renderer.js, add event listeners for navigation controls (near zoom button listeners, around line 5815):
```javascript
// Navigation history controls
document.getElementById('nav-back')?.addEventListener('click', () => {
  navigateBack();
});

document.getElementById('nav-forward')?.addEventListener('click', () => {
  navigateForward();
});

// Recent nodes dropdown selection
document.getElementById('recent-nodes')?.addEventListener('change', (e) => {
  const nodeId = e.target.value;
  if (!nodeId) return;

  // Reset dropdown display
  e.target.value = '';

  // Find and navigate to selected node
  const node = currentGraphData?.nodes?.find(n => n.id === nodeId);
  if (node) {
    flyToNodeSmooth(nodeId, 80);
    showDetailsPanel(node);
  }
});
```

4. Add keyboard shortcuts for back/forward (in the existing keydown handler or create one):
```javascript
// Keyboard shortcuts for navigation (Alt+Left/Right)
document.addEventListener('keydown', (e) => {
  // Alt+Left = Back
  if (e.altKey && e.key === 'ArrowLeft') {
    e.preventDefault();
    navigateBack();
  }
  // Alt+Right = Forward
  if (e.altKey && e.key === 'ArrowRight') {
    e.preventDefault();
    navigateForward();
  }
});
```

5. Initialize navigation button states on startup (in DOMContentLoaded, after loadNavigationHistory):
```javascript
// Initialize navigation controls
updateNavigationButtonStates();
```
  </action>
  <verify>
Run `npm run build` and `npm start`.
1. Navigation controls appear in toolbar (back arrow, forward arrow, dropdown)
2. Initially both buttons are disabled (no history yet)
3. Click on several different nodes - back button becomes enabled
4. Click back - returns to previous node, forward button becomes enabled
5. Click forward - returns to the node you came from
6. Dropdown shows last 10 visited nodes (most recent first)
7. Selecting from dropdown navigates to that node
8. Alt+Left/Right keyboard shortcuts work
9. Close and reopen app - history is preserved
  </verify>
  <done>Navigation history UI controls work with back/forward buttons, dropdown, and keyboard shortcuts</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. App launches: `npm start`
3. Navigation controls visible in toolbar with cyan theme
4. Click several nodes - back button enables
5. Click back - navigates to previous node, forward enables
6. Click forward - returns to next node in history
7. Dropdown shows last 10 unique nodes visited
8. Selecting dropdown item navigates to that node
9. Alt+Left and Alt+Right keyboard shortcuts work
10. History persists across app restart
11. Selecting new node after going back truncates forward history (browser behavior)
</verification>

<success_criteria>
- Back button navigates to previously visited node
- Forward button navigates forward through history
- Recent nodes dropdown shows last 10 visited nodes
- Buttons disabled appropriately (back when at start, forward when at end)
- Keyboard shortcuts Alt+Left/Right work
- History persists via electron-store
</success_criteria>

<output>
After completion, create `.planning/phases/22-bookmarks-history/22-01-SUMMARY.md`
</output>

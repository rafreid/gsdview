---
phase: 10-git-integration
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "Recent commits appear as nodes in the graph"
    - "Current branch name is visible in the UI header"
    - "Commit nodes show hash and message"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Commit nodes and branch display"
      contains: "gitCommits"
    - path: "src/renderer/index.html"
      provides: "Branch display element in toolbar"
      contains: "branch-display"
  key_links:
    - from: "src/renderer/renderer.js"
      to: "buildGraphFromProject"
      via: "adds commit nodes to graph"
      pattern: "type: 'commit'"
---

<objective>
Add commit nodes to the graph and display the current branch in the UI header.

Purpose: GIT-03 and GIT-04 requirements - users need to see recent commits as nodes and know which branch they're on.
Output: Commit nodes in the graph with hash/message, branch name displayed in toolbar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-git-integration/10-01-SUMMARY.md
@src/renderer/renderer.js
@src/renderer/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add branch display to UI header</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add branch display element in the toolbar (after the heat-decay-container div, before selected-path span):

```html
<div id="branch-display" title="Current git branch">
  <span class="branch-icon">‚éá</span>
  <span id="branch-name">‚Äî</span>
</div>
```

2. Add CSS styles for the branch display (in the style section, after the heat-decay styles):

```css
/* Git Branch Display */
#branch-display {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(46, 204, 113, 0.15);
  border: 1px solid rgba(46, 204, 113, 0.4);
  border-radius: 4px;
  font-size: 12px;
  color: #2ECC71;
}

#branch-display .branch-icon {
  font-size: 14px;
}

#branch-name {
  max-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

#branch-display.no-branch {
  opacity: 0.5;
  color: #888;
  background: rgba(128, 128, 128, 0.15);
  border-color: rgba(128, 128, 128, 0.4);
}
```

3. In renderer.js, add git branch state variable (near gitStatusData):
```javascript
let currentBranch = null;
```

4. Add function to fetch and display branch (near fetchGitStatus):
```javascript
// Fetch and display current git branch
async function fetchGitBranch(projectPath) {
  if (!window.electronAPI || !window.electronAPI.getGitBranch) {
    console.log('[Git] Branch API not available');
    return;
  }

  const branchDisplay = document.getElementById('branch-display');
  const branchName = document.getElementById('branch-name');

  try {
    const result = await window.electronAPI.getGitBranch(projectPath);
    if (result && result.branch && !result.error) {
      currentBranch = result.branch;
      branchName.textContent = result.branch;
      branchDisplay.classList.remove('no-branch');
      branchDisplay.title = `Current branch: ${result.branch}`;
      console.log('[Git] Branch:', result.branch);
    } else {
      currentBranch = null;
      branchName.textContent = 'not a git repo';
      branchDisplay.classList.add('no-branch');
      branchDisplay.title = 'Not a git repository';
    }
  } catch (err) {
    console.error('[Git] Error fetching branch:', err);
    currentBranch = null;
    branchName.textContent = '‚Äî';
    branchDisplay.classList.add('no-branch');
  }
}
```

5. Call fetchGitBranch in loadProject (after fetchGitStatus call):
```javascript
// Fetch git branch for the project
await fetchGitBranch(projectPath);
```
  </action>
  <verify>
Run `npm run build && npm start`, select a git project. Verify the branch name appears in the toolbar with a green branch icon. For non-git directories, it should show "not a git repo" in gray.
  </verify>
  <done>
GIT-04: Current branch name is visible in the UI header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add commit nodes to the graph</name>
  <files>src/renderer/renderer.js</files>
  <action>
1. Add commit state and color (near gitStatusData and gitStatusColors):
```javascript
let gitCommitsData = [];

// Add to nodeColors object:
// commit: '#9B59B6',  // Purple - git commits
```

Actually, add commit to the existing nodeColors object definition (around line 8):
```javascript
commit: '#9B59B6',     // Purple - git commits
```

2. Add function to fetch commits (near fetchGitBranch):
```javascript
// Fetch recent git commits
async function fetchGitCommits(projectPath, limit = 10) {
  if (!window.electronAPI || !window.electronAPI.getGitCommits) {
    console.log('[Git] Commits API not available');
    return;
  }

  try {
    const result = await window.electronAPI.getGitCommits(projectPath, limit);
    if (result && result.commits && !result.error) {
      gitCommitsData = result.commits;
      console.log('[Git] Commits loaded:', gitCommitsData.length);
    } else {
      gitCommitsData = [];
    }
  } catch (err) {
    console.error('[Git] Error fetching commits:', err);
    gitCommitsData = [];
  }
}
```

3. Call fetchGitCommits in loadProject (after fetchGitBranch):
```javascript
// Fetch recent commits
await fetchGitCommits(projectPath, 10);
```

4. Modify buildGraphFromProject to add commit nodes (after processing directory structure, around line 1060, before the blocker links section):

```javascript
// Process git commits
if (gitCommitsData && gitCommitsData.length > 0) {
  // Add git commits parent node
  const gitNode = addNode({
    id: 'git-commits',
    name: 'Recent Commits',
    type: 'directory',  // Use directory type for grouping
    description: `Last ${gitCommitsData.length} commits`
  });

  // Link to project root
  addLink(projectNode.id, gitNode.id, 'contains');

  // Add individual commit nodes
  gitCommitsData.forEach((commit, index) => {
    const commitNode = addNode({
      id: `commit-${commit.hash}`,
      name: commit.hash.substring(0, 7),
      type: 'commit',
      description: commit.message,
      hash: commit.hash,
      fullMessage: commit.message
    });

    addLink(gitNode.id, commitNode.id, 'contains');
  });
}
```

5. Update nodeThreeObject to handle commit nodes (add a case for 'commit' type, around line 850, before the default return):

```javascript
// Commit nodes: small hexagonal shape
if (node.type === 'commit') {
  const geometry = new THREE.CylinderGeometry(size * 0.6, size * 0.6, size * 0.4, 6);
  const material = new THREE.MeshBasicMaterial({
    color: nodeColors.commit,
    transparent: true,
    opacity: 0.85
  });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.name = node.id;

  // Rotate to show hexagonal face
  mesh.rotation.x = Math.PI / 2;

  // Add wireframe for clarity
  const edges = new THREE.EdgesGeometry(geometry);
  const lineMaterial = new THREE.LineBasicMaterial({
    color: 0xffffff,
    opacity: 0.5,
    transparent: true
  });
  const wireframe = new THREE.LineSegments(edges, lineMaterial);
  wireframe.rotation.x = Math.PI / 2;
  mesh.add(wireframe);

  return mesh;
}
```

6. Update tooltip for commit nodes (in onNodeHover, add handling for commit type):
Add this after the directory/file type display section:
```javascript
} else if (node.type === 'commit') {
  content += 'üìù Commit';
  if (node.hash) {
    content += `<br><code style="font-family: monospace;">${node.hash.substring(0, 7)}</code>`;
  }
```

7. Update showDetailsPanel for commit nodes (in the function around line 1350, add handling):
After the existing status handling, add:
```javascript
if (node.type === 'commit') {
  html += `<p><strong>Commit Hash:</strong> <code>${node.hash}</code></p>`;
  if (node.fullMessage) {
    html += `<p><strong>Message:</strong><br>${node.fullMessage}</p>`;
  }
}
```
  </action>
  <verify>
Run `npm run build && npm start`, select a git project with commit history. Verify:
1. "Recent Commits" node appears connected to project root
2. Individual commit nodes (purple hexagons) are visible
3. Hovering shows commit hash
4. Clicking shows full commit details in panel
  </verify>
  <done>
GIT-03: Recent commits appear as nodes in the graph showing bundled changes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add commit type to color legend</name>
  <files>src/renderer/renderer.js</files>
  <action>
The commit color was added to nodeColors, which is already iterated in populateColorLegend. Verify it appears.

If not showing (nodeColors iteration might be filtered), explicitly add commit to the legend in populateColorLegend:

Check if the "Node Types" section loop includes 'commit'. If nodeColors already has commit added, it should automatically appear.

If needed, verify nodeColors object includes:
```javascript
commit: '#9B59B6',     // Purple - git commits
```
  </action>
  <verify>
Run `npm run build && npm start`, expand the color legend. Verify "Commit" type appears in the Node Types section with purple color.
  </verify>
  <done>
Color legend includes commit node type.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build && npm start`
2. Select a git repository with commit history
3. Verify:
   - Branch name shows in toolbar (green, with branch icon)
   - "Recent Commits" node group appears in graph
   - Individual commit nodes (purple hexagons) are visible
   - Hovering over commits shows hash and message preview
   - Clicking commit node shows full details in panel
   - Color legend has "Commit" type entry
4. Test with non-git directory - branch shows "not a git repo", no commit nodes appear
</verification>

<success_criteria>
- GIT-03: Recent commits appear as nodes in the graph showing bundled changes - DONE
- GIT-04: Current branch name is visible in the UI header - DONE
- Commit nodes are distinguishable (purple hexagonal shape)
- Branch indicator provides clear visual feedback
</success_criteria>

<output>
After completion, create `.planning/phases/10-git-integration/10-03-SUMMARY.md`
</output>

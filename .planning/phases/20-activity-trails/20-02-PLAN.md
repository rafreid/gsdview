---
phase: 20-activity-trails
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User can configure trail fade duration via slider"
    - "Trails have distinct visual style that doesn't interfere with graph edges"
    - "Trail settings persist across sessions"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Trail configuration and enhanced visuals"
      contains: "trailFadeDuration"
    - path: "src/renderer/index.html"
      provides: "Trail duration slider in toolbar"
      contains: "trail-duration-slider"
  key_links:
    - from: "trail-duration-slider"
      to: "trailFadeDuration variable"
      via: "slider input event handler"
      pattern: "trailFadeDuration\\s*="
    - from: "trailFadeDuration"
      to: "updateTrailOpacities"
      via: "opacity calculation uses duration"
      pattern: "trailFadeDuration"
---

<objective>
Add configurable trail duration and enhance trail visual styling to be clearly distinct from graph edges.

Purpose: Users need control over how long trails persist, and trails must be visually distinct from the normal graph structure so they don't cause confusion.

Output: Trail duration slider, dashed/curved trail lines, and polished visual integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-activity-trails/20-01-SUMMARY.md
@src/renderer/renderer.js (heat decay slider pattern at lines 268-288)
@src/renderer/index.html (slider styling at lines 1041-1085)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configurable trail fade duration</name>
  <files>src/renderer/renderer.js, src/renderer/index.html</files>
  <action>
1. In renderer.js, make TRAIL_MAX_AGE configurable:
   - Rename TRAIL_MAX_AGE to DEFAULT_TRAIL_DURATION = 60000
   - Add `let trailFadeDuration = DEFAULT_TRAIL_DURATION;`

2. In index.html, add trail duration slider after trails-toggle button:
```html
<div id="trail-duration-container" title="Trail fade duration (seconds)">
  <span id="trail-duration-label">Duration:</span>
  <input type="range" id="trail-duration-slider" min="15" max="180" value="60" step="5">
  <span id="trail-duration-value">1m</span>
</div>
```

3. Add CSS for trail duration slider (similar to heat-decay-slider styles):
```css
#trail-duration-container {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 10px;
}

#trail-duration-label {
  font-size: 12px;
  color: rgba(255,255,255,0.8);
  white-space: nowrap;
}

#trail-duration-slider {
  width: 80px;
  height: 4px;
  -webkit-appearance: none;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}

#trail-duration-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #4ECDC4;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.2s;
}

#trail-duration-slider::-webkit-slider-thumb:hover {
  background: #5ddfd6;
}

#trail-duration-value {
  font-size: 11px;
  color: rgba(255,255,255,0.6);
  min-width: 25px;
}
```

4. In renderer.js, add slider event handler:
```javascript
// Format trail duration for display
function formatTrailDuration(seconds) {
  if (seconds < 60) return `${seconds}s`;
  const minutes = Math.round(seconds / 60);
  return `${minutes}m`;
}

// Trail duration slider handler
document.getElementById('trail-duration-slider')?.addEventListener('input', async (e) => {
  const seconds = parseInt(e.target.value, 10);
  trailFadeDuration = seconds * 1000; // Convert to ms

  // Update display
  const valueDisplay = document.getElementById('trail-duration-value');
  if (valueDisplay) valueDisplay.textContent = formatTrailDuration(seconds);

  // Save to store
  try {
    await window.electronAPI.store.set('trailFadeDuration', seconds);
  } catch (err) {
    console.log('[Trails] Could not save duration setting:', err);
  }
});
```

5. Create loadTrailSettings function and call it during initialization:
```javascript
async function loadTrailSettings() {
  try {
    // Load trail enabled state
    const enabled = await window.electronAPI.store.get('activityTrailsEnabled');
    if (typeof enabled === 'boolean') {
      activityTrailsEnabled = enabled;
      const btn = document.getElementById('trails-toggle');
      if (btn) {
        if (enabled) btn.classList.add('active');
        else btn.classList.remove('active');
      }
    }

    // Load trail duration
    const savedDuration = await window.electronAPI.store.get('trailFadeDuration');
    if (savedDuration && typeof savedDuration === 'number') {
      trailFadeDuration = savedDuration * 1000;
      const slider = document.getElementById('trail-duration-slider');
      const valueDisplay = document.getElementById('trail-duration-value');
      if (slider) slider.value = savedDuration;
      if (valueDisplay) valueDisplay.textContent = formatTrailDuration(savedDuration);
    }
  } catch (err) {
    console.log('[Trails] Using default trail settings');
  }
}
```

6. Call loadTrailSettings() alongside loadFlashSettings() during app initialization
  </action>
  <verify>
Run `npm run build` and `npm start`.
Verify slider appears and adjusts trail duration.
Change setting, restart app, verify setting persists.
  </verify>
  <done>Trail fade duration is user-configurable via slider and persists</done>
</task>

<task type="auto">
  <name>Task 2: Enhanced trail visual styling</name>
  <files>src/renderer/renderer.js</files>
  <action>
Enhance trail visuals to be clearly distinct from graph edges:

1. Update createActivityTrail to use LineDashedMaterial instead of LineBasicMaterial:
```javascript
function createActivityTrail(fromNodeId, toNodeId) {
  const fromNode = currentGraphData.nodes.find(n => n.id === fromNodeId);
  const toNode = currentGraphData.nodes.find(n => n.id === toNodeId);

  if (!fromNode || !toNode) return null;
  if (fromNode.x === undefined || toNode.x === undefined) return null;

  // Create geometry with two points
  const geometry = new THREE.BufferGeometry();
  const positions = new Float32Array([
    fromNode.x || 0, fromNode.y || 0, fromNode.z || 0,
    toNode.x || 0, toNode.y || 0, toNode.z || 0
  ]);
  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

  // Use dashed material for clear visual distinction from graph edges
  const material = new THREE.LineDashedMaterial({
    color: 0x4ECDC4,
    opacity: 0.8,
    transparent: true,
    dashSize: 3,
    gapSize: 2,
    linewidth: 2  // Note: linewidth only works with specific renderers
  });

  const line = new THREE.Line(geometry, material);
  line.computeLineDistances(); // Required for dashed lines

  // Add to scene
  const scene = Graph.scene();
  if (scene) {
    scene.add(line);
  }

  const trail = {
    fromNodeId,
    toNodeId,
    timestamp: Date.now(),
    lineObject: line
  };

  activityTrails.push(trail);

  // Trim if too many
  while (activityTrails.length > MAX_TRAILS) {
    const oldest = activityTrails.shift();
    if (oldest && oldest.lineObject) {
      Graph.scene()?.remove(oldest.lineObject);
      oldest.lineObject.geometry?.dispose();
      oldest.lineObject.material?.dispose();
    }
  }

  // Start animation loop if not running
  startTrailAnimationLoop();

  return trail;
}
```

2. Update updateTrailOpacities to use a gradient color scheme:
```javascript
function updateTrailOpacities() {
  const now = Date.now();

  activityTrails.forEach(trail => {
    if (!trail.lineObject || !trail.lineObject.material) return;

    const age = now - trail.timestamp;
    const progress = Math.min(age / trailFadeDuration, 1.0);

    // Opacity fades from 0.8 to 0.1
    const opacity = 0.8 - (progress * 0.7);
    trail.lineObject.material.opacity = Math.max(opacity, 0.1);

    // Color transitions: cyan -> teal -> dim gray
    // 0-33%: bright cyan (0x4ECDC4)
    // 33-66%: teal (0x2E8B8B)
    // 66-100%: dim (0x1A5555)
    let color;
    if (progress < 0.33) {
      color = lerpColor(0x4ECDC4, 0x2E8B8B, progress / 0.33);
    } else if (progress < 0.66) {
      color = lerpColor(0x2E8B8B, 0x1A5555, (progress - 0.33) / 0.33);
    } else {
      color = 0x1A5555;
    }

    trail.lineObject.material.color.setHex(color);
  });
}
```

3. Update updateTrailPositions to properly update dashed line positions:
```javascript
function updateTrailPositions() {
  const trailsToRemove = [];

  activityTrails.forEach(trail => {
    const fromNode = currentGraphData.nodes.find(n => n.id === trail.fromNodeId);
    const toNode = currentGraphData.nodes.find(n => n.id === trail.toNodeId);

    if (!fromNode || !toNode) {
      trailsToRemove.push(trail);
      return;
    }

    if (fromNode.x === undefined || toNode.x === undefined) return;

    const positions = trail.lineObject.geometry.attributes.position;
    positions.setXYZ(0, fromNode.x || 0, fromNode.y || 0, fromNode.z || 0);
    positions.setXYZ(1, toNode.x || 0, toNode.y || 0, toNode.z || 0);
    positions.needsUpdate = true;

    // Recompute line distances for dashed material
    trail.lineObject.computeLineDistances();
  });

  // Remove trails with missing nodes
  trailsToRemove.forEach(trail => {
    const idx = activityTrails.indexOf(trail);
    if (idx !== -1) {
      activityTrails.splice(idx, 1);
      Graph.scene()?.remove(trail.lineObject);
      trail.lineObject.geometry?.dispose();
      trail.lineObject.material?.dispose();
    }
  });
}
```
  </action>
  <verify>
Run `npm run build` and `npm start`.
Create file changes to generate trails.
Verify trails appear as dashed lines (visually distinct from solid graph edges).
Verify trails fade from bright cyan to dim over configured duration.
  </verify>
  <done>Trails have distinctive dashed line style and smooth color/opacity fade</done>
</task>

<task type="auto">
  <name>Task 3: Trail animation loop and cleanup</name>
  <files>src/renderer/renderer.js</files>
  <action>
Implement the complete trail animation loop with proper cleanup:

1. Add trail animation loop state:
```javascript
let trailLoopRunning = false;
let trailLoopRafId = null;
```

2. Implement startTrailAnimationLoop:
```javascript
function startTrailAnimationLoop() {
  if (trailLoopRunning) return;
  if (!activityTrailsEnabled) return;
  if (activityTrails.length === 0) return;

  trailLoopRunning = true;

  function trailLoop() {
    if (!trailLoopRunning || !activityTrailsEnabled) {
      trailLoopRunning = false;
      trailLoopRafId = null;
      return;
    }

    // Update trail visuals
    updateTrailPositions();
    updateTrailOpacities();

    // Cleanup old trails
    cleanupOldTrails();

    // Continue loop if trails exist
    if (activityTrails.length > 0) {
      trailLoopRafId = requestAnimationFrame(trailLoop);
    } else {
      trailLoopRunning = false;
      trailLoopRafId = null;
    }
  }

  trailLoopRafId = requestAnimationFrame(trailLoop);
}
```

3. Implement stopTrailAnimationLoop:
```javascript
function stopTrailAnimationLoop() {
  trailLoopRunning = false;
  if (trailLoopRafId) {
    cancelAnimationFrame(trailLoopRafId);
    trailLoopRafId = null;
  }
}
```

4. Implement cleanupOldTrails:
```javascript
function cleanupOldTrails() {
  const now = Date.now();
  const expiredTrails = activityTrails.filter(
    trail => (now - trail.timestamp) >= trailFadeDuration
  );

  expiredTrails.forEach(trail => {
    const idx = activityTrails.indexOf(trail);
    if (idx !== -1) {
      activityTrails.splice(idx, 1);
      if (trail.lineObject) {
        Graph.scene()?.remove(trail.lineObject);
        trail.lineObject.geometry?.dispose();
        trail.lineObject.material?.dispose();
      }
    }
  });
}
```

5. Implement clearAllTrails (called when toggle is turned off):
```javascript
function clearAllTrails() {
  stopTrailAnimationLoop();

  activityTrails.forEach(trail => {
    if (trail.lineObject) {
      Graph.scene()?.remove(trail.lineObject);
      trail.lineObject.geometry?.dispose();
      trail.lineObject.material?.dispose();
    }
  });

  activityTrails = [];
}
```

6. Update trails-toggle click handler to save state:
```javascript
document.getElementById('trails-toggle')?.addEventListener('click', async () => {
  activityTrailsEnabled = !activityTrailsEnabled;
  const btn = document.getElementById('trails-toggle');

  if (activityTrailsEnabled) {
    btn?.classList.add('active');
  } else {
    btn?.classList.remove('active');
    clearAllTrails();
  }

  // Save state
  try {
    await window.electronAPI.store.set('activityTrailsEnabled', activityTrailsEnabled);
  } catch (err) {
    console.log('[Trails] Could not save enabled state:', err);
  }
});
```

7. Ensure loadTrailSettings is called in the initialization section (find where loadFlashSettings and loadHeatDecaySetting are called and add loadTrailSettings() there)
  </action>
  <verify>
Run `npm run build` and `npm start`.
Test complete trail lifecycle:
1. Enable trails (toggle on)
2. Make file changes - trails appear connecting changed files
3. Wait for trails to fade and disappear automatically
4. Toggle trails off - all trails clear immediately
5. Restart app - toggle state and duration setting persist
  </verify>
  <done>Complete trail animation loop with proper cleanup and state persistence</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. App launches: `npm start`
3. Trail duration slider visible and functional
4. Trails appear as dashed lines (distinct from graph edges)
5. Trails fade smoothly through color gradient
6. Old trails automatically clean up
7. Toggle off clears all trails
8. All settings persist across app restart
</verification>

<success_criteria>
- TRL-01: Visual trails show recent activity flow through graph
- TRL-02: Trail intensity fades over time (recent = bright, older = dim)
- TRL-03: User can toggle activity trails on/off
- Trail duration is configurable
- Trails are visually distinct from graph edges (dashed vs solid)
- No memory leaks from trail objects
</success_criteria>

<output>
After completion, create `.planning/phases/20-activity-trails/20-02-SUMMARY.md`
</output>

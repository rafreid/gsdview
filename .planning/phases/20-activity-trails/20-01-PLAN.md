---
phase: 20-activity-trails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "Activity trails connect recently changed files in chronological order"
    - "Trail intensity fades based on age (recent = bright, older = dim)"
    - "Trails automatically fade and disappear after configurable time"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Activity trail state management and rendering"
      contains: "activityTrails"
    - path: "src/renderer/index.html"
      provides: "Trail toggle button in UI"
      contains: "trails-toggle"
  key_links:
    - from: "activityEntries"
      to: "activityTrails array"
      via: "addActivityEntry triggers trail creation"
      pattern: "activityTrails\\.push"
    - from: "activityTrails"
      to: "THREE.js Line objects"
      via: "renderActivityTrails function"
      pattern: "THREE\\.Line"
---

<objective>
Implement activity trail system that visually connects recently changed files in chronological order.

Purpose: Allow users to see the flow of recent activity through the graph - understanding which files were changed in sequence helps visualize work patterns and dependencies.

Output: Working activity trails that connect changed file nodes with fading lines, plus toggle button to enable/disable.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js (activity tracking at lines 91-93, flash animation pattern at lines 817-976)
@src/renderer/index.html (toolbar and toggle patterns at lines 2168-2204)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity trail state and data structures</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add activity trail state management near the activity feed state (around line 91):

1. Add state variables:
```javascript
// Activity trail state
let activityTrailsEnabled = true; // User toggle (default on)
let activityTrails = []; // Array of { fromNodeId, toNodeId, timestamp, lineObject }
const TRAIL_MAX_AGE = 60000; // 1 minute default - trails older than this are removed
const MAX_TRAILS = 20; // Maximum number of trail connections to show
```

2. Add trail creation function `createActivityTrail(fromNodeId, toNodeId)`:
   - Find both nodes in currentGraphData.nodes
   - If either node is missing, return early (handles deleted files)
   - Create THREE.BufferGeometry with two points (node positions)
   - Create THREE.LineBasicMaterial with color based on age (start bright cyan #4ECDC4)
   - Create THREE.Line from geometry and material
   - Add line to graph scene via Graph.scene().add(line)
   - Store trail object in activityTrails array with timestamp
   - Return the trail object

3. Add trail cleanup function `cleanupOldTrails()`:
   - Iterate activityTrails
   - Remove trails older than TRAIL_MAX_AGE
   - For removed trails, call Graph.scene().remove(trail.lineObject)
   - Dispose geometry and material to prevent memory leaks

4. Modify `addActivityEntry()` function (around line 700):
   - After adding new entry to activityEntries
   - If activityTrailsEnabled is true AND there is a previous entry in activityEntries
   - Create trail from previous entry's nodeId to new entry's nodeId
   - Call cleanupOldTrails() to manage trail count
   - Trim activityTrails if exceeds MAX_TRAILS (remove oldest)
  </action>
  <verify>
Check renderer.js contains:
- activityTrailsEnabled variable
- activityTrails array
- createActivityTrail function
- cleanupOldTrails function
- Modified addActivityEntry that creates trails
  </verify>
  <done>Trail data structures exist and trails are created when files change in sequence</done>
</task>

<task type="auto">
  <name>Task 2: Trail rendering with fade animation</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add trail rendering and animation loop:

1. Create `updateTrailPositions()` function:
   - Called in animation loop to update trail line positions
   - For each trail in activityTrails:
     - Find fromNode and toNode in currentGraphData.nodes
     - If either missing, mark trail for removal
     - Update geometry positions to match current node positions (nodes may have moved)
     - geometry.attributes.position.setXYZ(0, fromNode.x, fromNode.y, fromNode.z)
     - geometry.attributes.position.setXYZ(1, toNode.x, toNode.y, toNode.z)
     - geometry.attributes.position.needsUpdate = true

2. Create `updateTrailOpacities()` function:
   - For each trail in activityTrails:
     - Calculate age = Date.now() - trail.timestamp
     - Calculate opacity = 1 - (age / TRAIL_MAX_AGE)
     - Clamp opacity between 0.1 and 0.8
     - Apply color gradient based on age:
       - 0-33% age: bright cyan (#4ECDC4)
       - 33-66% age: transition to teal (#2E8B8B)
       - 66-100% age: fade to dim (#1A5555)
     - Set trail.lineObject.material.opacity = opacity
     - Set trail.lineObject.material.color based on gradient

3. Create `startTrailAnimationLoop()` function:
   - Similar pattern to heatLoopRunning (lines 392-453)
   - Use requestAnimationFrame for smooth updates
   - Call updateTrailPositions() and updateTrailOpacities()
   - Call cleanupOldTrails()
   - Continue loop if activityTrailsEnabled and activityTrails.length > 0

4. Start the animation loop when first trail is created (in createActivityTrail)

5. Add `clearAllTrails()` function:
   - Remove all trail line objects from scene
   - Dispose geometries and materials
   - Clear activityTrails array
   - Called when trails are toggled off
  </action>
  <verify>
Run `npm run build` to check for syntax errors.
Check renderer.js contains updateTrailPositions, updateTrailOpacities, startTrailAnimationLoop, clearAllTrails functions.
  </verify>
  <done>Trail lines update positions as nodes move and fade smoothly over time</done>
</task>

<task type="auto">
  <name>Task 3: UI toggle button for activity trails</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add toggle button in toolbar after flash-intensity-container (around line 2189):
```html
<button id="trails-toggle" class="toggle-btn active" title="Toggle activity trails">
  <span class="trails-icon">~</span>
  <span>Trails</span>
</button>
```

2. Add CSS styles for the toggle button (in style section, after flash intensity styles around line 1175):
```css
/* Activity Trails Toggle */
#trails-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  margin-left: 10px;
  background: rgba(78, 205, 196, 0.2);
  border: 1px solid rgba(78, 205, 196, 0.5);
  border-radius: 4px;
  color: #4ECDC4;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#trails-toggle:hover {
  background: rgba(78, 205, 196, 0.3);
  border-color: #4ECDC4;
}

#trails-toggle.active {
  background: rgba(78, 205, 196, 0.4);
  border-color: #4ECDC4;
}

#trails-toggle:not(.active) {
  background: rgba(128, 128, 128, 0.2);
  border-color: rgba(128, 128, 128, 0.4);
  color: #888;
}

#trails-toggle .trails-icon {
  font-size: 14px;
  font-weight: bold;
}
```

3. In renderer.js, add event listener for toggle button (near other toggle handlers around line 4500):
```javascript
// Activity trails toggle
document.getElementById('trails-toggle')?.addEventListener('click', () => {
  activityTrailsEnabled = !activityTrailsEnabled;
  const btn = document.getElementById('trails-toggle');
  if (activityTrailsEnabled) {
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
    clearAllTrails();
  }
});
```

4. Load/save trail toggle state using electron-store:
   - In loadFlashSettings (or create loadTrailSettings), load 'activityTrailsEnabled' from store
   - Apply saved state to activityTrailsEnabled variable and button class
   - Save state when toggle is clicked
  </action>
  <verify>
Run `npm run build` and `npm start`.
Verify toggle button appears in toolbar.
Click toggle to enable/disable trails.
Check electron-store persists the setting.
  </verify>
  <done>User can toggle activity trails on/off via UI button, setting persists</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. App launches: `npm start`
3. Trails toggle button visible in toolbar
4. When files change in sequence, lines appear connecting them
5. Trail lines fade from bright to dim over ~1 minute
6. Toggling off clears all trails immediately
7. Setting persists across app restart
</verification>

<success_criteria>
- Activity trails connect file change nodes chronologically
- Trails visually fade based on age (newest = brightest)
- Trails automatically clean up after max age
- Toggle button enables/disables trail rendering
- No memory leaks from trail objects
</success_criteria>

<output>
After completion, create `.planning/phases/20-activity-trails/20-01-SUMMARY.md`
</output>

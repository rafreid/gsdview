---
phase: 21-smart-camera-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "When follow-active mode is enabled, camera smoothly pans to newly changed files"
    - "User can toggle follow-active mode on/off via UI button"
    - "Follow-active mode state persists across app restarts"
  artifacts:
    - path: "src/renderer/renderer.js"
      provides: "Follow-active camera mode logic"
      contains: "followActiveEnabled"
    - path: "src/renderer/index.html"
      provides: "Follow-active toggle button"
      contains: "follow-toggle"
  key_links:
    - from: "addActivityEntry"
      to: "flyToNodeSmooth"
      via: "file change triggers camera movement when enabled"
      pattern: "followActiveEnabled.*cameraPosition"
    - from: "follow-toggle button"
      to: "followActiveEnabled variable"
      via: "click event toggles state"
      pattern: "follow-toggle.*addEventListener"
    - from: "window.electronAPI.store"
      to: "followActiveEnabled"
      via: "persistence on toggle"
      pattern: "store\\.(get|set).*followActive"
---

<objective>
Implement follow-active camera mode that automatically pans to newly changed files.

Purpose: When working on a project, users often want to see which files are being modified in real-time. Follow-active mode keeps the camera focused on the action without manual navigation.

Output: Toggle button in toolbar that enables/disables automatic camera following when files change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js (trails-toggle pattern at lines 5541-5557, cameraPosition at lines 1917-1935, addActivityEntry at lines 987-1000, file change handler at lines 4308-4321)
@src/renderer/index.html (toggle button patterns at lines 2266-2273, toolbar area at lines 2250-2278)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Follow-active state and camera control logic</name>
  <files>src/renderer/renderer.js</files>
  <action>
Add follow-active camera mode logic:

1. Add state variable near activity trail state (around line 339):
```javascript
// Follow-active camera mode
let followActiveEnabled = false; // Default off - user opts in
```

2. Add `flyToNodeSmooth(nodeId, distance)` helper function (after the existing camera patterns around line 1940):
```javascript
// Smooth camera fly to node (used by follow-active mode)
function flyToNodeSmooth(nodeId, distance = 80) {
  if (!Graph || !currentGraphData) return;

  const node = currentGraphData.nodes.find(n => n.id === nodeId);
  if (!node || node.x === undefined) return;

  if (is3D) {
    const distRatio = 1 + distance / Math.hypot(node.x || 0, node.y || 0, node.z || 0);
    Graph.cameraPosition(
      {
        x: (node.x || 0) * distRatio,
        y: (node.y || 0) * distRatio,
        z: (node.z || 0) * distRatio
      },
      node,
      800  // Slightly faster transition for follow mode
    );
  } else {
    Graph.cameraPosition(
      { x: node.x || 0, y: node.y || 0, z: distance + 100 },
      node,
      800
    );
  }
}
```

3. Modify the file change handler (around line 4311-4318) to call flyToNodeSmooth when follow-active is enabled:
```javascript
// After: const entry = addActivityEntry(data.event, data.path, data.sourceType);

// Flash the node with type-appropriate animation
if (entry.nodeId) {
  flashNodeWithType(entry.nodeId, entry.event);
  flashTreeItem(entry.nodeId, entry.event);

  // Follow camera to changed file if follow-active is enabled
  if (followActiveEnabled && entry.event !== 'deleted') {
    flyToNodeSmooth(entry.nodeId);
  }
}
```

4. Add settings load/save functions (near loadTrailSettings around line 360):
```javascript
// Load follow-active setting from store
async function loadFollowActiveSetting() {
  try {
    const saved = await window.electronAPI.store.get('followActiveEnabled');
    if (typeof saved === 'boolean') {
      followActiveEnabled = saved;
      const toggle = document.getElementById('follow-toggle');
      if (toggle) {
        if (followActiveEnabled) {
          toggle.classList.add('active');
        } else {
          toggle.classList.remove('active');
        }
      }
    }
  } catch (err) {
    console.log('[Camera] Could not load follow-active setting:', err);
  }
}
```

5. Call loadFollowActiveSetting() after the DOMContentLoaded setup (find where loadTrailSettings is called).
  </action>
  <verify>
Check renderer.js contains:
- followActiveEnabled variable
- flyToNodeSmooth function
- Modified file change handler with followActiveEnabled check
- loadFollowActiveSetting function
  </verify>
  <done>Follow-active camera logic exists and triggers camera movement on file changes when enabled</done>
</task>

<task type="auto">
  <name>Task 2: Follow-active toggle button UI</name>
  <files>src/renderer/index.html, src/renderer/renderer.js</files>
  <action>
1. In index.html, add follow-active toggle button before the trails-toggle (around line 2265):
```html
<button id="follow-toggle" title="Auto-follow camera to changed files">
  <span class="follow-icon">&#9678;</span> Follow
</button>
```

2. Add CSS styles for the follow toggle button (after the trails-toggle styles around line 1207):
```css
/* Follow-Active Toggle */
#follow-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  margin-left: 10px;
  background: rgba(255, 165, 0, 0.15);
  border: 1px solid rgba(255, 165, 0, 0.4);
  border-radius: 4px;
  color: rgba(255, 165, 0, 0.7);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

#follow-toggle:hover {
  background: rgba(255, 165, 0, 0.25);
  border-color: rgba(255, 165, 0, 0.6);
  color: #FFA500;
}

#follow-toggle.active {
  background: rgba(255, 165, 0, 0.3);
  border-color: #FFA500;
  color: #FFA500;
}

#follow-toggle .follow-icon {
  font-size: 14px;
}
```
Note: Uses orange color (#FFA500) to distinguish from trails (cyan).

3. In renderer.js, add event listener for follow toggle (near trails-toggle listener around line 5541):
```javascript
// Follow-active toggle
document.getElementById('follow-toggle')?.addEventListener('click', async () => {
  followActiveEnabled = !followActiveEnabled;

  const toggle = document.getElementById('follow-toggle');
  if (toggle) {
    if (followActiveEnabled) {
      toggle.classList.add('active');
      console.log('[Camera] Follow-active mode enabled');
    } else {
      toggle.classList.remove('active');
      console.log('[Camera] Follow-active mode disabled');
    }
  }

  // Persist setting
  try {
    await window.electronAPI.store.set('followActiveEnabled', followActiveEnabled);
  } catch (err) {
    console.log('[Camera] Could not save follow-active setting:', err);
  }
});
```
  </action>
  <verify>
Run `npm run build` and `npm start`.
1. Follow toggle button appears in toolbar with orange styling
2. Clicking toggle changes its active state (visual feedback)
3. When active, editing a file in the project causes camera to pan to that node
4. When inactive, file changes flash but camera stays put
5. Setting persists across app restart
  </verify>
  <done>Follow-active toggle button works and setting persists via electron-store</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. App launches: `npm start`
3. Follow toggle button visible in toolbar with orange theme
4. Enable follow mode, edit a file in src/ - camera pans to that file node
5. Disable follow mode, edit another file - camera stays in place, node just flashes
6. Deleted files do NOT trigger camera follow (would fly to empty space)
7. Setting persists: Enable, close app, reopen - still enabled
</verification>

<success_criteria>
- Follow-active toggle button appears in toolbar
- When enabled, camera smoothly pans to newly changed files
- When disabled, camera behavior unchanged (just flash effects)
- Deleted files are excluded from follow (no fly to nothing)
- Setting persists via electron-store
</success_criteria>

<output>
After completion, create `.planning/phases/21-smart-camera-core/21-01-SUMMARY.md`
</output>

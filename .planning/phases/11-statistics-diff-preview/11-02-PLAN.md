---
phase: 11-statistics-diff-preview
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/main.js
  - src/main/preload.js
  - src/renderer/renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User can see file diff for recently changed files in details panel"
    - "Added lines are highlighted in green"
    - "Removed lines are highlighted in red"
    - "Diff compares current state with last committed state"
  artifacts:
    - path: "src/main/main.js"
      provides: "Git diff IPC handler"
      contains: "get-git-diff"
    - path: "src/main/preload.js"
      provides: "getGitDiff API exposure"
      contains: "getGitDiff"
    - path: "src/renderer/renderer.js"
      provides: "Diff display in details panel"
      contains: "renderDiffView"
  key_links:
    - from: "src/renderer/renderer.js"
      to: "window.electronAPI.getGitDiff"
      via: "IPC call to get file diff"
      pattern: "getGitDiff"
    - from: "src/main/main.js"
      to: "git diff"
      via: "runGitCommand"
      pattern: "git diff.*HEAD"
---

<objective>
Add file diff preview to details panel showing changes with syntax highlighting (green for additions, red for deletions).

Purpose: Allow users to quickly see what changed in recently modified files without leaving the visualization.
Output: Diff view section in details panel with proper diff highlighting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Git IPC pattern from Phase 10
@.planning/phases/10-git-integration/10-01-SUMMARY.md
@src/main/main.js
@src/main/preload.js
@src/renderer/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add git diff IPC handler</name>
  <files>src/main/main.js, src/main/preload.js</files>
  <action>
Add git diff functionality following existing git IPC patterns:

1. In main.js, add IPC handler after existing git handlers:
   ```javascript
   // IPC handler for getting file diff against HEAD
   ipcMain.handle('get-git-diff', async (event, projectPath, filePath) => {
     try {
       // Get diff for specific file against HEAD (last commit)
       // filePath is relative to project root (e.g., 'src/main.js' or '.planning/STATE.md')
       const output = runGitCommand(`git diff HEAD -- "${filePath}"`, projectPath);

       // If null or empty, check if file is untracked
       if (output === null || output === '') {
         // Check if file is untracked (new file not yet committed)
         const status = runGitCommand(`git status --porcelain -- "${filePath}"`, projectPath);
         if (status && status.startsWith('??')) {
           return { diff: null, status: 'untracked', message: 'New file (not yet committed)' };
         }
         return { diff: null, status: 'unchanged', message: 'No changes since last commit' };
       }

       return { diff: output, status: 'changed' };
     } catch (error) {
       console.error('Error getting git diff:', error);
       return { diff: null, error: error.message };
     }
   });
   ```

2. In preload.js, expose the API:
   ```javascript
   getGitDiff: (projectPath, filePath) => ipcRenderer.invoke('get-git-diff', projectPath, filePath),
   ```
   Add this alongside existing git methods (getGitStatus, getGitBranch, getGitCommits).
  </action>
  <verify>
npm run build && npm start
Open a git project, make a file change
In DevTools console: `await window.electronAPI.getGitDiff('/path/to/project', 'src/file.js')`
Should return {diff: "...", status: 'changed'} or {diff: null, status: 'unchanged'}
  </verify>
  <done>getGitDiff IPC handler returns diff output or status message</done>
</task>

<task type="auto">
  <name>Task 2: Render diff view in details panel</name>
  <files>src/renderer/renderer.js, src/renderer/index.html</files>
  <action>
Add diff rendering to showDetailsPanel():

1. Add CSS for diff display in index.html:
   ```css
   .diff-container {
     margin-top: 16px;
     border: 1px solid #333;
     border-radius: 4px;
     overflow: hidden;
   }
   .diff-header {
     background: #2a2a4e;
     padding: 8px 12px;
     font-weight: bold;
     border-bottom: 1px solid #333;
   }
   .diff-content {
     max-height: 300px;
     overflow-y: auto;
     font-family: 'Consolas', 'Monaco', monospace;
     font-size: 12px;
     line-height: 1.4;
   }
   .diff-line {
     padding: 2px 8px;
     white-space: pre-wrap;
     word-break: break-all;
   }
   .diff-line.added {
     background: rgba(46, 204, 113, 0.2);
     color: #2ECC71;
   }
   .diff-line.removed {
     background: rgba(231, 76, 60, 0.2);
     color: #E74C3C;
   }
   .diff-line.header {
     background: rgba(52, 152, 219, 0.2);
     color: #3498DB;
   }
   .diff-line.context {
     color: #888;
   }
   .diff-status {
     padding: 12px;
     color: #888;
     font-style: italic;
   }
   ```

2. Create renderDiffView(diffResult) function in renderer.js:
   ```javascript
   function renderDiffView(diffResult) {
     if (!diffResult) return '<div class="diff-status">Unable to load diff</div>';

     if (diffResult.error) {
       return `<div class="diff-status">Error: ${diffResult.error}</div>`;
     }

     if (!diffResult.diff) {
       return `<div class="diff-status">${diffResult.message || 'No diff available'}</div>`;
     }

     // Parse and highlight diff lines
     const lines = diffResult.diff.split('\n');
     const htmlLines = lines.map(line => {
       let className = 'diff-line context';
       if (line.startsWith('+') && !line.startsWith('+++')) {
         className = 'diff-line added';
       } else if (line.startsWith('-') && !line.startsWith('---')) {
         className = 'diff-line removed';
       } else if (line.startsWith('@@')) {
         className = 'diff-line header';
       } else if (line.startsWith('diff ') || line.startsWith('index ') ||
                  line.startsWith('---') || line.startsWith('+++')) {
         className = 'diff-line header';
       }
       return `<div class="${className}">${escapeHtml(line)}</div>`;
     }).join('');

     return `<div class="diff-content">${htmlLines}</div>`;
   }

   function escapeHtml(text) {
     return text
       .replace(/&/g, '&amp;')
       .replace(/</g, '&lt;')
       .replace(/>/g, '&gt;');
   }
   ```

3. Modify showDetailsPanel() to include diff section for file nodes:
   - After existing content, if node is a file:
   - Build full file path from node.path and sourceType
   - Call window.electronAPI.getGitDiff(selectedProjectPath, relativePath)
   - Append diff container with loading state, then update with rendered diff

   Example addition to showDetailsPanel:
   ```javascript
   // For file nodes, show diff section
   if (node.type === 'file' && selectedProjectPath) {
     html += `<div class="diff-container">
       <div class="diff-header">Recent Changes</div>
       <div id="diff-view-content"><div class="diff-status">Loading diff...</div></div>
     </div>`;

     // After setting content.innerHTML, fetch and render diff
     setTimeout(async () => {
       const diffContent = document.getElementById('diff-view-content');
       if (!diffContent) return;

       // Build relative path for git (relative to project root)
       let relativePath;
       if (node.sourceType === 'planning') {
         relativePath = '.planning/' + node.path;
       } else if (node.sourceType === 'src') {
         relativePath = 'src/' + node.path;
       } else {
         relativePath = node.path;
       }

       const diffResult = await window.electronAPI.getGitDiff(selectedProjectPath, relativePath);
       diffContent.innerHTML = renderDiffView(diffResult);
     }, 0);
   }
   ```
  </action>
  <verify>
npm run build && npm start
Open a git project, modify a file
Click on the modified file node
Details panel shows "Recent Changes" section with:
- Green highlighted lines for additions
- Red highlighted lines for deletions
- Proper diff header formatting
  </verify>
  <done>Details panel shows file diff with green additions and red deletions</done>
</task>

<task type="auto">
  <name>Task 3: Handle diff edge cases and recent activity integration</name>
  <files>src/renderer/renderer.js</files>
  <action>
Polish diff behavior and integrate with activity tracking:

1. Track recent changes for quick diff display:
   - Modify addActivityEntry to store file state info if feasible
   - For now, rely on git diff since it shows uncommitted changes

2. Handle edge cases in diff display:
   - Very long diffs: truncate after 100 lines with "... (diff truncated)" message
   - Binary files: show "Binary file - diff not available" message
   - Non-git projects: show "Not a git repository" message
   - Deleted files: show "File has been deleted" message

3. Update diff when file changes:
   - If details panel is open showing a file
   - And that file triggers a change event
   - Re-fetch and update the diff view

   Add to the file change handler:
   ```javascript
   // In onFilesChanged handler, after other updates:
   if (selectedNode && selectedNode.type === 'file') {
     const changedRelPath = getRelativePath(data.path);
     const selectedRelPath = getRelativePath(selectedNode.path || '');
     if (changedRelPath === selectedRelPath) {
       // Refresh diff in details panel
       refreshDetailsPanel(selectedNode);
     }
   }
   ```

4. Add refreshDetailsPanel() function that re-calls showDetailsPanel with current node

5. Add visual indicator for files with uncommitted changes in diff header:
   - If git status shows file as modified: "Recent Changes (uncommitted)"
   - If git status shows file as staged: "Recent Changes (staged)"
   - If clean: "Recent Changes (no uncommitted changes)"
  </action>
  <verify>
npm run build && npm start
1. Open file details, see diff
2. Modify file externally
3. Diff auto-refreshes to show new changes
4. Try with binary file - shows appropriate message
5. Try with untracked file - shows "New file" message
  </verify>
  <done>Diff handles edge cases gracefully and auto-refreshes on file changes</done>
</task>

</tasks>

<verification>
After all tasks:
1. git diff IPC handler works for any file path
2. Details panel shows "Recent Changes" section for file nodes
3. Added lines highlighted in green
4. Removed lines highlighted in red
5. Diff headers styled appropriately (blue/purple)
6. Long diffs truncated with message
7. Binary files show appropriate message
8. Untracked files show "New file" message
9. Unchanged files show "No changes" message
10. Diff auto-refreshes when file changes while panel open
</verification>

<success_criteria>
- DIF-01: Details panel shows file diff for recently changed files
- DIF-02: Diff display highlights added lines (green) and removed lines (red)
- DIF-03: Diff compares current state with last known/committed state (uses git diff HEAD)
</success_criteria>

<output>
After completion, create `.planning/phases/11-statistics-diff-preview/11-02-SUMMARY.md`
</output>

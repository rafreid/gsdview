---
phase: 16-file-context-metadata
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/index.html
  - src/renderer/renderer.js
autonomous: true

must_haves:
  truths:
    - "User can see all changes to current file from the activity log"
    - "User can see which other files import or reference the current file"
    - "Activity entries for current file show timestamp and change type"
    - "Related files section shows file paths that reference current file (for code files)"
  artifacts:
    - path: "src/renderer/index.html"
      provides: "CSS styles for recent activity and related files sections"
      min_lines: 40
      contains: ".activity-list"
    - path: "src/renderer/renderer.js"
      provides: "Recent activity and related files rendering in Context section"
      exports: ["renderRecentActivity", "renderRelatedFiles"]
      min_lines: 100
  key_links:
    - from: "renderRecentActivity()"
      to: "activityEntries"
      via: "filter by current file path"
      pattern: "activityEntries\\.filter.*filePath"
    - from: "renderRelatedFiles()"
      to: "window.electronAPI.readFileContent"
      via: "scan files for import/require statements"
      pattern: "readFileContent.*import|require"
    - from: "populateInspectorContext()"
      to: "renderRecentActivity + renderRelatedFiles"
      via: "compose Context section HTML"
      pattern: "renderRecentActivity.*renderRelatedFiles"
---

<objective>
Add Recent Activity and Related Files sections to the file inspector Context section, showing this file's change history and cross-file references.

Purpose: Users need to see what changes have been made to the current file (activity history) and discover related files that import or reference it (code relationships).

Output: Context section extended with activity timeline and related files list.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/16-file-context-metadata/16-01-PLAN.md
@src/renderer/index.html
@src/renderer/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS for recent activity and related files sections</name>
  <files>src/renderer/index.html</files>
  <action>
Add CSS styles for recent activity list and related files list within the Context section.

Recent Activity List styles:
- .activity-list: flex column, 8px gap, max-height 200px, overflow-y auto
- .activity-item: flex row, 8px padding, border-left 3px solid (color by type)
- .activity-item.created: border-left-color #2ECC71
- .activity-item.modified: border-left-color #F39C12
- .activity-item.deleted: border-left-color #E74C3C
- .activity-timestamp: color #666, font-size 11px, margin-left auto
- .activity-type: badge style (2px 6px padding, border-radius 3px, 10px font)
- Hover state: background rgba(78, 205, 196, 0.1)

Related Files List styles:
- .related-files-list: flex column, 6px gap
- .related-file-item: flex row, align-items center, 6px padding, border-radius 3px
- Hover: background rgba(78, 205, 196, 0.15), cursor pointer
- .related-file-icon: margin-right 8px, color #888
- .related-file-path: color #ccc, font-size 12px, overflow hidden, text-overflow ellipsis

Empty state styles:
- .context-empty: padding 16px, text-align center, color #666, font-style italic

Use existing scrollbar styles from modal (match .section-content scrollbar).
  </action>
  <verify>
Grep for ".activity-list" and ".related-files-list" in index.html
Count: should find 2 new CSS sections with nested styles
  </verify>
  <done>
CSS added for activity list items with type-specific colors and related files list with hover states
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement renderRecentActivity() for activity timeline</name>
  <files>src/renderer/renderer.js</files>
  <action>
Create renderRecentActivity(filePath) function that filters and displays recent changes to the current file.

Implementation:
1. Filter activityEntries by matching filePath:
   ```javascript
   const fileActivity = activityEntries.filter(entry => {
     const entryPath = entry.sourceType === 'src'
       ? `src/${entry.relativePath}`
       : `.planning/${entry.relativePath}`;
     return entryPath === filePath || entry.relativePath === filePath;
   });
   ```

2. Sort by timestamp (newest first)

3. Limit to most recent 10 entries

4. Generate HTML:
   - For each entry, create activity-item div
   - Show timestamp formatted as relative time (e.g., "2 min ago", "1 hour ago")
   - Show change type badge (Created/Modified/Deleted)
   - Apply type-specific CSS class (created/modified/deleted)

5. If no activity, return empty state:
   ```html
   <div class="context-empty">No recent activity for this file</div>
   ```

Helper function formatRelativeTime(timestamp):
- Calculate diff = Date.now() - timestamp
- If < 60s: return "Just now"
- If < 3600s: return Math.floor(diff/60000) + " min ago"
- If < 86400s: return Math.floor(diff/3600000) + " hour(s) ago"
- Else: return new Date(timestamp).toLocaleDateString()

Return HTML string for insertion into Context section.
  </action>
  <verify>
Grep for "function renderRecentActivity" in renderer.js
Grep for "formatRelativeTime" helper function
Test: Edit a file, open inspector, verify recent activity shows the change
  </verify>
  <done>
renderRecentActivity() filters activityEntries by current file path and generates timeline HTML
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement renderRelatedFiles() for import/reference detection</name>
  <files>src/renderer/renderer.js</files>
  <action>
Create renderRelatedFiles(filePath, fileName) function that finds files importing or referencing the current file.

Implementation:
1. Determine if current file is a code file (check extension: .js, .ts, .jsx, .tsx, .py, .go, etc.)

2. If not a code file, return:
   ```html
   <div class="context-empty">Related files detection available for code files only</div>
   ```

3. For code files, scan currentGraphData.nodes for other files in same sourceType:
   - Build list of candidate files (exclude directories, exclude current file)
   - For each candidate, read content via window.electronAPI.readFileContent
   - Search for import/require statements that reference current file name

4. Import detection patterns (case-insensitive):
   - JavaScript/TypeScript: `import .* from ['"].*${fileName}`, `require\(['"].*${fileName}`
   - Python: `import .*${fileNameWithoutExt}`, `from .*${fileNameWithoutExt}`
   - Simple pattern: check if fileName (without extension) appears in import/require lines

5. Generate HTML:
   - For each related file, create related-file-item div
   - Show file icon (ðŸ“„) and relative path
   - Make clickable to navigate to that file in graph

6. If no related files found:
   ```html
   <div class="context-empty">No files reference this file</div>
   ```

Performance consideration:
- Limit scan to first 50 files to avoid slowdown
- Cache results per file (optional optimization)
- Only scan text files (skip images, binaries)

Add click handler for related file items:
- Find node in currentGraphData by path
- Call focusOnNode() to navigate camera
- Optionally open that file's inspector

Return HTML string for insertion into Context section.
  </action>
  <verify>
Grep for "function renderRelatedFiles" in renderer.js
Test: Open a commonly imported file (e.g., renderer.js), verify related files section shows files that import it
Test: Open a non-code file (e.g., .md), verify shows "code files only" message
  </verify>
  <done>
renderRelatedFiles() scans graph nodes for import/require statements referencing current file
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate activity and related files into populateInspectorContext()</name>
  <files>src/renderer/renderer.js</files>
  <action>
Update populateInspectorContext() to include Recent Activity and Related Files sections after metadata and quick actions.

Add to Context section HTML structure:
```javascript
// ... existing metadata header and quick actions ...

// Recent Activity section
html += `
  <div class="context-subsection">
    <h4 class="context-subsection-title">Recent Activity</h4>
    <div class="activity-list">
      ${renderRecentActivity(fullPath)}
    </div>
  </div>
`;

// Related Files section
html += `
  <div class="context-subsection">
    <h4 class="context-subsection-title">Related Files</h4>
    <div class="related-files-list">
      ${await renderRelatedFiles(fullPath, inspectorNode.name)}
    </div>
  </div>
`;
```

Add CSS for subsection titles:
- .context-subsection: margin-top 20px
- .context-subsection-title: font-size 12px, color #888, text-transform uppercase, margin-bottom 10px, font-weight 600

Note: Make populateInspectorContext() async to handle await for renderRelatedFiles file scanning.

Add event delegation for related file item clicks:
```javascript
contextSection.addEventListener('click', (e) => {
  const item = e.target.closest('.related-file-item');
  if (item && item.dataset.nodePath) {
    const node = currentGraphData.nodes.find(n => n.path === item.dataset.nodePath);
    if (node) focusOnNode(node);
  }
});
```
  </action>
  <verify>
Grep for "context-subsection" in populateInspectorContext function
Test: Open file inspector, expand Context section
Verify shows: Metadata â†’ Quick Actions â†’ Recent Activity â†’ Related Files
Verify activity list shows file changes if file was modified during session
Verify related files list shows importing files (for code files)
Click a related file item, verify camera navigates to that node
  </verify>
  <done>
Context section now displays complete file context: metadata, actions, recent activity timeline, and related files with navigation
  </done>
</task>

</tasks>

<verification>
Manual testing:
1. Launch app, load project
2. Make some file changes to generate activity
3. Double-click a file node that has been edited
4. Expand Context section
5. Verify Recent Activity shows changes with timestamps and type badges
6. Double-click a commonly imported file (e.g., a utility module)
7. Verify Related Files section lists files that import it
8. Click a related file item, verify camera navigates to that node
9. Test with non-code file (.md, .json), verify related files shows "code files only" message
10. Test with file that has no activity, verify shows "No recent activity"

Requirements satisfied:
- CTX-06: Recent activity section shows file changes from activity log âœ“
- CTX-07: Related files section shows importing/referencing files âœ“
</verification>

<success_criteria>
- Recent Activity section displays up to 10 most recent changes to current file
- Activity entries show relative timestamps ("2 min ago") and color-coded type badges
- Related Files section scans graph for files with import/require statements
- Related file items are clickable and navigate camera to that node
- Code file detection works for .js, .ts, .jsx, .tsx, .py extensions
- Non-code files show appropriate "code files only" message in Related Files
- Empty states display when no activity or no related files found
- Performance remains smooth (scanning limited to 50 files max)
</success_criteria>

<output>
After completion, create `.planning/phases/16-file-context-metadata/16-02-SUMMARY.md`
</output>

---
phase: 30-architecture-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/state-manager.js
autonomous: true

must_haves:
  truths:
    - "State-manager.js exports centralized state object"
    - "State changes trigger registered listeners via Proxy pattern"
    - "All shared state variables have getters/setters"
  artifacts:
    - path: "src/renderer/state-manager.js"
      provides: "Centralized state management module"
      exports: ["state", "subscribe", "getState", "setState"]
      min_lines: 80
  key_links:
    - from: "src/renderer/state-manager.js"
      to: "renderer consumers"
      via: "ES module exports"
      pattern: "export (const|function|let)"
---

<objective>
Create state-manager.js module to centralize all shared state variables from renderer.js

Purpose: ARCH-01 requires centralized state management. Extracting state into its own module enables the diagram view to share state with the graph view without circular dependencies.

Output: A new state-manager.js module with Proxy-based reactivity and explicit state access patterns.
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/renderer/renderer.js (lines 1-200 for state variables reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state-manager.js with centralized state</name>
  <files>src/renderer/state-manager.js</files>
  <action>
Create a new file `src/renderer/state-manager.js` that:

1. Extracts these state variables from renderer.js (lines 75-200):
   - `currentGraphData` - graph nodes and links
   - `selectedProjectPath` - current project path
   - `currentState` - parsed STATE.md
   - `selectedNode` - currently selected node
   - `treeData` - hierarchical tree structure
   - `treeExpanded` - Set of expanded directories
   - `is3D` - dimension mode toggle
   - `activityEntries` - activity feed data
   - `activityUnreadCount` - badge counter
   - `navigationHistory` - back/forward stack
   - `navigationIndex` - history position
   - `bookmarks` - 9 bookmark slots
   - `inspectorNode` - file inspector state
   - `highlightedNodeId` - hover highlight

2. Implements Proxy pattern for reactivity:
   ```javascript
   const listeners = new Set();

   const state = new Proxy(rawState, {
     set(target, property, value) {
       const oldValue = target[property];
       target[property] = value;
       if (oldValue !== value) {
         listeners.forEach(fn => fn(property, value, oldValue));
       }
       return true;
     }
   });
   ```

3. Exports:
   - `state` - the Proxy-wrapped state object
   - `subscribe(listener)` - add change listener, returns unsubscribe function
   - `getState(key)` - safe getter
   - `setState(key, value)` - safe setter with validation

4. Include JSDoc comments for all exports

DO NOT modify renderer.js in this task - that's Plan 02.
  </action>
  <verify>
Run: `node -e "const s = require('./src/renderer/state-manager.js'); console.log(Object.keys(s))"`
Verify output includes: state, subscribe, getState, setState
  </verify>
  <done>
state-manager.js exists with Proxy-based state management, exports state object and subscription mechanism
  </done>
</task>

<task type="auto">
  <name>Task 2: Add state initialization and reset functions</name>
  <files>src/renderer/state-manager.js</files>
  <action>
Enhance state-manager.js with:

1. `initializeState(projectPath)` function:
   - Resets state to defaults
   - Sets selectedProjectPath
   - Clears navigation history
   - Resets activity entries
   - Called when loading a new project

2. `resetViewState()` function:
   - Clears selectedNode
   - Clears highlightedNodeId
   - Clears inspectorNode
   - Used when switching views

3. Default state values as constants:
   ```javascript
   const DEFAULT_STATE = {
     currentGraphData: { nodes: [], links: [] },
     selectedProjectPath: null,
     currentState: null,
     selectedNode: null,
     // ... etc
   };
   ```

4. Add `getDefaultState()` export for testing

Ensure all state transitions go through the Proxy for consistent listener notification.
  </action>
  <verify>
Run: `node -e "const s = require('./src/renderer/state-manager.js'); s.initializeState('/test'); console.log(s.getState('selectedProjectPath'))"`
Verify output: /test
  </verify>
  <done>
state-manager.js has initializeState and resetViewState functions, DEFAULT_STATE constant exported
  </done>
</task>

</tasks>

<verification>
1. File exists: `ls src/renderer/state-manager.js`
2. Module loads: `node -e "require('./src/renderer/state-manager.js')"`
3. Exports correct: `node -e "const s = require('./src/renderer/state-manager.js'); console.log(typeof s.state, typeof s.subscribe)"`
4. Proxy works: `node -e "const s = require('./src/renderer/state-manager.js'); let changed = false; s.subscribe(() => changed = true); s.state.selectedNode = 'test'; console.log(changed)"`
</verification>

<success_criteria>
- state-manager.js exports state, subscribe, getState, setState, initializeState, resetViewState
- Proxy pattern triggers listeners on state changes
- All critical shared state variables are centralized
- Module is ready for import by graph-renderer.js (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/30-architecture-foundation/30-01-SUMMARY.md`
</output>

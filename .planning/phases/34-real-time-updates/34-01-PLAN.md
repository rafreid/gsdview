---
phase: 34-real-time-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/diagram-renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User sees diagram artifacts update when .planning/ files change"
    - "User sees flash animation on changed artifact (matching graph colors)"
    - "User experiences smooth updates during rapid file changes (no flickering)"
    - "User sees activity feed shows changes regardless of which view is active"
  artifacts:
    - path: "src/renderer/diagram-renderer.js"
      provides: "onFilesChanged handler with re-parse, flash, debounce"
      exports: ["onFilesChanged"]
    - path: "src/renderer/index.html"
      provides: "CSS keyframes for diagram artifact flash animations"
      contains: "@keyframes diagram-flash"
  key_links:
    - from: "src/renderer/graph-renderer.js"
      to: "diagram-renderer.js"
      via: "IPC event triggers diagram update when activeView === 'diagram'"
      pattern: "onFilesChanged.*diagram"
    - from: "src/renderer/diagram-renderer.js"
      to: "gsd-pipeline-parser.js"
      via: "re-parse pipeline on file change"
      pattern: "parsePipelineState"
---

<objective>
Add real-time update support to the diagram view: file changes trigger immediate diagram re-render with flash animations on changed artifacts.

Purpose: Users need visual feedback when files change while viewing the diagram, matching the real-time experience they have in graph view.

Output: diagram-renderer.js with onFilesChanged handler, CSS flash animations for artifacts
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/renderer/diagram-renderer.js
@src/renderer/graph-renderer.js (lines 5545-5600 for onFilesChanged pattern)
@src/renderer/state-manager.js
@src/renderer/gsd-pipeline-parser.js
@src/renderer/index.html (lines 770-880 for tree-flash keyframes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file change handler to diagram-renderer.js</name>
  <files>src/renderer/diagram-renderer.js</files>
  <action>
Add `onFilesChanged(data)` function to diagram-renderer.js that:

1. **Receives file change events** when diagram view is active
   - Export `onFilesChanged` function
   - Check if changed file is in `.planning/` directory (sourceType === 'planning')
   - Skip non-planning files (src/ changes don't affect diagram)

2. **Re-parse pipeline data with debounce**
   - Use 300ms debounce to prevent rapid re-renders during burst changes
   - Call `parsePipelineState(state.selectedProjectPath)` to get fresh data
   - Store in module-level `pipelineData` variable

3. **Re-render diagram**
   - Clear existing SVG content
   - Call `renderPipeline(diagramGroup, pipelineData)` with updated data
   - Preserve current pan position (currentTransform)

4. **Track changed artifact for flash animation**
   - Extract artifact path from change event
   - Store in module-level variable for Task 2's flash function

5. **Update graph-renderer.js to route to diagram handler**
   - In the `onFilesChanged` IPC handler (around line 5554)
   - Add else branch for `state.activeView === 'diagram'`
   - Import and call diagram's `onFilesChanged` function

Pattern to follow from graph-renderer.js (line 5546-5600):
- Always update activity feed (already done - LIVE-03 satisfied)
- Route visual effects based on activeView
- Always update underlying data (already done - applyIncrementalUpdate)
  </action>
  <verify>
1. `grep -n "onFilesChanged" src/renderer/diagram-renderer.js` shows exported function
2. `grep -n "activeView.*diagram" src/renderer/graph-renderer.js` shows routing logic
3. Manual test: With diagram view active, create a new file in a phase directory - diagram should re-render
  </verify>
  <done>
- diagram-renderer.js has onFilesChanged function that re-parses and re-renders
- graph-renderer.js routes file changes to diagram when activeView === 'diagram'
- Debounce prevents flickering during rapid changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add artifact flash animation</name>
  <files>src/renderer/index.html, src/renderer/diagram-renderer.js</files>
  <action>
**In index.html:** Add CSS keyframes for diagram artifact flash animations

1. Add keyframes matching existing tree-flash colors:
   - `@keyframes diagram-flash-created` - bright green (#2ECC71 / neon green)
   - `@keyframes diagram-flash-modified` - bright amber (#F39C12 / orange)
   - `@keyframes diagram-flash-deleted` - bright red (#E74C3C)

2. Animation characteristics (match graph-renderer flash behavior):
   - Duration: 2000ms (matches default flashDuration)
   - Scale pulse: 1.0 -> 1.1 -> 1.0 (subtle, not too dramatic for SVG)
   - Glow effect via filter: drop-shadow with color
   - 3 pulses for modified, 4 quick pulses for created, 2 slow pulses for deleted

3. Add `.artifact.flashing` class that triggers animation

**In diagram-renderer.js:** Add flashArtifact function

1. Create `flashArtifact(artifactPath, changeType)` function:
   - Find artifact element by data attribute or path matching
   - Add appropriate flash class based on changeType
   - Remove class after animation completes (2000ms)

2. Wire flash to onFilesChanged:
   - After re-render completes, find the changed artifact
   - Call flashArtifact with the path and event type

3. Handle case where artifact is new (created):
   - Re-render first, then flash the new artifact

4. Handle case where artifact is deleted:
   - Flash brief red before re-render removes it (or skip flash for deleted)

Colors to use (matching STATUS_COLORS in diagram-renderer.js):
- created: #2ECC71 (green)
- modified: #F39C12 (orange/amber)
- deleted: #E74C3C (red)
  </action>
  <verify>
1. `grep -n "@keyframes diagram-flash" src/renderer/index.html` shows 3 keyframes
2. `grep -n "flashArtifact" src/renderer/diagram-renderer.js` shows function definition
3. Manual test: With diagram view active, edit a PLAN.md file - the artifact should flash orange
  </verify>
  <done>
- index.html has diagram-flash-created, diagram-flash-modified, diagram-flash-deleted keyframes
- diagram-renderer.js has flashArtifact function that applies CSS animation
- Changed artifacts flash with appropriate color when files are modified
  </done>
</task>

</tasks>

<verification>
1. **LIVE-01 (File changes trigger diagram updates):**
   - Switch to diagram view
   - Create a new PLAN.md file in a phase directory
   - Diagram should re-render showing new artifact within 500ms

2. **LIVE-02 (Flash animation highlights changes):**
   - With diagram view active, edit an existing PLAN.md
   - The artifact should flash orange for ~2 seconds
   - Create new file: artifact flashes green
   - Delete file: artifact flashes red briefly before disappearing

3. **LIVE-03 (Activity feed shows changes from both views):**
   - Already working - verify by making changes while in diagram view
   - Switch to graph view and check activity panel shows the changes

4. **Performance (smooth updates during rapid changes):**
   - Make 5 rapid file changes in <1 second
   - Diagram should only re-render once (debounced)
   - No visual flickering or stuttering
</verification>

<success_criteria>
- [ ] diagram-renderer.js exports onFilesChanged function
- [ ] graph-renderer.js routes file changes to diagram when active
- [ ] 300ms debounce prevents rapid re-renders
- [ ] CSS keyframes exist for all 3 change types
- [ ] flashArtifact function applies appropriate animation class
- [ ] All 3 LIVE requirements pass verification
- [ ] No console errors during file change events
</success_criteria>

<output>
After completion, create `.planning/phases/34-real-time-updates/34-01-SUMMARY.md`
</output>

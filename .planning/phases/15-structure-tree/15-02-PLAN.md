---
phase: 15-structure-tree
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/renderer/index.html
  - src/renderer/renderer.js
autonomous: false

must_haves:
  truths:
    - "Structure tree displays parsed file structure in the modal"
    - "Tree nodes can be collapsed and expanded"
    - "Clicking a tree node scrolls diff editor to that line"
  artifacts:
    - path: "src/renderer/index.html"
      provides: "Structure tree CSS styles"
      contains: ".structure-tree"
    - path: "src/renderer/renderer.js"
      provides: "populateInspectorStructure function"
      contains: "populateInspectorStructure"
    - path: "src/renderer/renderer.js"
      provides: "renderStructureTree function"
      contains: "renderStructureTree"
  key_links:
    - from: "populateInspectorStructure"
      to: "parseFileStructure"
      via: "function call"
      pattern: "parseFileStructure\\(content"
    - from: "structure tree click"
      to: "diff section scroll"
      via: "event delegation"
      pattern: "scrollIntoView|scrollTo"
---

<objective>
Render the file structure tree in the modal's Structure section with collapsible nodes and click-to-scroll navigation.

Purpose: Let users navigate file structure visually and jump to specific locations in the diff view
Output: Working structure tree with expand/collapse and click-to-scroll functionality
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-structure-tree/15-01-SUMMARY.md
@src/renderer/renderer.js (patterns: populateInspectorDiff, parseFileStructure)
@src/renderer/index.html (modal structure, collapsible sections)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structure tree CSS styles</name>
  <files>src/renderer/index.html</files>
  <action>
Add CSS styles before the closing </style> tag (after the syntax highlighting styles around line 1547):

```css
/* Structure Tree Styles */
.structure-tree {
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 12px;
}

.structure-item {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  cursor: pointer;
  transition: background 0.15s;
  border-radius: 3px;
}

.structure-item:hover {
  background: rgba(78, 205, 196, 0.15);
}

.structure-item.active {
  background: rgba(78, 205, 196, 0.25);
  border-left: 2px solid #4ECDC4;
}

.structure-toggle {
  width: 16px;
  height: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-right: 4px;
  color: #888;
  font-size: 8px;
  transition: transform 0.2s;
  flex-shrink: 0;
}

.structure-toggle.expanded {
  transform: rotate(90deg);
}

.structure-toggle.no-children {
  visibility: hidden;
}

.structure-icon {
  margin-right: 6px;
  font-size: 12px;
  flex-shrink: 0;
}

.structure-icon.header { color: #4ECDC4; }
.structure-icon.function { color: #61AFEF; }
.structure-icon.class { color: #E5C07B; }
.structure-icon.import { color: #C678DD; }
.structure-icon.export { color: #98C379; }
.structure-icon.key { color: #D19A66; }
.structure-icon.list { color: #ABB2BF; }
.structure-icon.codeblock { color: #56B6C2; }

.structure-name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #ccc;
}

.structure-line {
  margin-left: 8px;
  font-size: 10px;
  color: #666;
}

.structure-children {
  display: none;
  margin-left: 16px;
}

.structure-children.expanded {
  display: block;
}

.structure-empty {
  padding: 20px;
  text-align: center;
  color: #666;
  font-style: italic;
}
```
  </action>
  <verify>Styles added without syntax errors. Check by viewing page source in DevTools.</verify>
  <done>Structure tree CSS classes defined for items, icons, toggles, children, and empty state.</done>
</task>

<task type="auto">
  <name>Task 2: Add structure tree rendering and click handling</name>
  <files>src/renderer/renderer.js</files>
  <action>
1. Add populateInspectorStructure function after populateInspectorDiff (around line 2380):

```javascript
// Populate the structure tree section
async function populateInspectorStructure() {
  if (!inspectorNode || inspectorNode.type !== 'file') return;

  const structureSection = document.querySelector('#section-structure .section-content');
  if (!structureSection) return;

  const filePath = getInspectorFilePath();
  if (!filePath) {
    structureSection.innerHTML = '<p class="structure-empty">Could not determine file path</p>';
    return;
  }

  try {
    const content = await window.api.readFile(filePath);
    const items = parseFileStructure(content, inspectorNode.name);

    if (items.length === 0) {
      structureSection.innerHTML = '<p class="structure-empty">No structure found in this file</p>';
      return;
    }

    structureSection.innerHTML = `<div class="structure-tree">${renderStructureTree(items)}</div>`;
  } catch (err) {
    console.error('[Structure] Error loading:', err);
    structureSection.innerHTML = `<p class="structure-empty">Error loading file structure</p>`;
  }
}
```

2. Add renderStructureTree function to convert items to HTML:

```javascript
// Render structure items as nested tree HTML
function renderStructureTree(items, parentDepth = -1) {
  const iconMap = {
    header: 'H',
    function: 'f',
    class: 'C',
    import: 'i',
    export: 'e',
    key: 'k',
    list: '-',
    codeblock: '<>'
  };

  let html = '';
  let i = 0;

  while (i < items.length) {
    const item = items[i];
    const hasChildren = i + 1 < items.length && items[i + 1].depth > item.depth;

    // Collect children (items with greater depth until we hit same or lower depth)
    const children = [];
    if (hasChildren) {
      let j = i + 1;
      while (j < items.length && items[j].depth > item.depth) {
        children.push(items[j]);
        j++;
      }
    }

    const icon = iconMap[item.type] || '?';
    const toggleClass = hasChildren ? '' : 'no-children';
    const indentStyle = `padding-left: ${item.depth * 12}px`;

    html += `<div class="structure-item" data-line="${item.line}" style="${indentStyle}">
      <span class="structure-toggle ${toggleClass}">&#9654;</span>
      <span class="structure-icon ${item.type}">${icon}</span>
      <span class="structure-name">${escapeHtml(item.name)}</span>
      <span class="structure-line">:${item.line}</span>
    </div>`;

    if (children.length > 0) {
      html += `<div class="structure-children">${renderStructureTree(children, item.depth)}</div>`;
    }

    // Skip children we've already processed
    i += 1 + children.length;
  }

  return html;
}
```

3. Update openFileInspector to call populateInspectorStructure:

Find the line `await populateInspectorDiff();` (around line 2171) and add after it:
```javascript
  await populateInspectorStructure();
```

4. Add event delegation for structure tree clicks and collapse/expand:

After the line number click handler (around line 2390), add:

```javascript
// Structure tree click handlers (event delegation)
document.querySelector('#section-structure .section-content').addEventListener('click', (e) => {
  const item = e.target.closest('.structure-item');
  if (!item) return;

  // Check if clicking on toggle
  const toggle = e.target.closest('.structure-toggle');
  if (toggle && !toggle.classList.contains('no-children')) {
    // Toggle expand/collapse
    toggle.classList.toggle('expanded');
    const children = item.nextElementSibling;
    if (children && children.classList.contains('structure-children')) {
      children.classList.toggle('expanded');
    }
    return;
  }

  // Click on item itself - scroll to line in diff
  const line = parseInt(item.dataset.line, 10);
  if (!line) return;

  // Find matching line in diff section
  const diffSection = document.querySelector('#section-diff .section-content');
  if (!diffSection) return;

  // Find line number element with matching data-line
  const lineEl = diffSection.querySelector(`.diff-line-number[data-line="${line}"]`);
  if (lineEl) {
    lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Highlight the line briefly
    const container = lineEl.closest('.diff-line-container');
    if (container) {
      container.style.background = 'rgba(78, 205, 196, 0.3)';
      setTimeout(() => {
        container.style.background = '';
      }, 1500);
    }
  }

  // Mark this item as active
  document.querySelectorAll('.structure-item.active').forEach(el => el.classList.remove('active'));
  item.classList.add('active');
});
```
  </action>
  <verify>
Run `npm start`, open a project, double-click a file (try .md, .js, .json):
1. Structure section shows parsed elements with icons
2. Click toggle arrows to expand/collapse nested items
3. Click an item name to scroll diff view to that line
4. Line briefly highlights on scroll
  </verify>
  <done>
Structure tree renders with collapsible sections, clicking items scrolls diff to line, line highlights briefly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Structure tree with parsing, rendering, collapse/expand, and click-to-scroll navigation</what-built>
  <how-to-verify>
1. Run `npm start` and open a project folder
2. Double-click a MARKDOWN file (.md):
   - Structure section shows headers (H), list items (-), code blocks (<>)
   - Headers have correct depth indentation
   - Click a header - diff scrolls to that line
3. Double-click a CODE file (.js or .ts):
   - Structure shows functions (f), classes (C), imports (i), exports (e)
   - Click a function - diff scrolls to that line
4. Double-click a CONFIG file (.json):
   - Structure shows nested keys (k) with indentation
   - Click a key - diff scrolls to that line
5. Test collapse/expand:
   - Click the triangle toggle on items with children
   - Children hide/show correctly
6. Verify line highlighting:
   - When clicking structure item, diff line highlights briefly (1.5s)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- Structure section populates on modal open for all file types
- Markdown shows headers, lists, code blocks with correct depth
- Code files show functions, classes, imports, exports
- Config files show nested key structure
- Collapse/expand toggles work
- Click-to-scroll navigates diff view to correct line
- Line highlights briefly after scroll
</verification>

<success_criteria>
- TRE-01: Markdown files show headers (H1-H6), lists, code blocks
- TRE-02: Code files show functions, classes, imports, exports
- TRE-03: Config files (JSON/YAML) show nested key structure
- TRE-04: Tree nodes collapse/expand via toggle clicks
- TRE-05: Clicking tree node scrolls diff editor to that location
</success_criteria>

<output>
After completion, create `.planning/phases/15-structure-tree/15-02-SUMMARY.md`
</output>

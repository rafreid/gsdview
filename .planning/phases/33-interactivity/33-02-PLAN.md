---
phase: 33-interactivity
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - src/renderer/diagram-renderer.js
  - src/renderer/graph-renderer.js
autonomous: true

must_haves:
  truths:
    - "User clicks artifact in diagram and corresponding node highlights in graph view"
    - "User clicks node in graph view and corresponding artifact highlights in diagram view"
    - "User presses bookmark shortcuts (1-9) in diagram view and navigates to bookmarked phase"
  artifacts:
    - path: "src/renderer/diagram-renderer.js"
      provides: "Selection sync and bookmark handlers"
      contains: "state.selectedNode"
    - path: "src/renderer/graph-renderer.js"
      provides: "Export highlightNodeInGraph function"
      contains: "export.*highlightNodeInGraph"
  key_links:
    - from: "src/renderer/diagram-renderer.js"
      to: "state.selectedNode"
      via: "D3 click handler sets selection"
      pattern: "state\\.selectedNode\\s*="
    - from: "src/renderer/diagram-renderer.js"
      to: "highlightNodeInGraph"
      via: "import and call on artifact click"
      pattern: "highlightNodeInGraph"
    - from: "src/renderer/diagram-renderer.js"
      to: "subscribe"
      via: "React to selection changes from graph"
      pattern: "subscribe.*selectedNode"
---

<objective>
Add two-way selection synchronization between diagram and graph views, plus bookmark navigation in diagram view.

Purpose: Enable seamless cross-view navigation where selecting in one view highlights in the other, and bookmark shortcuts work regardless of which view is active.
Output: Clicking artifact in diagram highlights corresponding node in graph (and vice versa), pressing 1-9 keys jumps to bookmarked phases.
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@src/renderer/diagram-renderer.js
@src/renderer/graph-renderer.js (highlightNodeInGraph at line 1716, bookmark handling at lines 5443-5500)
@src/renderer/state-manager.js (state.selectedNode, subscribe pattern)
@src/renderer/view-controller.js (switchToView function)
@.planning/phases/33-interactivity/33-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagram-to-Graph selection sync (INTR-04)</name>
  <files>src/renderer/diagram-renderer.js, src/renderer/graph-renderer.js</files>
  <action>
1. In graph-renderer.js, export the highlightNodeInGraph function (add to module.exports or change to export function):
   ```javascript
   // Find the function (around line 1716) and ensure it's exported
   export function highlightNodeInGraph(nodeId) { ... }
   ```

2. In diagram-renderer.js, import highlightNodeInGraph:
   ```javascript
   import { highlightNodeInGraph } from './graph-renderer.js';
   ```

3. Modify the artifact click handler (from 33-01) to also set state.selectedNode and trigger graph highlight:
   ```javascript
   artifactGroups.on('click', (event, artifact) => {
     event.stopPropagation();

     // Build node object
     const nodeId = 'planning:' + artifact.path.replace(/.*\.planning\//, '');
     const node = {
       id: nodeId,
       name: artifact.name,
       type: 'file',
       path: artifact.path.replace(/.*\.planning\//, ''),
       sourceType: 'planning'
     };

     // Set selection state (triggers cross-view sync)
     state.selectedNode = node;

     // Highlight in graph view (for when user switches back)
     highlightNodeInGraph(nodeId);

     // Open file inspector
     openFileInspector(node);
   });
   ```

4. Add visual selection indicator in diagram for clicked artifact:
   ```javascript
   // In renderArtifacts(), add selection styling:
   artifactGroups
     .attr('class', d => `artifact ${state.selectedNode?.id === 'planning:' + d.path.replace(/.*\.planning\//, '') ? 'selected' : ''}`);
   ```

5. Add CSS for selected artifact in index.html:
   ```css
   .artifact.selected rect {
     stroke: #4ECDC4 !important;
     stroke-width: 2 !important;
   }
   ```

   Alternatively, handle in D3 directly by updating stroke on selection change.
  </action>
  <verify>
Run `npm start`, switch to Diagram view, click an artifact. Switch to Graph view - the corresponding node should be highlighted.
  </verify>
  <done>
Clicking artifact in diagram sets state.selectedNode and highlights corresponding node in graph view when switching views.
  </done>
</task>

<task type="auto">
  <name>Task 2: Graph-to-Diagram selection sync (INTR-05)</name>
  <files>src/renderer/diagram-renderer.js</files>
  <action>
1. Subscribe to state.selectedNode changes in diagram-renderer mount():
   ```javascript
   let selectionUnsubscribe = null;

   export function mount() {
     // ... existing mount code ...

     // Subscribe to selection changes
     selectionUnsubscribe = subscribe((property, newValue, oldValue) => {
       if (property === 'selectedNode') {
         highlightArtifactInDiagram(newValue);
       }
     });
   }

   export function unmount() {
     // ... existing unmount code ...

     // Unsubscribe from selection changes
     if (selectionUnsubscribe) {
       selectionUnsubscribe();
       selectionUnsubscribe = null;
     }
   }
   ```

2. Create highlightArtifactInDiagram function:
   ```javascript
   function highlightArtifactInDiagram(node) {
     if (!diagramGroup) return;

     // Clear previous selection highlight
     diagramGroup.selectAll('.artifact').classed('selected', false);

     if (!node) return;

     // Extract path from node ID (format: 'planning:/phases/XX-name/file.md')
     const nodeId = node?.id || node;
     if (!nodeId || !nodeId.startsWith('planning:')) return;

     const relativePath = nodeId.replace('planning:', '');

     // Find matching artifact and highlight
     diagramGroup.selectAll('.artifact').each(function(d) {
       const artifactPath = d.path.replace(/.*\.planning\//, '');
       if (artifactPath === relativePath || d.path.includes(relativePath)) {
         d3.select(this).classed('selected', true);

         // Optionally scroll/pan to make artifact visible
         scrollArtifactIntoView(this);
       }
     });
   }
   ```

3. Create scrollArtifactIntoView helper (optional but nice UX):
   ```javascript
   function scrollArtifactIntoView(artifactElement) {
     // Get artifact position
     const artifactGroup = d3.select(artifactElement);
     const transform = artifactGroup.attr('transform');

     // Parse transform to get position
     const match = transform?.match(/translate\(([^,]+),\s*([^)]+)\)/);
     if (!match) return;

     const artifactX = parseFloat(match[1]);
     const artifactY = parseFloat(match[2]);

     // Get parent stage position
     const stageGroup = d3.select(artifactElement.parentNode);
     const stageTransform = stageGroup.attr('transform');
     const stageMatch = stageTransform?.match(/translate\(([^,]+),\s*([^)]+)\)/);
     if (!stageMatch) return;

     const stageX = parseFloat(stageMatch[1]);
     const stageY = parseFloat(stageMatch[2]);

     // Calculate absolute position
     const targetX = stageX + artifactX;
     const targetY = stageY + artifactY;

     // Get container dimensions
     const container = document.getElementById('diagram-container');
     const containerWidth = container.clientWidth;
     const containerHeight = container.clientHeight;

     // Pan to center artifact (adjust currentTransform)
     currentTransform.x = containerWidth / 2 - targetX;
     currentTransform.y = containerHeight / 2 - targetY;

     updateTransform();
   }
   ```

4. Add CSS for selected state in index.html (if not done in Task 1):
   ```css
   .artifact.selected > rect:first-of-type {
     stroke: #4ECDC4 !important;
     stroke-width: 2 !important;
     filter: drop-shadow(0 0 4px rgba(78, 205, 196, 0.5));
   }
   ```
  </action>
  <verify>
Run `npm start`, in Graph view click a .planning/ file node. Switch to Diagram view - the corresponding artifact should be highlighted with teal border.
  </verify>
  <done>
Selection in graph view triggers highlight of corresponding artifact in diagram view with visual indicator and optional auto-pan.
  </done>
</task>

<task type="auto">
  <name>Task 3: Bookmark navigation in diagram view (INTR-06)</name>
  <files>src/renderer/diagram-renderer.js</files>
  <action>
1. Add keyboard event listener for bookmark shortcuts in diagram view. Add in mount() or as module-level handler:
   ```javascript
   function handleDiagramKeydown(e) {
     // Only handle in diagram view
     if (state.activeView !== 'diagram') return;

     // Ignore if typing in input
     if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

     // Handle 1-9 for bookmark navigation
     const key = parseInt(e.key);
     if (key >= 1 && key <= 9) {
       const slot = key - 1;
       const bookmark = state.bookmarks[slot];

       if (bookmark) {
         console.log('[Diagram] Jump to bookmark', slot + 1, bookmark);

         // If bookmark has a nodeId, find the phase and scroll to it
         if (bookmark.nodeId) {
           navigateToBookmarkedPhase(bookmark);
         } else if (bookmark.cameraPosition) {
           // For camera-only bookmarks, just show toast
           showToast(`Bookmark ${slot + 1}: No artifact selected`, 'info');
         }
       } else {
         showToast(`Bookmark ${slot + 1} is empty`, 'info');
       }
     }
   }

   // Register in mount()
   export function mount() {
     // ... existing code ...
     document.addEventListener('keydown', handleDiagramKeydown);
   }

   // Cleanup in unmount()
   export function unmount() {
     // ... existing code ...
     document.removeEventListener('keydown', handleDiagramKeydown);
   }
   ```

2. Create navigateToBookmarkedPhase function:
   ```javascript
   function navigateToBookmarkedPhase(bookmark) {
     const nodeId = bookmark.nodeId;

     // Parse phase number from node ID (format: 'planning:/phases/XX-name/...')
     const match = nodeId.match(/phases\/(\d+)-/);
     if (!match) {
       showToast('Bookmark not in a phase', 'warning');
       return;
     }

     const phaseNumber = parseInt(match[1], 10);

     // Find the stage containing this phase
     if (!pipelineData || !pipelineData.phases) {
       showToast('Pipeline data not loaded', 'warning');
       return;
     }

     const phase = pipelineData.phases.find(p => p.number === phaseNumber);
     if (!phase) {
       showToast(`Phase ${phaseNumber} not found in diagram`, 'warning');
       return;
     }

     // Find stage index for this phase
     const stageIndex = GSD_STAGES.findIndex(s => s.id === phase.stage);

     // Calculate target X position (stages are laid out horizontally)
     const targetX = stageIndex * (STAGE_WIDTH + STAGE_SPACING);

     // Get container width for centering
     const container = document.getElementById('diagram-container');
     const containerWidth = container.clientWidth;

     // Pan to center on stage
     currentTransform.x = containerWidth / 2 - targetX - STAGE_WIDTH / 2;

     // Animate the pan (optional smooth transition)
     animatePanTo(currentTransform.x, currentTransform.y);

     // Highlight the artifact
     highlightArtifactInDiagram({ id: nodeId });

     showToast(`Jumped to Phase ${phaseNumber}`, 'success');
   }
   ```

3. Add animatePanTo for smooth camera movement:
   ```javascript
   function animatePanTo(targetX, targetY) {
     const startX = currentTransform.x;
     const startY = currentTransform.y;
     const duration = 500; // ms
     const startTime = performance.now();

     function animate(currentTime) {
       const elapsed = currentTime - startTime;
       const progress = Math.min(elapsed / duration, 1);

       // Ease-out curve
       const eased = 1 - Math.pow(1 - progress, 3);

       currentTransform.x = startX + (targetX - startX) * eased;
       currentTransform.y = startY + (targetY - startY) * eased;

       updateTransform();

       if (progress < 1) {
         requestAnimationFrame(animate);
       }
     }

     requestAnimationFrame(animate);
   }
   ```

4. Import showToast from graph-renderer or create locally. Check if it's already exported from graph-renderer.js. If not exported, create a simple local version:
   ```javascript
   function showToast(message, type = 'info') {
     const toast = document.getElementById('toast');
     if (!toast) return;

     toast.textContent = message;
     toast.className = `toast ${type} visible`;

     setTimeout(() => {
       toast.classList.remove('visible');
     }, 3000);
   }
   ```
  </action>
  <verify>
1. Run `npm start`
2. In Graph view, navigate to a .planning file and press Ctrl+1 to save bookmark
3. Switch to Diagram view
4. Press 1 - diagram should pan to the phase containing that artifact and highlight it
  </verify>
  <done>
Bookmark shortcuts (1-9) work in diagram view, panning to the phase containing the bookmarked artifact and highlighting it with visual feedback.
  </done>
</task>

</tasks>

<verification>
1. Manual test: Click artifact in diagram -> switch to graph view -> node is highlighted
2. Manual test: Click node in graph view -> switch to diagram view -> artifact is highlighted
3. Manual test: Create bookmark in graph view with Ctrl+1 -> switch to diagram -> press 1 -> diagram pans to phase
4. Manual test: Selection persists across multiple view switches
5. Run `npm run lint` - no new errors
6. Run `npm test` - no regressions
</verification>

<success_criteria>
- INTR-04: Diagram selection syncs to graph (verified by switch + highlight)
- INTR-05: Graph selection syncs to diagram (verified by switch + highlight)
- INTR-06: Bookmark shortcuts work in diagram view
- Selection state persists in state.selectedNode
- No circular update loops (selection change doesn't trigger infinite updates)
- Smooth pan animation when using bookmarks
</success_criteria>

<output>
After completion, create `.planning/phases/33-interactivity/33-02-SUMMARY.md`
</output>

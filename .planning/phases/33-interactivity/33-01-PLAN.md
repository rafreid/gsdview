---
phase: 33-interactivity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/diagram-renderer.js
  - src/renderer/index.html
autonomous: true

must_haves:
  truths:
    - "User clicks artifact block in diagram and file inspector modal opens"
    - "User hovers over artifact and sees tooltip with file metadata"
    - "User clicks stage header and artifact detail expands/collapses smoothly"
  artifacts:
    - path: "src/renderer/diagram-renderer.js"
      provides: "Click handlers for artifacts and stage headers, hover tooltip"
      contains: "openFileInspector"
    - path: "src/renderer/index.html"
      provides: "Tooltip element for diagram view"
      contains: "diagram-tooltip"
  key_links:
    - from: "src/renderer/diagram-renderer.js"
      to: "openFileInspector()"
      via: "D3 click handler on artifact blocks"
      pattern: "\\.on\\('click'.*openFileInspector"
    - from: "src/renderer/diagram-renderer.js"
      to: "#diagram-tooltip"
      via: "D3 mouseover handler"
      pattern: "diagram-tooltip.*classList"
---

<objective>
Add core diagram interactions: artifact click opens file inspector, hover shows tooltip, stage headers toggle expand/collapse.

Purpose: Enable users to inspect and interact with artifacts directly in the diagram view without switching to graph view.
Output: Interactive diagram where clicking artifacts opens the existing file inspector modal, hovering shows metadata, and clicking stage headers toggles detail visibility.
</objective>

<execution_context>
@/home/rafreid/.claude/get-shit-done/workflows/execute-plan.md
@/home/rafreid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@src/renderer/diagram-renderer.js
@src/renderer/graph-renderer.js (reference openFileInspector pattern, lines 4444-4530)
@src/renderer/gsd-pipeline-parser.js (artifact.path structure)
@src/renderer/index.html (existing tooltip and modal elements)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tooltip element and artifact click handlers</name>
  <files>src/renderer/index.html, src/renderer/diagram-renderer.js</files>
  <action>
1. In index.html, add a diagram-specific tooltip element after the existing #tooltip:
   ```html
   <div id="diagram-tooltip" class="hidden"></div>
   ```

2. In index.html, add CSS for #diagram-tooltip (position absolute, dark bg, padding, rounded corners, z-index 1000, pointer-events none, max-width 300px). Style similar to existing #tooltip but scoped to diagram.

3. In diagram-renderer.js, import openFileInspector from graph-renderer.js:
   ```javascript
   import { openFileInspector } from './graph-renderer.js';
   ```

4. In renderArtifacts(), add D3 click handler to artifact groups:
   ```javascript
   artifactGroups.on('click', (event, artifact) => {
     event.stopPropagation();
     // Build node object matching what openFileInspector expects
     const node = {
       id: 'planning:' + artifact.path.replace(/.*\.planning\//, ''),
       name: artifact.name,
       type: 'file',
       path: artifact.path.replace(/.*\.planning\//, ''),
       sourceType: 'planning'
     };
     openFileInspector(node);
   });
   ```

5. Add cursor:pointer to artifact groups via D3:
   ```javascript
   artifactGroups.style('cursor', 'pointer');
   ```
  </action>
  <verify>
Run `npm start`, switch to Diagram view, click an artifact block. File inspector modal should open showing file contents.
  </verify>
  <done>
Clicking any artifact in diagram opens file inspector modal with correct file contents displayed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hover tooltip with file metadata</name>
  <files>src/renderer/diagram-renderer.js</files>
  <action>
1. Add mouseover handler to artifact groups in renderArtifacts():
   ```javascript
   artifactGroups.on('mouseover', (event, artifact) => {
     const tooltip = document.getElementById('diagram-tooltip');
     if (!tooltip) return;

     // Get file stats
     const stats = fs.existsSync(artifact.path) ? fs.statSync(artifact.path) : null;

     const lines = [];
     lines.push(`<strong>${artifact.name}</strong>`);
     if (stats) {
       lines.push(`Size: ${formatFileSize(stats.size)}`);
       lines.push(`Modified: ${formatRelativeTime(stats.mtime)}`);
     }
     lines.push(`Status: ${artifact.status}`);

     tooltip.innerHTML = lines.join('<br>');
     tooltip.classList.remove('hidden');
     tooltip.classList.add('visible');
   });
   ```

2. Add mouseout handler to hide tooltip:
   ```javascript
   artifactGroups.on('mouseout', () => {
     const tooltip = document.getElementById('diagram-tooltip');
     if (tooltip) {
       tooltip.classList.remove('visible');
       tooltip.classList.add('hidden');
     }
   });
   ```

3. Add mousemove handler on SVG to position tooltip (similar to graph-renderer pattern):
   ```javascript
   // In setupPanZoom() or separate function:
   svg.on('mousemove', (event) => {
     const tooltip = document.getElementById('diagram-tooltip');
     if (tooltip && tooltip.classList.contains('visible')) {
       tooltip.style.left = event.clientX + 15 + 'px';
       tooltip.style.top = event.clientY + 15 + 'px';
     }
   });
   ```

4. Add helper functions (or import from graph-renderer if exported):
   - formatFileSize(bytes) - converts bytes to KB/MB/GB
   - formatRelativeTime(date) - "Just now", "5 min ago", etc.

   These exist in graph-renderer.js (lines 3600-3620, 5032-5050). Either export them or duplicate locally for diagram use.
  </action>
  <verify>
Run `npm start`, switch to Diagram view, hover over any artifact block. Tooltip should appear near cursor showing filename, size, modified date, and status.
  </verify>
  <done>
Hovering over artifacts shows tooltip with name, file size, modification time, and completion status.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add stage header expand/collapse toggle</name>
  <files>src/renderer/diagram-renderer.js</files>
  <action>
1. Add state tracking for collapsed stages at module level:
   ```javascript
   const collapsedStages = new Set();
   ```

2. In renderStages(), add click handler to stage header area (first rect after the group creation):
   ```javascript
   // Add clickable header area (the header rect)
   stageGroups.select('rect:nth-of-type(2)') // The header rect
     .style('cursor', 'pointer')
     .on('click', (event, d) => {
       event.stopPropagation();
       toggleStageCollapse(d.stage.id);
     });
   ```

3. Add collapse indicator to stage header (chevron icon):
   ```javascript
   stageGroups.append('text')
     .attr('class', 'collapse-indicator')
     .attr('x', d => d.width - 20)
     .attr('y', STAGE_HEADER_HEIGHT / 2)
     .attr('text-anchor', 'middle')
     .attr('dominant-baseline', 'middle')
     .attr('fill', 'white')
     .attr('font-size', '14px')
     .text(d => collapsedStages.has(d.stage.id) ? '+' : '-');
   ```

4. Create toggleStageCollapse function:
   ```javascript
   function toggleStageCollapse(stageId) {
     if (collapsedStages.has(stageId)) {
       collapsedStages.delete(stageId);
     } else {
       collapsedStages.add(stageId);
     }

     // Re-render to reflect collapsed state
     // Find stage group and update artifact visibility
     diagramGroup.selectAll('.stage').each(function(d) {
       if (d.stage.id === stageId) {
         const group = d3.select(this);
         const artifacts = group.selectAll('.artifact');
         const moreText = group.select('text:last-of-type');

         if (collapsedStages.has(stageId)) {
           artifacts.style('opacity', 0).style('pointer-events', 'none');
           moreText.style('opacity', 0);
         } else {
           artifacts.style('opacity', 1).style('pointer-events', 'auto');
           moreText.style('opacity', 1);
         }

         // Update indicator
         group.select('.collapse-indicator').text(collapsedStages.has(stageId) ? '+' : '-');
       }
     });
   }
   ```

5. In renderArtifacts(), check collapsed state before rendering:
   ```javascript
   // At start of renderArtifacts():
   stageGroups.each(function(d) {
     if (collapsedStages.has(d.stage.id)) {
       // Don't render artifacts for collapsed stages, or hide immediately
       d3.select(this).selectAll('.artifact')
         .style('opacity', 0)
         .style('pointer-events', 'none');
     }
   });
   ```
  </action>
  <verify>
Run `npm start`, switch to Diagram view, click a stage header. Artifacts should hide/show with smooth toggle. Click again to reverse.
  </verify>
  <done>
Stage headers are clickable with collapse indicator (+/-). Clicking toggles artifact visibility smoothly. Collapsed state persists during session.
  </done>
</task>

</tasks>

<verification>
1. Manual test: Click artifact -> modal opens with correct file
2. Manual test: Hover artifact -> tooltip shows metadata (name, size, modified, status)
3. Manual test: Click stage header -> artifacts collapse/expand
4. Manual test: Modal close (X or Escape) works correctly from diagram view
5. Run `npm run lint` - no new errors
</verification>

<success_criteria>
- INTR-01: Artifact click opens file inspector modal
- INTR-02: Hover shows tooltip with file metadata
- INTR-03: Stage header click expands/collapses artifacts
- No console errors during interactions
- Tooltip follows cursor position
- Modal displays correct file contents
</success_criteria>

<output>
After completion, create `.planning/phases/33-interactivity/33-01-SUMMARY.md`
</output>

---
phase: 07-expanded-file-scope
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/parsers/directory-parser.js
  - src/main/main.js
autonomous: true

must_haves:
  truths:
    - "parseDirectory accepts multiple directory configs with path, sourceType, and ignorePatterns"
    - "Returned nodes have sourceType property indicating 'planning' or 'src'"
    - "node_modules, .git, dist, and build directories are ignored by default"
    - "Project root is the parent of both .planning/ and src/ directories"
  artifacts:
    - path: "src/main/parsers/directory-parser.js"
      provides: "Multi-directory parsing with source markers"
      exports: ["parseDirectories", "parseDirectory", "flattenTree"]
    - path: "src/main/main.js"
      provides: "Updated parse-project handler calling parseDirectories"
      contains: "parseDirectories"
  key_links:
    - from: "src/main/main.js"
      to: "src/main/parsers/directory-parser.js"
      via: "require parseDirectories"
      pattern: "parseDirectories"
---

<objective>
Extend directory parsing to handle both .planning/ and src/ directories

Purpose: Enable the graph to visualize multiple directory trees with distinct source markers
Output: Updated directory-parser.js with multi-directory support and sourceType markers on all nodes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-expanded-file-scope/07-CONTEXT.md

# Key source files
@src/main/parsers/directory-parser.js
@src/main/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parseDirectories function with source markers</name>
  <files>src/main/parsers/directory-parser.js</files>
  <action>
Create a new `parseDirectories(configs)` function that:

1. Accepts array of directory configs:
   ```javascript
   [
     { path: '/path/to/.planning', sourceType: 'planning', ignorePatterns: [] },
     { path: '/path/to/src', sourceType: 'src', ignorePatterns: ['node_modules', '.git', 'dist', 'build'] }
   ]
   ```

2. Creates a virtual project root node:
   - id: 'dir-root'
   - name: project folder name (extract from path)
   - type: 'directory'
   - sourceType: 'root'

3. For each config, call existing parseDirectory logic but:
   - Add `sourceType` property to every node (file and directory)
   - Prefix node IDs to avoid collisions: `planning-dir-xxx` vs `src-dir-xxx`
   - Only process if directory exists (skip gracefully if src/ missing)

4. Default ignore patterns for src/:
   - node_modules, .git, dist, build, coverage, .next, .cache, __pycache__

5. Combine all trees under project root and return unified structure:
   ```javascript
   {
     tree: { id: 'dir-root', children: [planningTree, srcTree] },
     files: [...allFiles],
     nodes: [...allNodes],
     links: [...allLinks]
   }
   ```

Keep existing `parseDirectory()` function working for backward compatibility (it can call new logic internally).
  </action>
  <verify>
Run app with `npm start`, open a project - should still work (regression test).
Console should show no errors during parsing.
  </verify>
  <done>
parseDirectories function exists and returns unified tree with sourceType on all nodes.
Existing parseDirectory still works for single-directory calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update parse-project IPC handler for multi-directory</name>
  <files>src/main/main.js</files>
  <action>
Update the `parse-project` IPC handler (around line 140) to:

1. Import parseDirectories from directory-parser.js

2. Build directory configs array:
   ```javascript
   const directoryConfigs = [
     {
       path: path.join(projectPath, '.planning'),
       sourceType: 'planning',
       ignorePatterns: []
     },
     {
       path: path.join(projectPath, 'src'),
       sourceType: 'src',
       ignorePatterns: ['node_modules', '.git', 'dist', 'build', 'coverage', '.next', '.cache']
     }
   ];
   ```

3. Replace the parseDirectory call with parseDirectories:
   ```javascript
   const directory = parseDirectories(directoryConfigs, projectPath);
   ```

4. Pass projectPath to parseDirectories so it can derive the root node name

The returned data structure should remain compatible with existing buildGraphFromProject() in renderer.js (nodes/links/tree format).
  </action>
  <verify>
Run `npm start`, open a project that has both .planning/ and src/ directories.
Open DevTools console - check parseProject logs show nodes from both directories.
  </verify>
  <done>
parse-project handler uses parseDirectories and returns combined tree.
Projects with src/ show src files in the data (visible in console).
Projects without src/ still work (no errors).
  </done>
</task>

<task type="auto">
  <name>Task 3: Update flattenTree for sourceType preservation</name>
  <files>src/main/parsers/directory-parser.js</files>
  <action>
Update the `flattenTree()` function to:

1. Preserve the `sourceType` property when creating flat node arrays:
   ```javascript
   nodes.push({
     id: node.id,
     name: node.name,
     type: node.type,
     path: node.path,
     extension: node.extension || null,
     sourceType: node.sourceType || null  // ADD THIS
   });
   ```

2. Ensure links reference the correct prefixed IDs (planning-dir-xxx, src-dir-xxx)

This is critical for the renderer to know which visual style to apply to each node.
  </action>
  <verify>
Console.log the flattened nodes - each should have sourceType: 'planning', 'src', or 'root'.
No undefined sourceType values on directory/file nodes.
  </verify>
  <done>
flattenTree preserves sourceType on all nodes.
Renderer receives sourceType for visual differentiation (Phase 7 Plan 03).
  </done>
</task>

</tasks>

<verification>
1. Run `npm start` and open a project with both .planning/ and src/ directories
2. Open DevTools console and check logged project data
3. Verify nodes array contains entries with sourceType: 'planning' and sourceType: 'src'
4. Verify the tree structure has project root with both directories as children
5. Verify ignored patterns work (no node_modules nodes in src/ tree)
6. Open a project with only .planning/ (no src/) - should work without errors
</verification>

<success_criteria>
- parseDirectories function returns unified tree with both directories
- All nodes have sourceType property ('planning', 'src', or 'root')
- Default ignore patterns prevent node_modules and build artifacts from appearing
- Backward compatibility maintained - existing projects still load
- Projects missing src/ directory load without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-expanded-file-scope/07-01-SUMMARY.md`
</output>

---
phase: 07-expanded-file-scope
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/main/main.js
  - src/renderer/renderer.js
autonomous: true

must_haves:
  truths:
    - "File watcher monitors both .planning/ and src/ directories"
    - "File change events include sourceType to identify which directory changed"
    - "findNodeIdFromPath correctly resolves nodes in either directory"
    - "Changes in src/ trigger graph flash and refresh just like .planning/ changes"
  artifacts:
    - path: "src/main/main.js"
      provides: "Dual-directory file watcher"
      contains: "chokidar.watch"
    - path: "src/renderer/renderer.js"
      provides: "Updated findNodeIdFromPath for both directories"
      contains: "findNodeIdFromPath"
  key_links:
    - from: "src/main/main.js"
      to: "src/renderer/renderer.js"
      via: "files-changed IPC event"
      pattern: "files-changed"
---

<objective>
Extend file watcher to monitor both .planning/ and src/ directories

Purpose: Enable real-time updates when files change in either directory
Output: Updated file watcher and path resolution to handle both directory trees
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-expanded-file-scope/07-CONTEXT.md
@.planning/phases/07-expanded-file-scope/07-01-SUMMARY.md

# Key source files
@src/main/main.js
@src/renderer/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend startWatching to monitor both directories</name>
  <files>src/main/main.js</files>
  <action>
Update the `startWatching(projectPath)` function (around line 57) to:

1. Watch both directories:
   ```javascript
   const planningPath = path.join(projectPath, '.planning');
   const srcPath = path.join(projectPath, 'src');

   // Build array of paths to watch (only existing directories)
   const watchPaths = [];
   if (fs.existsSync(planningPath)) watchPaths.push(planningPath);
   if (fs.existsSync(srcPath)) watchPaths.push(srcPath);
   ```

2. Configure chokidar with ignore patterns for src/:
   ```javascript
   watcher = chokidar.watch(watchPaths, {
     ignoreInitial: true,
     persistent: true,
     depth: 10,
     ignored: [
       '**/node_modules/**',
       '**/.git/**',
       '**/dist/**',
       '**/build/**',
       '**/coverage/**',
       '**/.next/**',
       '**/.cache/**',
       '**/__pycache__/**'
     ]
   });
   ```

3. Include sourceType in the file change event:
   ```javascript
   watcher.on('all', (event, filePath) => {
     // Determine sourceType from path
     let sourceType = 'unknown';
     if (filePath.includes('/.planning/') || filePath.includes('\\.planning\\')) {
       sourceType = 'planning';
     } else if (filePath.includes('/src/') || filePath.includes('\\src\\')) {
       sourceType = 'src';
     }

     // ... existing debounce logic ...
     mainWindow.webContents.send('files-changed', {
       event,
       path: filePath,
       sourceType  // ADD THIS
     });
   });
   ```

4. Handle case where neither directory exists gracefully.
  </action>
  <verify>
Run app, open project, edit a file in .planning/ - should trigger change event.
Edit a file in src/ - should also trigger change event.
Check DevTools console shows sourceType in the logged change data.
  </verify>
  <done>
File watcher monitors both .planning/ and src/ directories.
Change events include sourceType property.
Ignored patterns prevent node_modules changes from triggering updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update findNodeIdFromPath for both directories</name>
  <files>src/renderer/renderer.js</files>
  <action>
Update the `findNodeIdFromPath(changedPath)` function (around line 97) to handle both directories:

```javascript
function findNodeIdFromPath(changedPath) {
  // changedPath is absolute: /path/to/project/.planning/some/file.md
  //                     or: /path/to/project/src/components/App.js
  // node.path is relative: some/file.md (relative to .planning/ or src/)
  // node.id is prefixed: planning-file-xxx or src-file-xxx

  // Check for .planning/ path
  const planningIndex = changedPath.indexOf('.planning/');
  if (planningIndex !== -1) {
    const relativePath = changedPath.substring(planningIndex + '.planning/'.length);
    console.log('[Flash] Looking for planning node with path:', relativePath);

    // Look for node with matching path and planning sourceType
    const node = currentGraphData.nodes.find(n =>
      n.path === relativePath && n.sourceType === 'planning'
    );
    if (node) {
      console.log('[Flash] Found planning node:', node.id);
      return node.id;
    }
  }

  // Check for src/ path
  const srcIndex = changedPath.indexOf('/src/');
  if (srcIndex !== -1) {
    const relativePath = changedPath.substring(srcIndex + '/src/'.length);
    console.log('[Flash] Looking for src node with path:', relativePath);

    // Look for node with matching path and src sourceType
    const node = currentGraphData.nodes.find(n =>
      n.path === relativePath && n.sourceType === 'src'
    );
    if (node) {
      console.log('[Flash] Found src node:', node.id);
      return node.id;
    }
  }

  console.log('[Flash] No node found for path:', changedPath);
  return null;
}
```

Note: Also handle Windows path separators (backslash) if not already handled.
  </action>
  <verify>
Edit a file in .planning/ - graph node should flash.
Edit a file in src/ - corresponding graph node should flash.
Check console logs show correct node lookup.
  </verify>
  <done>
findNodeIdFromPath resolves paths from both .planning/ and src/ directories.
File changes in either directory trigger the correct node flash animation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify flash animations work for both directories</name>
  <files>src/renderer/renderer.js</files>
  <action>
Verify and update if needed the file change listener (around line 1092) to work with sourceType:

```javascript
if (window.electronAPI && window.electronAPI.onFilesChanged) {
  window.electronAPI.onFilesChanged((data) => {
    console.log('Files changed:', data.event, data.path, 'sourceType:', data.sourceType);
    if (selectedProjectPath) {
      // Flash the changed file node if it exists in the graph
      if (data.path) {
        const nodeId = findNodeIdFromPath(data.path);
        if (nodeId) {
          flashNode(nodeId);
          flashTreeItem(nodeId);
        }
      }

      showRefreshIndicator();
      loadProject(selectedProjectPath);
    }
  });
}
```

The existing code should work, but add sourceType to the console log for debugging.
Ensure both flashNode and flashTreeItem are called for src/ files too.
  </action>
  <verify>
1. Run app, open project with both directories
2. Edit a .planning/ markdown file - node should flash yellow/white
3. Edit a src/ JavaScript file - node should flash yellow/white
4. Both should trigger tree panel flash if visible
5. Both should trigger graph refresh
  </verify>
  <done>
Flash animations work for files in both .planning/ and src/ directories.
Tree panel items flash in sync with graph nodes for both directories.
  </done>
</task>

</tasks>

<verification>
1. Run `npm start` and open a project with both .planning/ and src/ directories
2. Edit a file in .planning/ - verify:
   - Console shows sourceType: 'planning'
   - Graph node flashes
   - Tree item flashes
   - Graph refreshes with updated data
3. Edit a file in src/ - verify same behavior with sourceType: 'src'
4. Verify node_modules changes are ignored (create/delete a file in node_modules)
5. Open project with only .planning/ - verify no errors, watching still works
</verification>

<success_criteria>
- File watcher monitors both .planning/ and src/ directories simultaneously
- Change events include sourceType property for directory identification
- findNodeIdFromPath correctly resolves nodes in either directory tree
- Flash animations trigger for both .planning/ and src/ file changes
- Ignored patterns prevent noise from node_modules, .git, dist, etc.
- Projects with only .planning/ (no src/) work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-expanded-file-scope/07-02-SUMMARY.md`
</output>
